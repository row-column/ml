计算机 工程 
 COMPUTER   ENGINEERING 
 1999 年   第 25 卷   第 12 期   vol.25   No.12   1999 
 
 
 
 使用 协议 分析 排除 登录 Win   NT 故障 
 李德 鹏 　 王应龙 　 李德 胜 
 　 　 Windows   NT 是 最近 几年 由 微软公司 推出 的 网络操作系统 ， 一如 微软公司 的 PC 操作系统 平台 ， 由于 Windows   NT 注重 用户 化 ， 易使用 ， 易 维护 ， 因此 深受 用户 青睐 。 Windows   NT 迅速 抢占 网络操作系统 市场份额 ， 成为 网络管理 人员 的 首选 平台 。 作为 最好 的 应用服务器 ， Windows   NT 支持 众多 的 数据库 产品 、 图形化 界面 、 直观 、 易学 、 容易 配置 ， 它 众多 灵巧 的 管理工具 成为 网络管理 人员 不可 缺少 的 好帮手 。 另外 ， 每个 运行 程序 独自 占有 内存空间 ， 在 一个 运行 程序 出现 故障 的 情况 下 ， 不会 造成 服务器 死机 ， 大大提高 了 服务器 的 无故障 运转 时间 。 当前 用户 的 组网 模型 一般 采用 Win   95 ( 98 ) 作为 工作站 端 操作系统 ， Windows   NT 作为 服务器端 操作系统 。 工作站 通过 登录 域控制器 共享 网络资源 。 本文 简单 介绍 客户端 登录 服务器 的 操作过程 。 希望 对 网络软件 设计 人员 进行 软件设计 、 网络管理 人员 进行 网络 维护 的 过程 中 有所 帮助 。 
 1   Windows   95 登录 Windows   NT 服务器 过程 
 　 　 Windows   NT 采用 工作组 或者 域 的 方式 管理 网络资源 。 域 是 计算机 和 用户 的 逻辑 组 。 在域 中 ， 所有 计算机 访问 存储 安全 和 用户 帐号 信息 的 中心 数据库 由 作为 域控制器 的 NT 服务器进行 管理 。 当 一个 用户 登录 一个 域时 ， 域控制器 通过 检查 域 的 目录 数据库 所 存储 的 用户名 、 口令 、 登录 限制 来 确定 登录 是否 有效 。 具体地说 ， 当 一个 用户 登录 域时 ， 要 完成 以下 步骤 ， 图 1 为 演示 图 ： 
 
 图 1   用户 登录 演示 图 
 　 　 ①   客户端程序 Win   Logon 请求 客户 输入 用户名 和 口令 ， 然后 该 程序 将 得到 的 数据 发送给 安全 子系统 的 LSA ( Local   Security   Authority ) ； 
 　 　 ②   安全 子系统 将 请求 发送给 客户端 的 Net   Logon 服务 ； 
 　 　 ③   客户 的   Net   Logon 服务 将 请求 发送给 域控制器 的 NetLogon 服务 ； 
 　 　 ④   域控制器 的 Net   Logon 服务 发送 请求 给 域控制器 的 SAM ( Security   Accounts   Manager ) ； 
 　 　 ⑤   SAM 检索 域 服务器 中 中心 目录 数据库 ， 寻找 匹配 的 用户名 、 口令 ； 
 　 　 ⑥   域控制器 的 SAM 服务 把 结果 传输 给 域控制器 的 Net   Logon 服务 ； 
 　 　 ⑦   域控制器 的 Net   Logon 服务 将 结果 传给 客户端 的 Net   Logon   服务 ； 
 　 　 ⑧   客户 的 Net   Logon 服务 将 把 结果 传给 客户 的 LSA ； 
 　 　 ⑨   如果 传回 的 结果 有效 ， 客户 的 LSA 建立 一个 访问 令牌 ， 包含 赋予 的 权限 ， 把 令牌 传给 客户 的 Win   Logon 处理 ； 
 　 　 ⑩   Win   Logon 为 用户 请求 一个 新 的 处理 ， 并且 为 新 处理 附加 访问 令牌 。 
 　 　 由 以上 过程 可知 ， 步骤 ① 、 ② 、 ⑧ 、 ⑨ 、 ⑩ 是 发生 在 工作站 的 内部 ， 而 步骤 ④ 、 ⑤ 、 ⑥ 是 发生 在 服务器端 的 内部 ， 仅 有 ③ 、 ⑦ 发生 在 工作站 、 服务器之间 的 网络 传输 中 。 
 2   Windows   95 登录 Windows   NT 过程 中 协议 消息   互相 传送 过程 
 　 　 上面 讲述 的 步骤 ③ 、 步骤 ⑦ 仅仅 是 大致 的 原理 实现 ， 具体 工作站 和 服务器之间 如何 互相 识别 、 如何 建立联系 的 过程 要 比 上面 所说 的 复杂 的 多 。 
 2.1   CIFS 客户 登录 CIFS 服务器 的 3 个 逻辑 步骤 
 　 　 Win   95 登录 Win   NT 的 过程 就是 CIFS   client 登录 CIFS   server 、 通过 安全检查 的 过程 。 CIFS 客户 登录 包含 3 个 逻辑 步骤 ： 
 　 　 ( 1 )   域控制器 的 发现 
 　 　 域控制器 的 发现 是 CIFS 客户 寻找 域控制器 的 过程 。 通过 使用 MailSlot 和 NetBIOS 命名 来 完成 这一 功能 。 MailSlot 提供 快速 、 不 可靠 、 非 双向 的 数据传输 机制 。 一旦 某 过程 获得 对 MailSlot 的 控制 ， 就 可以 像 写 文件 一样 写 MailSlot ， 使用 CIFS   Transact   SMB 将 数据 放在 数据 区中 发送 数据包 。 在 寻找 主 域控制器 时 ， 客户 发送 包含 NETlogon _ QUERY 帧 的 MailSlot 信息 ， 然后 等待 响应 。 如果 超过 延迟时间 仍然 没有 得到 响应 数据包 ， 请求 信息 将 再次 发送 ， 延迟时间 调整 为 正常 延迟 的 两倍 ， 再 超时 ， 延迟时间 再 加倍 。 如果 多次重 传 之后 没有 收到 响应 ， 那主 域控制器 的 名称 将 被 认为 不可 到达 。 并且 在 过 一段时间 之后 重新 发送 ， 一般 是 一分钟 的 时间 ， 每次 超时 后 ， 延迟 等待时间 将 加倍 。 如果 收到 响应 ， 主 域控制器 的 名称 将 保存 下来 以备 将来 使用 。 
 　 　 NetLogon _ Query 结构 定义 如下 ： 
 　 　 struct   NetLogon _ Query {   
 　 　 　 unsigned 　 char   Opcode ; / * 表示 该 结构 是 一个 NetLogon _   
 　 　 　 　 　 　 　 　 Query   ， 数值 为 7 * / 
 　 　 　 char   ComputerName ; / * 发送 请求 的 计算机 ASCII 名称 * / 
 　 　 　 char   MailslotName ; / * 响应 信息 发给 的 MailSlot   ASCII 名称 * / 
 　 　 　 unsigned   short   Lm20Token ;   / * 为 0XFFFF * / 
 　 　 　 }   ; 
 　 　 struct   NetLogon _ Response 
 　 　 {   
 　 　 　 　 unsigned   char   Opcode ; / * 表示 该 结构 是 响应 数据包 ， 一 
 　 　 　 　 　 　 　 　 　 般 是 0X12 * /   
 　 　 　 　 char   PrimaryDCName [ 16 ] ;   / * 如果 通过 权限 审查 ， 返回 
 　 　 　 　 　 　 主 域控制器 的 ASCII 名称 * /   unsigned   short   Lm20Token ;   / * 为 0XFFFF   * /   
 　 　 } 
 　 　 ; 应当 特别 提出 注意 的 是 ， 查找 主 域控制器 的 过程 占用 很大 的 网络带宽 ， 存储 响应 信息 所 提供 的 主 域控制器 名称 可以 缓解 资源 的 紧缺 。 原因 在于 在 搜索 主 域控制器 之前 ， 可以 用 NetServeEnum2   API 进行 检查 ， 确保 是否 已经 有 存储 的 PDC 名称 存在 。 
 　 　 ( 2 )   会话 设置 
 　 　 CIFS 客户 向 刚刚 发现 的 主域 控制器发送 Seaaion - SetupAndX   SMB 请求 ， 然后 接受 符合 CIFS 规范 的 响应 。 SeaaionSetupAndX   SMB 响应 指出 主 域控制器 对 请求 的 认可 或 不 认可 ， 但是 可以 以 GUEST 方式 登录 。 之后 就 可以 执行 磋商 SMB 数据包 往返 发送 了 。 
 　 　 ( 3 )   远程 API 执行 
 　 　 本文 不 涉及 远程 API 执行 的 细节 。 
 2.2   CIFS 客户机 登录 CIFS 服务器 的 协议 具体 收发 过程 
 　 　 CIFS 服务器 在 用户 登录 的 过程 中 ， 要 检查 是否 允许 用户 登录 ， 在 某 时间段 是否 允许 某 用户 登录 ， 在 CIFS 客户 登录 的 参数 中 ， 预留 口令 字 段 ， 客户机 将 口令 填充 入该 字 段 。 CIFS 服务器 检查 用户名 、 口令 是否 与 帐号 数据库 中 的 值 相符 。 如果 没有 设置 口令 ， 该字段 内容 被 置 为 NULL ， 但是 CIFS 服务器 将 检查 SMB 中 的 用户名 、 机器 名 ， 是否 符合 检查 要求 。 具体 的 CIFS 客户机 登录 服务器 的 协议 收发 过程 如下 ： 
 　 　 .   CIFS 客户 向 CIFS 服务器发送 磋商 SMB ； 
 　 　 .   CIFS 服务器 检查 高速缓存 的 域控制器 名称 ； *   如果 没有 发现 有效 的 域控制器 名称 ， 则 做 一个 域控制器 发现 ； 
 　 　 .   CIFS 服务器发送 磋商   SMB   给 域控制器 ； 
 　 　 .   磋商 响应 和 挑战 保存 在 CIFS 服务器 中 ； 
 　 　 .   CIFS 服务器 使用 保存 的 挑战 发送 磋商 响应 给 客户 ； 
 　 　 .   CIFS 客户 按照 CIFS 规范 的 详细 要求 写出 挑战 响应 , 并且 挑战 响应 作为   SessionSetupAndX   SMB 的 一部分 发送 ； 
 　 　 .   CIFS 服务器 由 上述 SMB 中 精选 出 挑战 响应 ； 
 　 　 .   CIFS 服务器 使用 精选 的 挑战 响应 发送 自己 的   SessionSetupAndX   SMB 给 域控制器 ； 
 　 　 .   域 控制器发送   SessionSetupAndX 响应 给 CIFS 服务器 。 如果 CIFS 客户 提供 正确 的 响应 ， 则 响应 是 正常 的 ； 
 　 　 .   CIFS 服务器 断开 同 域控制器 之间 的 连接 ， 则 通过 一个   LogOffAndX   SMB 完成 ； 
 　 　 .   CIFS 服务器发送   SessionSetupAndX 响应 给 CIFS 客户 。 这个 域控制器 响应 。 
 　 　 掌握 以上 协议 收发 过程 ， 可以 更加 了解 客户机 登录 服务器 的 过程 。 
 3   分析 客户 无法 登录 的 问题 
 　 　 某台 Win95 工作站 始终 无法 登录 Win   NT 服务器 。 采用 多种 替换法 都 没有 解决问题 。 使用 了 该 协议 分析 ， 参照 CIFS 登录 方法 ， 发现 由于 网卡 驱动程序 的 原因 ， 使 客户机 无法 成功 发送 SMB 处理 包 ， 导致 客户机 无法 登录 服务器 。 
 　 　 在 工作站 登录 服务器时 ， 如果 出现 性能 低下 ， 速度 奇慢 ， 也 可以 采用 该 方法 研究 。 究竟 是 工作站 没有 发出 正确 的 请求 包 ， 还是 服务器 在 接到 请求 数据包 后 很 长时间 才 作出反应 ， 还是 数据 在 网络 传输 过程 中 速度慢 ， 造成 整个 网络 的 瓶颈 ； 通过 定位 网络 问题 发生 在 哪个 环节 ， 就 可以 很快 地 定位 网络故障 的 原因 了 。 
 作者 单位 ： 李德 鹏 　 王应龙 　 山东省 计算机网络 重点 实验室 ， 济南 250014 
 　 　 　 　 　 李德 胜 　 工商银行 济南 分行 科技处 ， 济南 250014 
 参考文献 
 1   Microsoft .   Supporting   Microsoft   Windows   NT   4.0   Core   Technologies .   北京 ： 机械 工业 出版社 ， 1997 
 2   Tanenbawm   A   S .   Computer   Networks ( 3rd   Ed ) . 北京 ： 清华大学   出版社 ， 1996 
 3   Naik   D   C ， Leach   P   J . Microsoft .   CIFS   Domain   Logon   and   Pass   Through   Autentication .   Internet   Draft ， 1997 - 01 
