计算机 应用 研究 
 APPLICATION   RESEARCH   OF   COMPUTERS 
 2000   Vol.17   No.3   P.71 - 72 , 86 
 
 
 
 
 无人 值班 变电站 监视系统 的 开发 
 莫宁 　 俞宁 
 摘 　 要 ： 介绍 了 一个 在 Windows   98 环境 下 运行 的 变电站 监视系统 ， 对 局域网 上 视频 数据 的 传输 、 客户 / 服务器 通信 模式 、 多线程 技术 等 进行 了 讨论 。 
 关键词 ： 视频   线程   客户 / 服务器 模式 
 1 　 前言 
 　 　 随着 电力系统 自动化 程度 的 提高 ， 无人 值班 变电站 也 逐渐 建立 起来 。 为了 及时 了解 变电站 现场 的 情况 ， 需要 一套 视频 监视系统 ， 能够 为 中心站 值班人员 提供 变电站 现场 图象 ， 并 对 关键部位 进行 报警 检查 。 当 变电站 出现 紧急情况 时 ， 能够 得到 及时 地 处理 ， 避免 和 减少 事故 带来 的 损失 ， 同时 把 来自 变电站 现场 的 报警 信息 存储 到 数据库 中 ， 以备 事后 查询 。 下面 简要地 介绍 该 系统 开发 过程 中 的 几项 关键技术 。 
 2 　 变电站 监视系统 的 组成 
 　 　 变电站 监视系统 由 现场 站 部分 和 中心站 部分 组成 。 其中 中心站 由 一台 多媒体计算机 构成 ， 现场 站 的 构成 较为 复杂 ， 其 硬件 组成 如图 1 所示 。 
 
 图 1 　 变电站 现场 站 硬件 结构 
 　 　 视频 捕捉 卡 负责 捕捉 来自 摄像机 的 现场 图象 ， 画面 分割器 主要 用于 多台 摄像机 的 画面 切换 和 画面 组合 ， 控制卡 发出 控制 信号 完成 控制 台上 、 下 、 左 、 右 转动 和 摄像机 聚焦 、 变焦 、 光圈 操作 的 任务 ， 报警 箱 检查 各个 报警 传感器 的 状态 ， 形成 报警 状态字 送给 主机 。 
 　 　 变电站 监视 系统软件 运行 环境 为 中文 Windows   95 / 98 。 软件开发 采用 Borland 公司 的 Delphi   4.0 编程 工具 。 根据 系统 任务 ， 系统软件 划分 为 三个 主要 模块 ： 视频 图象 传输 模块 、 实时 报警 模块 和 数据 维护 管理 模块 。 视频 图象 传输 模块 实现 现场 图象 捕捉 、 压缩 、 传输 、 解压 、 显示 等 。 实时 报警 模块 实现 现场 报警 信息 获取 、 传输 、 报警 、 提示 、 报警 信息 存储 等 。 数据 维护 管理 模块 负责 维护 各 摄像机 、 报警 点 信息 以及 报警 信息管理 等 任务 。 
 3 　 数据 维护 管理 模块 
 　 　 该 模块 包括 以下 几个 子 模块 ： 
 　 　 1 ) 摄像机 信息 数据库 管理 子 模块 ： 完成 摄像机 信息 的 添加 、 删除 、 修改 等 。 
 　 　 2 ) 报警 点 信息 数据库 管理 子 模块 ： 完成 报警 点 信息 的 添加 、 删除 、 修改 等 。 
 　 　 3 ) 报警 信息 数据库 管理 子 模块 ： 完成 报警 信息 的 浏览 、 编辑 、 查询 、 分类 统计 、 分类 打印 等 。 
 　 　 由于 每台 摄像机 可以 监视 若干个 报警 点 ， 因此 摄像机 与 报警 点 之间 是 一对 多 的 关系 其表 结构 如表 1 、 表 2 所示 ( * 表示 主 关键字 ) 。 
 表 1   摄像机 信息 表 
 
 摄像机 ID ( CID ) * 摄像机 名称 ( name ) 其它 信息 字 段 
 01 摄像机 名称 ( name ) ... 
 0210kV 高压 室 ... 
 0310kV 电容 室 ... 
 ......... 
 
 表 2   报警 点 信息 表 
 
 报警 点 ID ( WID ) * 报警 点 名称 ( name ) 其它 信息 字段 CID 
 01 控制柜 1 ... 01 
 02 控制柜 2 ... 01 
 03 高压 瓶 1 ... 02 
 ............ 
 
 　 　 其中 报警 点 信息 表中 CID 字段 表示 此 报警 点 所 关联 的 摄像机 ID ， 具有 相同 CID 的 报警 点 构成 了 一个 防区 。 当 防区 内 任一 报警 点 报警 时 ， 即 认为 此 防区 报警 ， 此时 应立即 切换 到 该 防区 内 的 摄像机 ， 显示 此 防区 现场 图象 。   
 4 　 视频 图象 传输 模块 
 　 　 现场 变电站 主机 把 通过 视频 捕捉 卡 获取 的 视频 数据 经过 压缩 后 通过 计算机网络 传送 给 中心站 播放 。 
 4.1 　 图象 捕捉 与 压缩 
 　 　 由于 图象 信息量 相当 大 ， 例如 一幅 CIF 标准 352 ( 298 的 24 位 真彩色 图象 ， 其 数据量 为 304 , 128 字节 ， 如 每秒 捕捉 10 帧 ， 则 数据量 为 3 , 041 , 280 字节 / 秒 。 如此 大 的 数据量 若 不 进行 压缩 ， 很难 实现 图象 的 准 动态 传输 。 由于 视频 监视系统 不 要求 连续 视频 播放 ， 因此 我们 采用 台湾 FlyView 视频 捕捉 卡 ， 它 可以 获得 现场 摄像机 的 实时 动态 画面 ， 并 采用 JPEG 压缩 技术 ， 压缩 品质 设为 75 ～ 80 ， 图象 质量 令人满意 。 
 4.2 　 视频 图象 传输 软件设计 
 　 　 我们 选用 Delphi   4.0 作为 开发工具 ， 它 提供 了 两个 Internet 组件 TNMSTRM 和 TNMSTRSERV ， 可以 以流 的 形式 方便 地 实现 像 视频 数据流 这样 大量 数据 的 传输 。 视频 图象 传输 软件 分为 现场 站 软件 和 中心站 软件 两 部分 ， 均 设计 成 Windows 多线程 方式 运行 。 现场 站 软件 包括 两个 线程 ： 一个 线程 用于 图象 捕捉 和 压缩 ， 另 一个 线程 以流 的 方式 实现 视频 数据 的 传输 。 对 中心站 软件 来说 ， 一个 线程 用于 接收 视频 数据流 ， 另 一个 线程 用于 解压 、 显示 图象 。 在 实际 软件设计 时应 解决 好 线程 通信 、 同步 问题 ， 实现 图象 连续 捕捉 、 压缩 、 传送 和 回放 。 
 　 　 在 现场 站 软件 中 ， 实现 视频流 传送 线程 由 实现 图象 捕捉 压缩 的 线程 启动 ( Resume ) ， 图象 数据 传送 完成 后应 主动 挂 起 ( Suspend ) 。 实际 数据传输 由 以下 代码 完成 ： 
 ... 
 / / 经过 压缩 的 JPEG 图象 数据 保存 在 流 ImageStream 中 
 NMStrm . PostIt   ( ImageStream ) ;   
 　 　 　 　 　 　 　 　 　 / / NMStrm 为 TNMSTRM 组件 对象 实例 
 ... 
 　 　 与 现场 软件 相似 ， 中心站 软件 中 完成 图象 解压 、 显示 线程 在 收到 一幅 完整 JPEG 图象 数据 后 启动 ( Resume ) ， 完成 图象 显示 后 主动 挂 起 ( Suspend ) 。 实际 数据 接收 由 以下 代码 完成 ： 
 ... 
 / / 当有 数据 到达 中心站 时 ， 将 激发 TNMSTRMSERV 组件 的 OnMsg 事件 
 procedure   TForml . NMStrmServMSG   ( Sender :   TComponent :   const   
 　 　 　 　 　 　 　 sFrom :   String :   strm :   TStream ) ; 
 begin 
 　 ImageStream . LoadFromStream ( strm ) ;   
 　 / / 将 图象 数据 保存 到 ImageStream 流中 传递 给 图象 显示 线程 
 DisplayThread . Resume ;   / / 启动 显示 图象 线程 
 ... 
 end ; 
 5 　 实时 报警 模块 
 　 　 变电站 现场 各个 传感器 的 状态 由 报警 箱 检查 并 形成 报警 状态字 送给 现场 主机 ， 现场 主机 对 报警 状态字 进行 处理 后 ， 形成 报警 信息 传送 给 中心站 主机 。 现场 站 与 中心站 采用 客户 / 服务器 模式 通信 。 中心站 作为 服务器 处于 监听 状态 ， 现场 站 作为 客户 ， 一旦 出现 报警 ， 现场 站 即 向 中心站 提出 连接 请求 ， 并 传送 报警 信息 。 
 5.1 　 报警 信息 的 形成 
 　 　 报警 箱 根据 各个 报警 传感器 的 状态 形成 32 位 的 报警 状态字 ， 每 一位 对应 一个 报警 传感器 的 状态 ， 0 表示 没有 报警 ， 1 表示 有 报警 。 现场 站 主机 定时 读取 报警 箱 的 报警 状态字 。 如果 某个 或 若干个 报警 点 处于 报警 状态 ， 查询数据库 获取 所有 报警 点 的 标识 WID ( 两 字节 ) 。 为了 避免 当 同一 报警 传感器 发生 抖动 ( 如 烟雾 传感器 ) 在 较 短 的 时间 内 产生 多次 报警 ， 应 判断 同一 报警 点 两次 相邻 报警 的 时间 间隔 ， 如果 此 间隔 小于 设定 的 时间 间隔 ， 即 认为 是 同 一次 报警 ， 此 报警 被 忽略 ， 否则 认为 是 一次 新 的 报警 。 另外 为了 防止 误 报警 ， 报警 数据 有 必要 增加 校验位 。 可以 采取 XMODEM 校验 方法 ， 即取 所有 报警 数据 字符 二进制 值 和 除以 256 后 的 余数 ， 作为 校验 字节 。 最后 形成 的 报警 信息格式 如下 ： 
 
 5.2 　 现场 站 与 中心站 通信 过程 
 　 　 为 协调 现场 站 与 中心站 的 通信 ， 定义 了 以下 的 通信 控制符 ： 
 Const 
 　 ACK = $ 01   / / 确认 
 　 NAK = $ 09   / / 不 确认 
 　 　 具体 的 通信 过程 如图 2 所示 。 
 
 图 2 　 报警 通信 过程 
 　 　 ( 1 ) 现场 站 主机 向 中心站 主机 提出 连接 请求 。 ( 2 ) 中心站 主机 响应 连接 ， 完成 连接 。 ( 3 ) 现场 站 主机 送 报警 信息 到 中心站 主机 。 ( 4 ) 中心站 对 收到 的 报警 信息 进行 XMODEM 校验 ， 若 校验 正确 向 现场 站 主机 发送 确认 ACK 控制符 ， 否则 发送 不 确认 NAK 控制符 。 ( 5 ) 如果 现场 站 主机 接收 到 ACK 控制符 ， 则 标志 本次 报警 信息 传送 成功 ， 主动 断开 与 中心站 主机 的 连接 。 否则 延时 1 秒 重发 报警 信息 ， 直到 收到 中心站 送回 的 ACK 控制符 为止 。 
 5.3 　 报警 信息处理 
 　 　 中心站 主机 收到 报警 信息 后 ， 根据 报警 点 标识 WID 查询数据库 ， 获得 报警 点 的 名称 、 位置 、 具体 报警 内容 等 信息 ， 并且 通过 声音 、 文字 等 形式 提醒 中心站 值班人员 。 另外 现场 站 主机 在 收到 ACK 控制符 后 ， 控制 画面 分割器 将 画面 切换 到 报警 点 所在 防区 中 的 摄像机 ， 这样 中心站 值班人员 就 可以 通过 声音 、 文字 、 图象 准确 详细 地 了解 变电站 现场 的 情况 ， 从而 作出 及时 的 处理 。 
 6 　 结束语 
 　 　 在 本 系统 开发 过程 中 ， 由于 采用 了 多线程 的 方法 ， 为了 保证 线程 之间 能 协调 运行 ， 需 采取 一定 的 机制 使 各个 线程 同步 ， 如 信号灯 、 互斥 量 、 临界 区 等 。 在 实际 的 应用 系统 运行 中 可能 会 出现 一些 异常现象 ， 如 通信 数据 丢失 、 通信 异常中断 、 操作过程 不当 等等 。 这些 情况 在 开发 、 调试 时 不 容易 发现 ， 但 实际 运行 中 却 会 发生 。 所以 在 应用 系统 开发 中 ， 需要 对 这些 情况 进行 考虑 ， 采取相应 的 措施 ， 如 错误 陷阱 等 技术 ， 及时 捕获 异常 并 进行 处理 ， 以 保证系统 在 实际 应用 中 能 稳定 运行 。 
 　 　 上面 介绍 的 无人 值班 变电站 监视系统 已经 开发 完成 ， 并 投入 了 实际 运行 。 从 实际 的 运行 效果 来看 ， 系统 采用 的 开发方法 是 切实可行 的 。 由于 本 系统 涉及 到 图象处理 、 数据通讯 、 数据库 等 多方面 的 技术 ， 希望 能 对 从事 这方面 工作 的 技术人员 有所 帮助 。 
 莫宁 ( 武汉 水利电力 大学   武汉   430072 ) 
 俞宁 ( 武汉 水利电力 大学   武汉   430072 ) 
 参考文献 
 1   Charlie   Calvert 著 ,   潇湘 工作室 译 .   Delphi   4 编程技术 内幕 .   北京 ： 机械 工业 出版社 ,   1999.6 
 2   Todd   Miller   &   David   Powell 著 ,   林君 工作室 译 .   Delphi   3   开发 使用手册 .   北京 ： 机械 工业 出版社 ,   1998.5 
 3   Delphi   Online   Document 
 收稿 日期 ： 1999 年 10 月 25 日 
