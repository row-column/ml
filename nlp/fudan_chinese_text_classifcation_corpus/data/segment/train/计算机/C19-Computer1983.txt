微型机 与 应用 
 MICROCOMPUTER   &   ITS   APPLICATIONS 
 1999 年   第 18 卷   第 2 期   Vol.18   No.2   1999 
 
 
 
 医院 门诊 收费 数据仓库 系统 的 分布 并行 结构 设计方案 
 郭云飞 　 孟志青 
 　 　 摘 　 要 ： 以 数据仓库 ( Data   Warehouse ) 技术 思想 为 核心 ， 论述 了 在 现有 的 普通 数据库 管理系统 的 基础 上 开发 分布 并行 式 医院 门诊 收费 数据仓库 系统 的 结构设计 ， 为 在 低 资源 环境 下 开发 高效率 数据库 管理系统 提供 了 一套 有效 的 方法 。 
 　 　 关键词 ： 数据仓库 　 分布 并行 　 数据库 
 
 1 　 系统分析 
 1.1 　 问题 的 提出 
 　 　 医院 门诊 收费 系统 是 医院 管理 的 一项 重要 工作 。 目前 我国 许多 大中小型 医院 门诊 收费 基本上 都 实现 了 计算机管理 ， 主要 软件系统 一般 是 基于 数据库 管理系统 开发 的 单机 系统 或 微机 网络系统 。 这 两种 门诊 系统 都 是 采用 以 集中式 数据 存储 为 基础 的 数据库 联机 事务处理 系统 。 为了 对 医院 门诊 药房 的 药品 进出 进行 有效 的 控制 ， 需 将 医生 所开 处方 全部 录入 计算机 。 但是 许多 大 医院 每天 门诊量 很大 ， 平均 每张 处方 的 记录 量 为 5 个 左右 ， 这样 每天 少则 几千条 ， 多则 几万 条 记录 存于 磁盘 ， 1 个 月 下来 有 几十万 条 记录 。 许多 系统 为了 提高 处理 的 效率 ， 每个 月 备份 上个月 的 数据 ， 并 将 上个月 的 数据 从 系统 中 删除 。 
 　 　 近年来 ， 医院 管理 也 进入 市场化 ， 医院 对 药品 的 需求 和 管理 ， 以及 经营 状况 的 预测 都 变得 十分必要 ， 尽管 许多 医院 实现 了 计算机 收费 与 药品 管理 ， 但 大多数 系统 在 开发 时均 未 考虑 大规模 数据处理 的 问题 。 因此 无法回答 下面 的 问题 ： 
 　 　 在 过去 一年 中 ， 某种 药品 在 全年 12 个 月 的 使用 情况 是 什么 ? 
 　 　 在 过去 的 几年 中 ， 哪些 药品 使用 得 最 频繁 或 最少 ? 
 　 　 某个 医生 在 过去 的 几年 中 ， 使用量 最多 的 药品 是 什么 ? 
 1.2 　 设计 思想 
 　 　 为了 解决 上述 问题 ， 提高 数据 的 处理 能力 和 数据 安全性 ， 使 管理系统 高速 可靠 地 运行 ， 对系统 内 复杂 的 数据 进行 有效 管理 ， 以 满足 多功能 系统对 数据 提出 的 准确 、 可靠 、 正确 、 快速 以及 使用方便 的 要求 ， 我们 采用 了 数据仓库 ( Data   Warehouse ) 技术 的 开放式 体系结构 ， 在 现有 的 普通 数据库 管理系统 的 基础 上 开发 分布 并行 式 数据仓库 门诊 收费 管理系统 。 从 广义 上 讲 ， 所谓 数据仓库 就是 1 个 专门 的 数据 仓储 ， 用来 保存 多个 数据库 或 其它 信息源 中 选取 的 已有 数据 ， 并 为 上层 应用 提供 统一 的 用户 接口 ， 用以 完成 数据 的 查询 和 分析 。 数据仓库 系统 可 分为 3 大部分 ： 即 数据源 、 后 端 加工 、 前端 服务 。 数据源 提供 原始数据 ； 后 端 加工 实施 数据 后台 处理 ( 包括 接收 、 储存 、 析取 、 汇总 等 ) ； 前端 服务 面向 最终用户 。 因此 ， 数据仓库 可 作为 解决 上述 问题 的 1 个 合理 方案 。 
 1.3 　 解决方案 
 　 　 我们 结合 数据仓库 技术 和 客户 / 服务器 技术 来 建立 1 个 统一 的 、 开放式 的 数据仓库 。 对 医院 门诊 收费 中 数据量 最大 的 处方 数据 ， 按大 颗粒 存放 在 4 台 并行 工作站 上 ， 例如 按 科室 存放 ； 对 其它 数据库 ， 由于 数据量 相对 小得多 ， 则 存放 在 网络 服务器 硬盘 上 ； 采用 若干 台 工作站 作 分布式 用户 ， 在 这些 工作站 上 完成 客户端 的 功能 ， 而 在 网络 服务器 和 并行 工作站 上 实现 服务器 功能 ； 将 并行 工作站 上 的 处方 数据库 设计 为 只读 数据库 ， 只有 在 工作站 上 已 确定 的 数据 才 传 至此 数据库 ， 不 允许 在 并行 工作站 上 修改 数据 。 这样 既 降低 风险 ， 又 简化 管理 的 复杂性 ， 且 符合 提高效率 和 充分利用 硬件资源 的 原则 。 由于 将 数据仓库 设计 为 只读 数据库 ， 无需 设立 锁 ， 更 无需 管理 锁 ， 能 大大简化 数据库 的 并发 控制 ， 改善 数据 的 可用性 和 数据 的 安全性 。 且 因为 数据库 分为 4 部分 存放 ， 查询 或 统计 可 同时 进行 ， 从而 提高 了 速度 ， 并且 在 故障 的 恢复能力 上 得到 了 质 的 飞跃 ， 数据 的 存储 能力 也 大为改观 。 由于 数据仓库 与 联机 事务处理 类 的 系统 分开 ， 网络 服务器 的 负荷 大大减少 ， 不再 成为 系统 的 瓶颈 。 因此 管理系统 的 整体 性能 得到 改观 ， 能 满足用户 的 要求 和 分布 管理 数据 发展 的 需要 。 
 2 　 系统 总体设计 
 2.1 　 硬件 配置 
 　 　 由于 价格 等 原因 ， 要 采用 专用 并行机 和 专门 的 分布 并行 数据库系统 来 开发 应用 系统 几乎 不 可能 ， 而 目前 微机 价格低 且 性能 高 ， 而且 支持 客户 / 服务器 体系结构 的 软件 已 纷纷 出台 ， 所以 利用 微机 网络 和 现有 的 普通 数据库 管理系统 实现 分布 并行 已 成为 可能 。 我们 利用 1 台 586 微机 作为 专用 服务器 ， 4 台 586 微机 工作站 作 专用 并行机 ， 若干 台 586 工作站 或 局域网 作 分布式 用户 ， 系统结构 如图 1 。 
 
 图 1     系统结构 
 2.2 　 系统 划分 
 　 　 分布式 并行 数据库系统 的 目标 是 以 最小 的 代价 、 最 有效 的 方式 来 最大 程度 地 满足用户 的 需求 。 大致 有 如下 4 个 重要 标准 ： 局部性 的 处理 功能 达到 最大 ， 有利于 负载 的 分布 ， 满足 分布 数据 的 可用性 和 可靠性 要求 ， 有 足够 的 可用 存储器 容量 。 为 实现 上述 目标 ， 整个 系统 共 划分 为 3 个 子系统 ： 收费 事务 联机系统 、 用户 数据 联机 分析 系统 和 并行 管理系统 。 
 　 　 1 . 收费 事务 联机系统 ： 这 是 为 收费 部门 ( 处方 录入 ) 设计 的 1 个 功能 完备 的 子系统 ， 系统 放置 于 本地 工作站 或 服务器 ， 存放 有 收费 所 需 的 全部 数据 。 系统 按照 多用户 环境 要求 设计 ， 其 工作 方式 有 2 种 ： 一种 是 完成 原始数据 的 装入 、 修改 、 处理 等 工作 ； 另 一种 是 将 装配 有 整套 系统 的 某台 微机 ( 一般 为 指定 工作站 ) 做 为 整个 分布 并行 系统 的 1 个 远程 用户 联 入主 系统 ， 每月 向 并行 工作站 系统 传送 1 次 有关 的 处方 数据 ， 并 对 服务器 主 数据库 与 并行 工作站 数据库 相关 数据 进行 一致性 与 完备 性 检验 。 　 　 
 　 　 2 . 用户 数据 联机 分析 系统 ： 这 是 为 医院 管理 部门 设计 的 多用户 并行 式 系统 ， 系统 装在 服务器 上 ， 各 工作站 通过 服务器 和 并行机 的 数据 进行 工作 。 它 的 主要 功能 是 对 处方 的 历史数据 进行 统计 、 查询 、 预测 等 。 
 　 　 3 . 并行 管理系统 ： 这 是 为 上面 2 个 系统 实现 并行 化 服务 的 1 个 子系统 ， 系统 程序 放置 在 工作站 或 服务器 中 ， 主要 数据库 是 处方 库 ( 放在 并行 工作站 内 ) ， 系统启动 后 不断 地 访问 服务器 里 的 并行 进程 库 ， 一旦 取得 指令 后 立即 工作 ， 工作 完成 后 又 到 服务器 中取 另 一条 指令 进行 下 一步 工作 。 其 主要 功能 是 实现 处方 记录 的 接收 、 查询 和 统计 等 工作 ， 将 用户 需要 的 数据 进行 加工 传递 给 服务器 ， 然后 用户 系统 到 服务器 上 读取 或 重新 加工 。 　 　 
 2.3 　 分布 并行 数据库 设计 
 　 　 并行 数据库 的 实现 方法 是 将 数据 存放 在 不同 的 存储器 内以 实现 并行 管理 ， 为此 本 系统 数据库 存储 按 局部 共享 和 无 共享 混合结构 ， 主要 划分 为 4 类 数据库 ： 收费 工作站 数据库 、 服务器 主 数据库 、 并行 工作 数据库 和 并行 工作站 数据库 。 
 　 　 1 . 收费 工作站 数据库 ： 是 收费 事务 联机系统 的 全部 数据库 ， 如 医生 库 、 药品 库 、 处方 库 等 ， 存放 在 本地 工作站 ， 系统对 这些 数据库 实现 增 、 改 、 删等 操作 ， 并 向 服务器 主 数据库 和 并行 工作站 数据库 传递数据 ， 每月 或 每周 的 处方 数据 向 并行 工作站 数据库 传送 1 次 。 
 　 　 2 . 服务器 主 数据库 ： 用户 数据 联机 分析 系统 中除 处方 库外 的 全部 数据库 ， 如 医生 库 、 药品 库 等 ， 均 存放 在 主 服务器 内 ， 这些 库 也 是 共享 库 ， 一般 变化 很少 。 
 　 　 3 . 并行 工作 数据库 ： 这些 库是 为 实现 系统 分布 并行 管理 设计 的 ， 全部 放在 服务器 硬盘 内 ， 有 并行 进程 管理 库 、 并行 处方 工作 库 、 查询 工作 库 等 ， 这些 库内 的 数据 为 临时 交换 使用 ， 一旦 用过 立即 清除 。 
 　 　 4 . 并行 工作站 数据库 ： 由于 处方 库 处理 的 记录 量 特别 大 ， 为了 实现 数据库 并行 管理 ， 减少 并行 工作站 之间 的 数据 传递 ， 将 数据库 按大 粒度 存放 ， 如 按 药品 大 类别 存放 ， 每个 并行 工作站 仅 存放 数个 库 并 由 并行 管理系统 管理 。 全部 数据库 格式 因 篇幅 所 限 省略 。 
 2.4 　 并行 工作 设计 
 　 　 采用 模块 成 对 设计 原理 ， 利用 并行 进程 管理 库 和 其它 工作 库 实现 1 个 功能 的 运行 ， 即 1 个 模块 分 2 块 制作 ， 一块 为 用户 或 收费 联机系统 的 前端 ( 功能 ) 模块 ， 一块 为 并行 管理系统 的 后 端 ( 功能 ) 模块 ， 它们 之间 靠 数据 的 传递 联结 工作 。 首先 介绍 并行 进程 管理 库 BXJCK 的 结构 和 工作 机制 ， 它 放在 服务器 中 ， 结构 如表 1 所示 。   
 表 1 　 并行 进程 管理 库 结构 
 
 登记号 并行机 号 功能 名称 功能 号 工作站 号 标志 号 状态 说明 
 11000 接收 处方 数据 1122333 执行 完毕 
 20110 查 某类 药品 使用 数量 1043113 正在 执行 
 31111 统计 过去 一年 的 处方 1651001 执行 等待 
 
 
 　 　 说明 ： 
 　 　 登记号 — — 顺序号 ， 每一 功能 请求 得到 的 号 是 BXJCK 中 的 最大 登记号 加 1 ， 登记号 是 唯一 的 。 
 　 　 并行机 号 — — 并行 工作站 的 需求 状态 指示 字 ， 共有 4 位 ， 每 1 位 对应 1 个 并行机 ， 即 从 左 至 右 分别 对应 1 、 2 、 3 、 4 号 并行 工作站 ， 用 1 表示 该 并行 工作站 工作 ， 0 表示 不 执行 。 如值 是 0110 ， 表示 2 号 和 3 号 工作站 执行 这项 功能 。 
 　 　 功能 号 — — 是 并行 管理系统 调用 的 后 端 模块 的 编号 ， 如 1 号 表示 接收数据 ， 16 号 表示 统计 过去 一年 处方 的 总数 。 
 　 　 工作站 号 — — 是 发出请求 的 用户 工作站 的 编号 ， 每一 工作站 进入 系统 时 必须 给定 1 个 工作站 号 ， 以 确定 查询 后 的 数据 返回 给 哪 一个 用户 工作站 ， 这个 编号 是 唯一 的 。 
 　 　 标志 号 — — 系统对 该 功能 的 执行 状态 指示 字 ， 共有 4 位 ， 每 1 位 与 1 台 并行 工作站 对应 ， 0 表示 等待 ， 即 并行 管理系统 正在 执行 先 请求 的 功能 ； 1 表示 正在 执行 ， 即 并行 管理系统 正在 执行 这个 功能 ； 2 表示 已经 执行 完毕 ， 即 并行 管理系统 功能 已 执行 ； 3 表示 对应 的 并行机 不 执行 这个 功能 。 
 　 　 工作 机制 ： 由 工作站 前端 模块 向 BXJCK 发出请求 ， 检查 请求 功能 号 是否 存在 ， 如无则 增加 1 条空 记录 ， 并 将 得到 的 1 个 登记号 以及 并行机 号 、 功能 号 、 工作站 号 和 标志 号 0 写入 ， 同时 将 并行 数据 写入 有关 工作 库 ， 当 1 台 并行 工作站 完成 1 个 功能 后 ， 向 BXJCK 搜索 最先 登记 的 标志 号 为 0 的 记录 ， 后 端 模块 取 到 登记号 和 功能 号 后 ， 置 标志 号 为 1 ， 同时 从 工作 库取 数据 开始 执行 ， 并 将 完成 的 结果 送到 服务器 相应 的 工作 库中 ， 将 BXJCK 中该 记录 中 相应 的 并行机 标志 号 置 为 2 ， 工作站 前端 模块 从 BXJCK 中 取得 标志 号 后 ， 从 服务器 相应 的 工作 库中 取得 数据 ， 并 完成 最后 功能 ， 清除 服务器 相应 的 工作 库中 的 数据 ， 同时 将 BXJCK 中该 记录 删除 。 
 　 　 工作 准则 ： 
 　 　 ( 1 ) 1 个 前端 模块 1 次 只能 向 BXJCK 提出 1 个 调用 后 端 模块 的 请求 ； 
 　 　 ( 2 ) 同一个 用户 工作站 可 同时 有 多个 不同 应用 前端 模块 向 BXJCK 提出 调用 不同 后 端 模块 的 请求 ， 因此 用户 提出 请求 后 ， 若 不能 得到 立即 响应 ， 可转 到 其它 应用 前端 模块 ， 过 一段时间 再 过来 查看 是否 调用 完毕 ； 
 　 　 ( 3 ) 不同 用户 工作站 可以 同时 由 同一 应用 前端 模块 向 BXJCK 提出 同一 后 端 模块 调用 ； 
 　 　 ( 4 ) 标志 号 均 变为 2 时 表示 这一 功能 执行 完毕 ； 
 　 　 ( 5 ) 在 BXJCK 的 所有 记录 中 ， 1 个 并行 工作站 只 在 1 条 记录 中 对应 的 标志 号位 为 1 ， 因为 1 个 并行 工作站 1 次 只能 调用 1 个 功能 。 
 3 　 系统结构 设计 
 3.1 　 收费 事务 联机系统 结构设计 
 　 　 1 . 系统 说明 
 　 　 本 系统 是 分布 并行 式 医院 门诊 数据仓库 系统 的 三大 子系统 之一 ， 是 1 个 功能 完备 而 又 具有 相对 独立性 的 系统 。 如果 医院 已有 该 系统 ， 那么 只 需 增加 1 个 数据 传送 功能模块 ， 每月 或 每周 定期 向主 服务器 和 并行 工作站 传送 处方 数据 。 如 没有 该 系统 ， 可 作为 主 系统 的 一部分 统一 建立 。 该 系统 有 2 种 工作 方式 ， 一种 工作 方式 是 既 能 完成 收费 原始数据 的 装入 、 修改 ， 并 对 处方 等 相关 数据 依据 有关 规定 进行 处理 ， 又 能 按 不同 需求 完成 短期内 数据 的 查询 、 统计 以及 产生 与 之 有关 的 各种 辅助性 打印 报表 等 ； 另 一种 工作 方式 是 与 另外 2 套 系统 实现 无缝 联接 。 其 工作 方式 如图 2 。 将 装配 有 整套 系统 ( 含 全部 有效 数据 ) 的 某台 微机 ( 一般 为 指定 工作站 ) 作为 分布 并行 系统 的 1 个 远程 用户 联入 数据仓库 主 系统 ， 一方面 每月 或 每周 向 并行 工作站 系统 主 数据库 ( 处方 库 ) 传送 1 次 有关 的 处方 数据 以及 历史记录 ， 另一方面 可 向 并行 工作站 系统 发送 本地 查询 请求 。 有关 详细 说明 略 。   
 
 图 2     收费 事务 联机系统 工作 方式 
 　 　 2 . 系统 功能模块 
 　 　 系统 功能模块 图如图 3 所示 。 
 
 图 3     系统 功能模块 图 
 3.2 　 用户 数据 联机 分析 系统结构 设计 
 　 　 该 系统 主要 用来 作 数据 联机 分析 ， 主要 功能 是 对 处方 的 历史数据 进行 查询 、 统计 和 预测 等 工作 ， 由于 功能 繁多 ， 整个 功能 按 用户 浏览器 设计 ， 分析 结果 则 按 图形 和 数据 显示 ， 如图 4 所示 。 
 
 图 4     系统分析 结果显示 
 　 　 各 工作站 对 数据仓库 的 查询 和 统计 过程 如图 5 。 
 
 图 5     对 数据仓库 的 查询 统计 过程 
 3.3 　 并行 系统结构 设计 
 　 　 并行 管理系统 主要 是 完成 对 并行 工作站 的 管理 ， 它 大致 可 分为 接收数据 、 并行 查询 、 统计 预测 和 数据 维护 等 四个 功能 ， 它 相对 于 用户 数据 联机 分析 系统 来说 是 后 端 。 并行 系统结构 设计 如图 6 。 
 
 图 6     并行 系统结构 设计 
 4 　 结束语 
 　 　 数据仓库 应用 系统 的 开发 是 一项 非常复杂 的 技术 工作 ， 本文 为 建造 中小型 的 数据仓库 系统 提供 了 一套 模式 。 我们 已 用 本文 的 设计 思想 在 计算机网络 上 进行 了 学生 成绩 数据仓库 管理系统 的 实验 ， 为 建造 符合实际 需要 的 数 
 据 仓库 开辟 了 一条 有效途径 。 
 作者 单位 ： 湖南 湘潭 大学 计算机科学 系 ( 411105 ) 　 
 参考文献 
 1 　 黄璇 . 数据库 技术 的 发展 方向 . 计算机 工程 与 应用 . 1995 ， 31 ( 5 ) ： 1 
 2 　 杨利 ， 周兴铭 ， 郑若忠 . 并行 数据库系统 的 体系结构 . 计算机科学 ， 1994 ； 21 ( 4 ) ： 42 
 3 　 杨利 ， 周兴铭 ， 吴涛 . 并行 查询 中 的 进程 分配 与 调度 . 计算机科学 ， 1995 ； 22 ( 6 ) ： 26 
 4 　 郭宜斌 . 数据仓库 技术 的 基本概念 和 发展 现况 . PC 世界 ， 1996 ； ( 4 ) ： 26 
 5 　 于戈 ， 张斌 . 数据仓库 管理 中 的 若干 关键技术 . 计算机科学 ， 1997 ； ( 2 ) ： 31 
 6 　 唐 韶华 . 基于 C / S 结构 的 网络 分布式 数据库 应用 . 微型 计算机 ， 1996 ； 16 ( 2 ) ： 13 
 7 　 王晓蔚 ， 孙志 珲 . 基于 客户 / 服务器 的 CMIS 分布式 数据库系统 设计 . 微型 计算机 ， 1996 ； 16 ( 5 ) ： 13 
 ( 收稿 日期 ： 1998 - 09 - 10 ) 
