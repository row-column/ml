计算机 工程 
 COMPUTER   ENGINEERING   
 1999 年   第 25 卷   第 5 期   Vol.25   No.5   1999 
 
 
 
 以太网 的 分布式 优先级 实现 方式 
 蔡文军   巩超   张根度 
 摘要   首先 概要 评价 了 千兆 以太网 的 一些 优缺点 。 然后 提出 了 一种 将 优先级 控制 引入 以太网 的 设想 ， 这种 方法 可以 在 介质 共享 的 CSMA / CD 算法 中 引入 分布式 优先级 控制 ， 并 可以 减少 重 负荷 情况 下 的 冲突 率 。 最后 对 优先级 系统 和 本 方案 作 了 一个 分析 。 
 关键词   千兆 以太网   QOS 预约 表   预约 优先级   重构 冲突 
 Realization   of   Priority   in   Etherent   
 Cai   Wenjun   GongChao   Zhang   Gendu 
 （ Department   of   Computer   Science ， Fudan   University   Shanghai   200433 ） 
 [ Abstract ]   This   paper   briefly   discusses   some   atrongpoints   and   limitations   of   1000Base   Ethernet   vs   . ATM   first ， then   introduces   a   kind   of   priority   sontrol   method   into   CSMA / CD   which   can   also   reduce   the   xollision   frequency   in   heavy   network   burden . At     last   we   make   some   analyses   about   it   
 [ Key   words ]   1000Base   Ethernet ； Qos ； Reserve   table ； Priority   reserve ； Collision   of   reconstruct 
 　 　 近年来 ， 局域网 ( LAN ) 的 技术 市场 逐渐 从 群雄逐鹿 的 境地 转为 两强 相争 ， 新兴 的 千兆 以太网 和 ATM 在 LAN 主干网 上 的 激烈 竞争 ， 更是 成为 众人 瞩目 的 焦点 。 
 　 　 正在 成熟 中 的 ATM 具有 高速率 和 优异 的 服务质量 ( QoS ) ， 然而 ， 由于 与 传统 LAN ( 主要 是 以太网 ) 不 兼容 ， 从 现有 网络 向 ATM 升级 是 一项 艰难 而 昂贵 的 工作 。 ATM   Forum 为此 提出 了 LANE 、 Classical   IP   over   ATM 和 MPOA 等 技术 和 方法 来 实现 现有 LAN 向 ATM 的 平滑 升级 。 但是 ， 这些 技术 要么 繁琐 复杂 、 要么 尚 停留 在 探讨 框架 的 阶段 ， 还 没有 成为 现实 可行 的 解决方案 。 
 　 　 以太网 简单 、 经济实用 而 易于 掌握 ， 成功 与 普及 度令 其它 网络 技术 望尘莫及 。 交换 以太网 和 快速 以太网 的 出现 ， 满足 了 不断 增长 的 带宽 需求 ， 更以 其 与 传统 以太网 的 良好 兼容性 ， 成 了 当前 LAN 的 主导 技术 。 随着 越来越 多 的 桌面 以 100Mbps 的 速度 与 服务器 相连 ， 对 网络 主干 提出 了 更 高 的 速度 要求 ， 第三代 以太网 - - 千兆 以太网 的 适时 出现 ， 满足 了 这种 需求 ， 更以 其 平滑 廉价 的 升级 方式 ， 成为 ATM 进入 LAN 主干网 的 主要 竞争对手 。 
 　 　 但是 ， 与 ATM 相比 ， 千兆 以太网 有 一个 重大 的 缺陷 ， 那 就是 不能 提供 真正 意义 上 的 服务质量 QoS ， 不能 进行 流量 控制 ， 从而 不适 用于 对 时延 敏感 的 多媒体 应用 等 实时 业务 。 1980 年 颁布 的 IEEE802.3 标准 主要 针对 数据交换 ， 而 不 提供 服务质量 和 优先级 控制 。 千兆 以太网 继承 了 这 一 协议 ， 也 继承 了 这 一 缺点 。 网络 发展 到 现在 ， 要求 的 不仅仅 是 高速度 、 高带宽 ， 更 要求 能够 支持 多媒体 应用 ， 支持 网络 策略管理 ( Policy ) ， 为此 人们 提出 用 千兆 以太网 ＋ QoS 对策 软件 的 模式 来 引入 QoS 。 QoS 对策 软件 包括 IEEE 的 802.1 p 和 802.1 q ， IETF 的 实时 传输 协议 RTP ( Real   Time   Transport   Protocol ) 和 资源 预留 协议 RSVP ( Resource   Reservation   Protocol ) 以及 3Com 公司 提出 的 优先 访问控制 PACE ( Priority   Access   Control - Enabled ) 等 各项 新 技术 。 在 这个 模式 中 ， 由 千兆 以太网 提供 QoS 所 需 的 速度 与 带宽 ， 由 QoS 对策 软件 提供 优先级 区分 和 带宽 分配 方案 ， 从而 配合 完成 实时 业务 。 
 1   在 以太网 中 实现 优先级 控制 的 一个 方案 
 　 　 实现 QoS , 很 重要 的 一个 要求 是 能够 实现 优先级 控制 。 为此 ， 我们 提出 一种 方法 , 将 优先级 控制 引入 以太网 。 基本 思想 是 ： 为 每个 数据 帧 确定 一个 优先级 ， 高 优先级 的 帧 优先 获得 线路 ， 并 可 中断 低优先级 的 帧 ， 而 各 帧 通过 预约 以 减少 冲突 。 
 　 　 在 这 之前 ， 先 让 我们 来看 一下 100VG - AnyLAN 的 教训 ： 为了 实现 优先级 控制 ， 100VG - AnyLAN 将 存在 冲突 的 介质 共享 这一 以太网 的 核心思想 加以 改变 ， 提出 了 按 需 优先 访问 协议 DPAM ( Demand   Priority   Access   Method ) , 彻底改变 了 网络 的 访问 协议 。 虽然 它 保留 了 以太网 的 帧 格式 ， 但是 由于 缺乏 以太网 的 简单 性 和 向 后 兼容性 ， 从而 在 与 快速 以太网 的 竞争 中 败下阵来 。 因此 ， 要 引入 优先级 控制 ， 不能 改变 CSMA / CD 这一 核心 ， 只有 这样 ， 才能 将 其 平滑 地 引入 现有 的 以太网 技术 之中 。 
 　 　 为了 在 存在 冲突 的 介质 共享 环境 中 引入 优先级 控制 ， 必须 为 每个 帧 确定 一个 优先级 。 为此 ， 可以 在 每个 节点 发送 帧 时 ， 在 每个 帧 的 前面 贴 上 一个 优先级 位段 。 由于 优先级 位段 是 贴 在 帧 的 前面 ， 而 不是 插 在 帧 的 中间 ， 所以 无须 对 帧 的 格式 加以 改动 ， 节点 也 无须 知道 帧 的 内部 内容 。 参考 ATM 只有 5 种 服务 ， IPv6 也 只有 4 位 标识 优先级 ， 帧 头 的 优先级 位段 只 需 4 位 ( 即可 表达 16 个 优先级 ) 就 足够 了 。 由于 优先级 位段 只有 4 位 ， 即使 是 最 短 的 以太网 帧 ( 64 字节 ， 共 512 位 ) ， 所 花费 的 代价 也 只有 4 / ( 4 + 512 ) = 0.77% ， 对于 较长 的 帧 ， 代价 更 低 。 
 　 　 基本 思想 如下 。 
 　 　 每 一个 以太网 节点 内部 都 维持 一张 预约 表 。 表 的 长度 是 网内 节点 的 数目 ， 每 一个 表项 对应 一个 节点 ， 表项 内容 包括 逻辑 节点 号 、 是否 预约 和 预约 的 优先级 。 由 逻辑 节点 号 和 预约 优先级 共同 决定 发送 次序 ， 高 优先级 的 预约 先于 低优先级 的 预约 得到 满足 ， 同级 预约 中 逻辑 节点 号 低 的 先于 逻辑 节点 号 高 的 得到 满足 ， 未 进行 预约 的 帧 必须 等到 高 优先级 或 同级 预约 被 满足 后 才 有 资格 发送 。 每 一个 节点 都 必须 遵守 这张 预约 表 ， 但是 未 预约 的 高 优先级 帧 可以 中断 低优先级 帧 ， 优先 发送 ， 而 被 干扰 的 低优先级 帧 必须 多 等待 一个 帧 的 时间 才能 按 预约 表 发送 。 
 　 　 当 一个 节点 产生 一个 未经 预约 的 帧 时 ， 在 发送 它 前 ， 节点 先 聆听 线路 。 此时 线路 或者 正在 传送 高 优先级 帧 ( 状态 A ) ， 或者 正在 传送 低优先级 帧 ( 状态 B ) ， 或者 空闲 ( 状态 C ) 。 
 　 　 状态 A 时 ， 节点 必须 等待 ， 直到 高 优先级 帧 发送 完 ， 线路 空闲 ， 即 为 状态 C 。 
 　 　 状态 B 时 ， 节点 可以 发送 帧 以 产生 冲突 。 冲突 发生 后 ， 被 中断 的 低优先级 节点 意识 到 有 高 优先级 的 帧 要 插入 ， 就 礼貌 地 停止 发送 ， 等到 插队 者 发送 完毕 后 ， 再 重新 进行 发送 。 而 制造 冲突 的 节点 ， 在 等待 了 一小 段时间 ， 以 确认 低优先级 节点 已经 让出 位置 ， 线路 空闲 后 ， 就 可以 认为 自己 有 资格 发送 ， 转入 状态 D 。 
 　 　 状态 C 时 ， 节点 查找 预约 表 。 如果 有 高 优先级 或 同级 预约 ， 说明 线路 已经 被 预定 ， 则 必须 等待 ， 直到 这些 预约 都 被 满足 为止 。 若 还有 低优先级 预约 ， 则 可 发送 帧 ， 产生 冲突 ， 此时 转入 状态 B 。 若 预约 表已 空 ， 则 认为 线路 空闲 ， 转入 状态 D 。 
 　 　 状态 D 时 ， 节点 发送 ， 此时 发送 可能 成功 ， 也 可能 产生 冲突 ( 可能 是因为 多个 高 优先级 节点 同时 中断 一个 低优先级 帧 ， 也 可能 是因为 预约 表 空闲 而 导致 的 多 帧 同时 发送 ) 。 如果 发生冲突 ， 由于 此时 无法 确定 发生冲突 的 帧 的 数量 和 优先级 ， 所以 必须 进行 预约 表 的 重组 ， 以 决定 发送 次序 ， 这种 冲突 也 因此 可以 称为 重构 冲突 。 重构 预约 表 ( 也 就是 初始化 预约 表 ) 的 过程 如下 ： 将 冲突 后 的 以太网 传输 时间 划分 为 一个个 时间 片 ， 在 每个 时间 片里 ， 节点 根据 自己 的 逻辑 节点 号 顺序 依次 申明 自己 的 预约 和 所 要求 的 优先级 。 网上 的 所有 节点 聆听 这些 申明 ， 并 据此 更新 自己 的 预约 表 。 在 聆听 了 节点 数目 个 时间 片后 ， 预约 表 重构 完成 ， 节点 又 可以 根据 预约 表 有条不紊 地 发送 。 
 　 　 这个 算法 的 一个 改进 是 允许 每个 节点 在 发送 时 ， 在 发送 的 帧 末尾 进行 预约 ， 从而 减少 了 重构 冲突 的 数量 。 
 　 　 之所以 设定 逻辑 节点 号 ， 是 为了 保证 发送 的 公平性 。 当 一个 预约 被 满足 后 ， 发送 它 的 节点 自动 地 将 逻辑 节点 号 设为 最后 一个 ， 而 其它 节点 则 将 它们 的 逻辑 节点 号 自动 顺序 前移 一位 。 这样 ， 就 可以 防止 排 在 前面 的 节点 始终 拥有 较 高 的 发送 概率 ， 从而 影响 后面 节点 的 发送 公平性 。 由于 VLAN 概念 的 兴起 ， 在 将来 的 设计 中 ， 就 可以 把 逻辑 节点 号 的 初始值 设为 VLAN 号 ， 从而 无须再 考虑 逻辑 节点 号 的 初始 分配 。 
 　 　 对于 像 多媒体 应用 等 对 时延 敏感 的 业务 ， 可以 让 它们 申请 最高 优先级 预约 ， 以 防止 帧 的 传输 被 其它 的 节点 所 打断 。 更进一步 ， 如果 设定 预约 表中 最高 优先级 预约 所 允许 的 最大 数目 ( 只 需 在 预约 表作 小小的 限制 ， 将 多于 限制 的 最高 优先级 预约 设为 次 高 优先级 预约 ) ， 就 能够 保证 在 可 预期 的 时间 内 ， 节点 能够 再次 获得 所 需 的 空闲 带宽 ， 也 就 相当于 ， 将 带宽 分割 为 几个 多媒体 等 实时 应用 。 对于 优先级 较 低 的 业务 ， 为了 防止 无 限制 的 等待 ， 可以 根据 等待 的 时间 增长 而 逐渐 提高 优先级 ， 从而 保证 在 某个 有限 的 时间 内 ， 可以 最终 得到 服务 。 与 传统 的 CSMA / CD 所 隐含 的 无限 等待 相比 ， 这是 一个 明显 的 进步 。 
 2   对 优先级 系统 和 本 方案 的 性能 分析 
 　 　 由 上面 可以 看出 ， 采用 本 方法 的 以太网 ， 其 行为 可以 用 排队 论中 的 强占 优先 制 排队模型 进行 分析 。 此 模型 的 定义 是 ： " 顾客 分等级 ， 当 一个 具有 较高级 别 优先权 的 顾客 到达 系统 时 ， 若正 被 服务 的 顾客 是 一个 具有 较 低 级别 优先权 的 顾客 ， 则 低 等级 顾客 将 被 中断 服务 ， 重新 回到 队列 中 排队 等待 服务 ， 可以 用 记号 X / Y / Z / m / n / PPR 来 表达 〔 X 表示 顾客 相继 到达 系统 的 间隔时间 的 概率分布 ， Y 表示 服务 窗口 所 耗费 的 服务 时间 的 概率分布 ， Z 表示 服务 系统 内 服务 窗 的 个数 ， m 为 系统 最大 容量 ， n 为 顾客 最大 数目 ， PPR 表示 排队 规则 〕 。 " [ 3 ] 
 　 　 在 这里 ， 顾客 是 数据 帧 ， 服务 窗口 是 线路 ， 服务 窗口 的 服务 时间 是 数据 帧 占用 线路 的 时间 ， 服务 窗口 数量 为 一 〔 各 节点 共享 唯一 信道 〕 。 为了 方便 起 见 ， 假设 顾客 到达 的 概率分布 服从 泊松 分布 ， 服务 窗口 的 服务 时间 服从 负 指数分布 ， 系统 最大 容量 无限 ， 顾客 最大 数量 无限 。 此时 ， 上面 的 记号 可以 简化 为 M / M / 1 / ∞ / ∞ / PPR 。 为了 计算 各级 顾客 〔 数据 帧 〕 的 平均 排队 等待时间 Wqk 〔 k 表示 用户 的 等级 ， 1 级 高于 2 级 ， 2 级 高于 3 级 ， … … 〕 ， 可以 引入 以下 排队 论 的 公式 。 
 
 　 　 其中 ， Wsk   表示 第 k 级 顾客 在 系统 中 的 平均 逗留 时间 ， Ws , 1 - k 表示 只有 第 1 级 到 第 k 级 顾客 在 系统 中 时 顾客 的 平均 逗留 时间 ， λ i 表示 单位 时间 内 顾客 平均 到达 率 ， 1 / μ 表示 顾客 平均 被 服务 时间 。 
 　 　 在 以太网 中 ， 将 单位 时间 设定 为 帧 时间 。 此时 ， 顾客 的 平均 被 服务 时间 1 / μ ， 就是 数据 帧 占用 线路 的 平均 时间 ， 为 一个 帧 时间 ， 则 μ ＝ 1 。   各级 顾客 的 平均 到达 率 λ k 可以 折算 为 每 帧 时间 发送 帧 的 平均值 Gk 〔 这里 G ＝ ∑ ∞ k = 1Gk 是 网络 总 的 帧 平均 发送 率 〕 。 此时 ， 上面 的 公式 可以 写成 如下 公式 ： 
 　 　 
 　 　 为了 比较 优先级 系统 的 性能 改进 ， 我们 假设 一个 有 3 类 数据 帧 的 系统 ， 一类 数据 帧 ( 最高 优先级 ) 占 所有 帧 数量 的     10 ％ ， 二类 数据 帧 ( 次 高 优先级 ) 占 所有 帧 数量 的 20 ％ ， 剩下 的 都 是 三类 帧 。 表格 1 显示 了 G 从 0 到 1 区间 变化 时 ， 各类 数据 帧 和 不分 优先级 时 ( Wq ) 数据 帧 等待 发送 的 时间 。 
 表 1   顾客 （ 数据 帧 ） 等待时间 随 网络 发送 率 G 变动 情况 
 G0.10 . 20.30 . 40.50 . 60.70 . 80.91 . 0 
 Wq10.1111110 . 250.4285710 . 66666711.52 . 333333349 ∞ 
 Wq20.0101010 . 0204080.0309280 . 0416670.52630 . 063830.07526880 . 08695650.0989010 . 111111 
 Wq30.0413410 . 0855410.1328880 . 1837120.238390 . 2975530.36110 . 4302060.5053440 . 587302 
 Wq40.1454750 . 3297870.5698590 . 8939391.352942 . 048783.219415 . 5789512.6986 ∞ 
 
 　 　 从 上面 的 比较 表 可以 看出 ： 在 G 不断 增加 ， 网络 负荷 不断 增重 的 情况 下 ， 具有 高 优先级 的 顾客 ( 数据 帧 ) 仍然 能够 只 需 等待 较少 的 时间 ， 就 得到 服务 ； 而 在 没有 分 优先级 的 情况 下 ， 顾客 ( 数据 帧 ) 的 等待时间 将 随 指数 增长 ， 在 G 接近 1 时 系统 将 瘫痪 。 显然 ， 优先级 系统对 各种 实时 业务 具有 非常 重要 的 意义 。 
 　 　 采用 预约 表 ， 是 为了 降低 网络 的 冲突 率 。 与 传统 的 CSMA / CD 算法 相比 ， 它 能 实现 在 保证 低 负荷 情况 下 的 低 等待 的 同时 ， 实现 重 负荷 情况 下极 低 的 冲突 率 。 事实上 ， 负荷 越重 ， 有效 利用率 越高 。 在 重 负荷 情况 下 ， 数据 可以 通过 预约 表 实现 无 冲突 传输 。 由于 高 优先级 对 低优先级 的 中断 不 影响 预约 表 ， 所 增加 的 仅仅 是 一次 冲突 ， 而 不会 产生 连锁 冲突 。 只有 在 不明 优先级 帧 产生 重构 冲突 的 情况 下 ， 才 需 花费 重构 预约 表 的 代价 ， 而 这 一 代价 又 被 随后 的 按 预约 表无 冲突 访问 的 一组 帧 所 分摊 。 与 之 相比 ， 传统 的 CSMA / CD 在 重 负荷 的 情况 下 产生 众多 的 冲突 ， 从而 使 传输 几乎 停顿 。 
 　 　 这个 方法 的 另 一个 特点 是 采用 分布式 优先级 控制 ， 在 每个 节点 内 维护 一个 预约 表 ， 而 不是 采用 一个 中心 控制 节点 来 实施 优先级 控制 。 这 虽然 付出 了 一些 内存 上 的 代价 ， 却 继承 了 以太网 分布式 控制 的 的 思想 ， 增加 了 可靠性 、 健壮性 和 实现 上 的 简单 性 。 另外 ， 由于 一个 以太网 ( 或 VLAN ) 中 的 节点 数目 有限 ， 预约 表中 所 需 维护 的 数据量 又 少 得 可怜 ， 因此 并 不会 占用 太多 的 内存 。 
 3   结束语 
 　 　 当今 , 信息产业 迅猛发展 ， 对 网络 技术 提出 了 越来越 高 的 需求 ， 速度 与 服务质量 缺一不可 。 传统 的 网络 技术 已 力不从心 。 为了 平滑 升级 和 保留 现有 投资 ， 有 必要 在 发展 新 技术 的 同时 ， 对 现有 技术 进行 改造 。 在 这 一方面 还有 许多 工作 要 做 ， 我们 提出 的 方案 正是 为 将 优先级 引入 以太网 的 一个 尝试 。 希望 大家 能 对 这 一 方案 提出 宝贵 的 意见 ， 批评 和 指正 不足之处 。 
 作者简介 ： 蔡文军   男 ， 25 岁 ， 研究生 ， 主研 计算机网络 
 作者 单位 ： 复旦大学 计算机系   上海   200433 
 参考文献 
 1   Andrew   S . Tanenbaum ： Computer   Network . Prentice   Hall , PTR , 1996 
 2   高传善 , 张世永 , 曲海 等 . 计算机网络 . 上海 ： 复旦大学 出版社 , 1994 
 3   陆传 赉 . 排队 论 . 北京 ： 北京 邮电学院 出版社 ， 1994 
 收稿 日期 ： 1998 - 10 - 05 
