计算机 工程 
 COMPUTER   ENGINEERING 
 1999 年   第 25 卷   第 8 期   Vol.25   No.8   1999 
 
 
 
 带 身份 认证 和 加密 的 Internet 防火墙 系统 
 王月桥 ， 汪为 农 
 摘要 ： 介绍 了 有关 Internet 的 安全 问题 ， 并 设计 一个 带有 身份 认证 和 加密 的 防火墙 系统 的 体系结构 和 功能 结构 ； 此外 ， 还 介绍 了 包 过滤 路由器 的 配置 规则 。 
 关键词 ： 堡垒 主机 ； 包 过滤 ； 身份 认证 ； 拒绝服务 
 Internet   Firewall   System   with   Authenticatin   and   Encryption 
 Wang   Yueqiao , Wang   Weinong 
 ( Center   of   Networkamp ; Information , shanghai   Jiaotong   University , shanghai   200030 ) 
 【 Abstract 】 This   paper   introduces   the   current   of   netowrk   security , then   it   show , the   architecture , its   funtions   and   charateristics   of   a   firewall   system . And   it   discusses   the   rules   with   which   the   router   is   configured . 
 【 Key   words 】 Bastion   host ; Packet   filtering ; Authentication ; Denial   of   services 
 1   网络安全 现状   
 　 　 Internet   最初 由 大学 和 科研机构 使用 ， 渐渐 进入 社会 的 各个 行业 。 可以 说   Internet   已 与 人们 的 日常生活 紧密联系 起来 ， 而且 有 越来越 多 的 机密信息 利用   Internet   传送 ， 随之 产生 了 很多 与   Internet   有关 的 安全 问题 。 例如 ：   
 
 注 ：   R   代表 包 过滤 路由器   
 图   1   防火墙 结构图   
 　 　 ( 1 )   企业 安全意识 淡薄   
 　 　 所用 的 操作系统 存在 不 安全 因素 ， 对外开放 高风险 的 网络服务 ， 却 没有 设置 严密 的 安全 防范措施 ， 使 企业 的 许多 主机 暴露 在外 ， 从而 就 为 入侵者 敞开 了 方便之门 。   
 　 　 ( 2 )   黑客 增多   
 　 　 随着 网络 技术 的 普遍 使用 ， 网络 黑客 也 应运而生 ， 如今 黑客 遍布 世界 ， 其 入侵 手段 越来越 高明 。 在   Internet   上 可以 找到 很多 攻击 网络 和 系统 安全漏洞 的 小 程序 ， 黑客 使用 这些 小 程序 来 进行 网络攻击 ， 如   Crack   、   sniffer   、   SATATN   、   COPS   、   Tiger   等等 。 而且 有 许多 专门 的 黑客 站点 ， 提供 网络 入侵 的 技术 和 工具 ， 如   www . rootshell . com   、   www.10 oht . com   、   www.2600 . com   等 。   
 　 　 ( 3 )   内部 攻击 不容忽视   
 　 　 在 网络 黑客 中 ， 内部 攻击者 占 很大 的 比重 。 但 内部 攻击 经常 被 网络管理 人员 忽视 ， 因为 内部 攻击者 通常 了解 系统 很多 有用 信息 ， 从而 进攻 更 易 得手 ， 造成 的 危害 往往 也 更 大 。   
 2   防火墙 系统 的 体系结构 
 　 　 这个 防火墙 系统 由 两个 包 过滤 路由器 和 一个 堡垒 主机 构成 ， 认为 非常 安全 的 防火墙 系统 ， 因为 它 支持 应用层 和 网络层 的 安全 功能 。 把 代理服务器   ( WWW   、   Email   、   FTP )   、 身份 认证 系统 、 日志 系统 、 加密 系统 放在 堡垒 主机 中 。 堡垒 主机 位于 外部 网 和 内部网 之间 。   
 　 　 ( 1 )   包 过滤 路由器   是 防火墙 的 第一道 关卡 ， 其 对 进入 内部网 的 通信 进行 预先审查 。 包 过滤 路由器 利用 包 过滤 规则 转发 或 丢弃 数据包 。 过滤 规则 定义 为 ： 内部 网络 上 的 主机 可以 直接 访问 外部 网络 ， 而 外部 网络 上 的 主机 对 内部 网络 的 主机 的 访问 是 受限制 的 ， 并且 ， 要 阻塞 设置 源 路由 选项 的 数据包 和 假冒   DMZ   内 主机 地址 的 数据包 。   
 　 　 ( 2 )   DMZ   即 不 安全 网络 段 。 由于 包 过滤 路由器 允许 外部 网 与   DMZ   内 的 主机 进行 通信 使   DMZ   不 安全 ， 从 安全 的 角度 来看 ，   DMZ   应 属于   Internet   的 一部分 ， 尽管 它 在 内部网 的 管理控制 之下 。   
 　 　 ( 3 )   堡垒 主机   是 位于 内部网 和   DMZ   之间 的 网关 ， 内部网 和   DMZ   之间 的 所有 通信 必须 通过 堡垒 主机 。 堡垒 主机 运行 安全 ， 为   Internet   和 内部网 之间 的 信息 交换 提供 条件 。   
 　 　 ( 4 )   IF1   是 堡垒 主机 连接   DMZ   的 网卡 ， 为 这块 网卡 配置 的   IP   地址 与   DMZ   内 主机 的   IP   地址 具有 相同 的 子网掩码 ， 即 它们 处于 同一 子网 内 。   
 　 　 ( 5 )   IF2   即 堡垒 主机 连接 内部网 的 网卡 ， 为 这块 网卡 配置 的   IP   地址 与 内部网 主机 的   IP   地址 具有 相同 的 子网掩码 ， 即 它们 处于 同一 子网 内 。   
 3   包 过滤 路由器 
 　 　 包 过滤 路由器 对 接收 到 的 每个 数据包 进行 检查 ， 以 确定 允许 包 通过 、 还是 丢弃 该包 。 路由器 分析 每个 数据包 的 内容 ， 以 确定 是否 与 一条 包 过滤 规则 匹配 。 过滤 规则 基于 数据包 的 包头 信息 ， 包头 信息 包括   IP   源地址 、   IP   目标 地址 、 内 装 协议 、   ( TCP   、   UDP   、   ICMP   、   IP   Tunnel )   、   TCP / UDP   目标 端口 、   ICMP   消息 类型 、 包 出入 接口 。 如果 有 规则 匹配 并且 允许 该 数据包 通过 ， 那么 该 数据包 就 会 按照 路由表 中 的 信息 被 转发 。 如果 规则 拒绝 该 数据包 通过 ， 那么 该 数据包 就 会 被 丢弃 。 如果 没有 规则 匹配 ， 由 用户 配置 的 缺省 参数 来 决定 是 转发 还是 丢弃 该 数据包 。   
 　 　 ( 1 )   与 服务 相关 的 过滤   包 过滤 路由器 可 根据 特定 的 服务 允许 或 拒绝 流动 的 数据包 ， 因为 多数 的 网络 服务程序 都 与 已知 的   TCP / UDP   端口 相连 。 例如 ，   Telnet   服务器 在   TCP   的   23   号 端口 上 监听 远端 连接 ， 而   SMTP   服务器 在   TCP   的   25   号 端口 上 监听 到 来自   Email   的 信息 。 为了 阻塞 所有 进入 的   Telnet   连接 ， 路由 只 需 丢弃   TCP   端口号 为   23   的 数据包 。 为了 限制 外部 主机 登录 到 内部网 的 主机 ， 路由器 必须 拒绝 所有   TCP   端口号 为   23   且   IP   地址 不 属于 内部网 地址 的 数据包 。 一些 典型 的 过滤 规则 ： 
 　 　 . 允许 进入 的   Telnet   会话 与 指定 的 内部 主机 连接   
 　 　 . 允许 进入 的   FTP   会话 与 指定 的 内部 主机 连接   
 　 　 . 允许 所有 外出 的   Telnet   会话   
 　 　 . 允许 所有 外出 的   FTP   会话   
 　 　 . 拒绝 所有 来自 特定 的 外部 主机 的 数据包   
 　 　 ( 2 )   与 服务 无关 的 过滤   有 几种 类型 的 黑客攻击 很难 使用 基本 的 包头 信息 来 识别 ， 因为 这 几种 攻击 与 服务 无关 。 针对 这 几种 攻击 的 过滤 规则 很难 指定 ， 因为 过滤 规则 需要 附加 某些 信息 ， 而且 这些 信息 只能 通过 检查 路由表 和 特定 的   IP   选项 才能 识别 出来 。 这 几种 攻击 为 ：   
 　 　 . 源地址 欺骗 ： 是 外部 入侵者 向 内部 发送 具有 内部 主机   IP   地址 的 数据包 。 对于 这种 攻击 ， 可 丢弃 所有 来自 路由器 外部 端口 且   IP   地址 为 内部 地址 的 数据包 。   
 　 　 . 源 路由 攻击 ： 是 入侵者 指定 了 数据包 在   Internet   上 所 走 的 路线 ， 这样 可以 让 数据包 旁路 掉 安全 防御 措施 。 路由器 应该 丢弃 所有 带有 源 路由 选项 的 数据包 。   
 　 　 . 极小 数据 片 攻击 ： 是 入侵者 使用 了   IP   分片 的 特性 ， 构造 极小 的   IP   包 数据 片 并 强行 将   TCP   头 信息 分成 多个 数据包 段 。 这种 攻击 可 绕过 用户 定义 的 过滤 规则 。 对于 这种 攻击 ， 必须 丢弃 协议 类型 为   TCP / IP   FragmentOffset   为   1   的 数据包 。   
 4   堡垒 主机 的 功能 结构   
 　 　 ( 1 )   代理服务器   包括 ：   WWW   、   SMTP   、   FTP   、   Telnet   ， 其 特点 如下 ：   
 　 　 . 每 一个 代理服务器 都 是 一个 简短 的 程序 ， 专门 为 网络安全 目的 而 设计 ， 它 只 支持 标准 命令 集合 的 子集 。 如果 代理 应用 不 支持 某个 命令 ， 用户 就 没有 使用 该 命令 的 权限 。   
 　 　 . 代理服务器 只 允许 被 特定 主机 访问 。   
 　 　 . 每个 代理服务器 与 其它 的 代理服务器 无关 。 如果 某个 代理服务器 出现 了 安全漏洞 ， 只 需 简单 的 卸掉 该 服务器 ， 不会 对 其它 服务器 造成 影响 。 这样 也 便于 增加 新 的 功能 。   
 　 　 . 代理服务器 除了 读取 初始化 配置文件 外 ， 一般 不 进行 磁盘操作 。 这 使得 入侵者 很难 安装 特洛伊 马 程序 或 其它 危险 文件 。   
 　 　 . 每个 代理服务器 都 以 非 特权 用户 身份 在 堡垒 主机 的 安全 目录 中 运行 。   
 　 　 ( 2 )   身份 认证   身份 认证 是 用来 改善 仅 有 简单 口令 保护 的 多用户 操作系统 安全 性能 的 机制 。 防火墙 采用 的 身份 认证 机制 为 一次性 口令 机制 。 如 名字 ， 口令 仅 使用 一次 。 在 一台 主机 上 ， 用户 不同 时间 所用 的 口令 是 不同 的 。 一个 用户 在 注册 到 远程 主机 之前 ， 必须 向 主机 表明 身份 并 产生 一个 口令 表 ， 以 用作 挑战 应答 系统 的 一部分 。 这个 表是 由 计算机 生成 的 一些 单词 与 单词 搭配 的 词组 或 数字 与 单词 搭配 的 词组 对 。   
 grasstree 
 bananataste 
 goodhope 
 starsun 
 
 . 单词 与 单词 词组 对 22goodbay 
 23deautiful 
 24strong 
 25jump 
 
 . 数字 与 单词 词组 对 
 
 　 　 如果 某 用户注册 时 得到 的 挑战 为   “   grass   ”   ， 用户 必须 应答   “ tree ”   ， 才能 得到 系统 的 认可 。 如果 口令 不慎 被 偷听 到 ， 因为 “   grass   ” 不会 再 作为 挑战 出现 ，   “ tree ”   也 就 没有 用 了 。   
 　 　 词汇表 是 用   S / Key   产生 的 ， 其 特点 是 简单 、 灵活 、 代价 低 。   S / Key   使用 一个 与 用户 共享 的 秘密 口令 来 生成 词汇表 ， 任何 挑战 只 出现 一次 ， 然后 口令 作废 。   
 　 　 ( 3 )   加密 系统   堡垒 主机 的 加密 系统 可 对   Internet   和 内部网 之间 的 通信 进行 自动 加密 ， 经过 这个 系统 加密 的 信息 ， 除 合法 的 发送 和 接受 用户 外 ， 其它 任何 用户 都 不可 读取 ， 即 每次 通信 都 建立 一条 安全 通道 。 在 两地 加密 系统 的 保证 下 ， 信息 是 不可 破译 或 破译 后 没有 实际 的 用处 。   
 　 　 加密 系统 采用 公开密钥 技术 。 发送 方用 自己 的 私密 密钥 对 信息 加密 后 传送 给 接受方 ， 接收 方在 收到 信息 后 用 发送 方 的 公开密钥 进行 解密 。 双方 用户 为了 使用 公开密钥 加密技术 ， 发送 方 必须 有 自己 的 私密 密钥 和 公开密钥 ， 接收 方 必须 知道 发送 方 的 公开密钥 。   
 　 　 防火墙 区分 一般 数据包 和 加密 包 、 密钥 交换 包 的 方法 是 让 后者 带有 特殊 的 标记 。 标记 的 方式 应该 保证 数据包 仍然 符合   TCP / IP   协议 规范 ， 使得 其 对于 公共 网 具有 透明性 ， 而 不至于 被 公众网 中 的 路由器 或 其它 设备 过滤 掉 。 加密 包未 引进 额外 数据 ， 否则 可能 需要 在 源 分片 在 目 重组 使 其   MTU   符合 公共 网 的 要求 。   IP   协议 报头 的 标志 字段 中 有 若干位 没有 定义 ， 可 供 任意 使用 。 用 其 标记 特殊 包 可以 满足 上述 要求 。   
 　 　 密钥 交换 协议 的 源 目为 安全 通道 两端 的 防火墙 。 由于 透明 通道 防火墙 没有   IP   地址 ， 使 交换 包 无法 在 公共 网中 寻径 。 分配 属于 安全 通道 一端 主机 的 某个 端口 用于 密钥 交换 协议 是 一个 可行 的 办法 。 所 分配 的 端口 应 避免 使用 公共 端口 而 引起 冲突 。 端口 和 主机 地址 可 由 用户 指定 ， 并 在 安全 通道 配置文件 中 给出 。 协议 缺省 使用 安全 通道 本 端子 网 的 第一个 可用   IP   地址 的 端口   60000   ， 采用 无 连接 的   UDP   。 由于 防火墙 将 截获 交换 协议 包 ， 该 主机 不必 真实 存在 。   
 　 　 本 防火墙 使用 的 是   RSA   公开密钥 算法 。   RSA   公钥 和 密钥 的 管理 和 分发 有 成熟 的 解决方案 。 一般 由 用户 自行 生成 公钥 密钥 ， 然后 将 公钥 和 用户 身份 电子 或 手工 提交 到 认证 机构   ( Certificate   Authority )   ， 由 认证 机构 做 民事 调查 后 ， 签署 认证书 用以 认证 用户 使用 该公钥 的 权利 。 由于 国内 尚无 具有 法律认可 的 认证 机构 ， 防火墙 系统 使用 的   RSA   公 密钥 由 系统 附带 的 应用程序 生成 ； 公钥 无 认证 ， 以 文件 形式 传递 给 其他 防火墙 系统 。   
 5   防火墙 系统 的 特点   
 　 　 连接   DMZ   的 路由器 用来 管理 外来 的 访问 ， 检查 进入 内部网 的 信息 ， 防范 通常 的 外部 攻击 ， 它 只 允许 外部 访问 堡垒 主机   (   还 可能 有 信息 服务器   )   。 连接 内部网 的 路由器 提供 了 第二层 防御 ， 它 只 接受 来自 堡垒 主机 的 数据包 ， 负责管理 堡垒 主机 到 内部网 的 访问 。   
 　 　 对于 源于 内 的 访问 ， 连接 内部网 的 路由器 只 允许 内部 用户 访问 堡垒 主机 或 某些   Internet   站点 。 连接   DMZ   的 路由器 的 过滤 规则 要求 只 接收 来自 堡垒 主机 的 数据包 。   
 　 　 这个 防火墙 具有 以下 几个 优点 ：   
 　 　 ( 1 )   入侵者 必须 突破   3   个 不同 的 设备 才能 侵入 内部网 ： 外部 路由器 、 堡垒 主机 、 内部 路由器 。   
 　 　 ( 2 )   由于 外部 路由器 只 向 外部 网 通告 堡垒 主机 的 存在 ， 这样 可以 保证 内部网 对外 是   “   不 可见   ”   的 。 并且 只有   DMZ   网络 上 选定 的 系统 才能 对外部 网 开放 。   
 　 　 ( 3 )   由于 堡垒 主机 的 存在 ， 内部网 用户 只有 通过 堡垒 主机 上 的 代理 系统 才能 与 外界 通信 。   
 作者 单位 ： 上海交通大学 网络信息中心 ， 上海   200030 
 参考文献   
 1   Cheswick   W   R , Bellovin   S   M . Firewalls   and   Internet   Security - -   Repelling   the   Willy   Hacker . ATamp ; T   Bell   Lab . , 1995   
 2   Abrams   M , Podell   H . Computer   and   Network   Security . Los   Alam -   itors , CA : IEEE   Computer   Society   Press , 1987   
 3   Venema   W . TCP   Wrapper :   Network   Monitoring . ACCESS   Control   and   Body   Traps . USENIX   Proceeding . UNIX   Security   Symposiunm   III , 1992 - 09   
