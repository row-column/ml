微型机 与 应用 
 MICROCOMPUTER   &   ITS   APPLICATIONS 
 2000 　 No.19 　 No.1 　 P.46 - 48 
 
 
 
 
 基于 LonWorks 技术 的 远程 监控 系统 的 设计 与 实现 
 冯显勇 　 陈辉堂 
 摘   要 ：   一套 采用 LonWorks 技术 的 电梯 远程 监控 系统 ， 讨论 了 LON 节点 的 工作 原理 及其 与 MODEM 之间 的 硬件 连接 和 软件 实现 。 比较 了 二种 不同 的 实现 方法 在 不同 场合 中 的 应用 ， 进一步 说明 了 现场 总线 的 应用 价值 。   
 关键词 ： 远程 监控   现场 控制 网络   串行 通信 电话 网络计算机 节点 1ModemModem 节点 2 节点 3 节点 4 
 　 　 近几年 ， 基于 Lonworks 技术 的 控制系统 在 许多 领域 都 取得 迅速 发展 。 在 很多 应用性 的 工程 中 ， 为了 管理 上 的 方便 ， 经常 要 对 一些 系统 （ 特别 是 分散 的 、 无人 看守 的 小 系统 ） 的 运行 状态 进行 监控 ， 实现 集中管理 和 维护 ， 以 减少 人力 、 物力 ， 提高 经济效益 和 工作效率 。 比如 电梯公司 或 物业管理 部门 要 对 分散 全市 的 一些 电梯 运行 情况 进行 监控 。 对于 分布 在 较大 范围 内 的 系统 ， 用 电话线 连接 实现 远程 监控 在 目前 还是 有着 比较 重要 的 意义 。 本文 虽然 只是 具体 介绍 了 电梯 控制系统 的 监控 ， 但 对于 类似 的 控制系统 具有 普遍 的 意义 。 
 　 　 本 监控 系统 的 对象 是 采用 LonWorks 技术 的 电梯 控制系统 ， LonWorks 是 美国 Echelon 公司 1991 年 推出 的 一种 典型 的 现场 总线 系统 ， 又称 局域 操作 网络 （ Local   Operation   Networks ） 。 其 LonTalks 协议 支持 多种 低成本 的 通信 介质 ， 如 双绞线 、 电力线 、 同轴电缆 等 ， 这种 电梯 与 PLC 控制 的 电梯 相 比较 ， 有着 布线 少 、 接线 灵活 、 成本低 等 优点 。 尤其 是 基于 LonWorks 技术 的 各种 设备 的 可 互操作 及 通过 LonWorks 通道 可 链接 智能 大厦 这 2 大 优势 ， 使 其 极具 发展前途 。 
 1   监控 系统 组成 
 　 　 根据 应用 系统 的 实际 特点 和 需求 ， 本 系统 考虑 了 2 种 不同 的 方案 。 第 1 种 方案 针对 所 要 监测 的 控制系统 为 单个 控制 网络 、 现场 无人 值守 的 情况 下 ， 从 经济 和 实用 的 角度 出发 ， 我们 采用 1 个 LonWorks 节点 来 实现 采集 数据 和 通信 的 功能 。 系统 的 结构 如图 1 所示 。 
 
 图 1   系统结构 框图 
 　 　 现场 部分 由 LON 节点 1 和 调制解调器 （ MODEM ） 及 电梯 控制系统 组成 ， 节点 1 的 主要 功能 是 采集 需要 监控 的 网络 变量 ， 并 通过 RS232 接口 与 调制解调器 连接 ， 将 网络 变量 通过 MODEM 发送给 远 端的 计算机 ， 或 接收 远端 计算机 的 命令 ， 从而 实现 远程 监控 。 节点 2 、 3 、 4 组成 电梯 的 控制系统 ， 分别 为 外召 、 主控 、 轿箱 3 个 控制 节点 ， 4 个 节点 之间 通过 双绞线 连接 。 之所以 将 数据 采集 和 通信 节点 做成 单独 的 节点 ， 主要 是 为 应用 于 别的 控制系统 ， 只要 在 原有 的 LonWorks 控制 网络 上加 1 个 节点 即可 。 远端 只要 有 计算机 和 MODEM 即可 。 这种 结构 的 特点 是 实现 比较 方便 ， 工作 原理 和 系统结构 比较简单 ， 成本 比较 低 。 而且 通过 比较 发现 ， 这种 方法 采集 数据 的 速度 是 令人满意 的 ， 对于 MODEM 和 电话 线路 的 通信 质量 的 要求 不高 。 利用 LonWorks 的 特点 ， 在 节点 1 中 定义 一些 输入 型 的 网络 变量 ， 用 LonWorks 的 开发工具 将 节点 1 与 控制系统 中 相应 的 网络 变量 连接起来 ， 当 控制系统 中 的 网络 变量 发生变化 时 ， 节点 1 中 与其 相连接 的 网络 变量 也 会 自动更新 ， 同时 触发 1 个 事件 ， 所以 用 这种 方法 监测 到 的 网络 变量 的 变化 速度 快 ， 而且 简单 可靠 。 
 　 　 第 2 种 方案 针对 同时 监控 多个 对象 （ 网络 ） ， 在 现场 （ 附近 ） 需要 进行 监控 的 情况 下 ， 与 第 1 种 方案 比较 ， 区别 主要 在 现场 的 数据 采集 方法 上 。 现场 的 数据 采集 利用计算机 和 SLTA ／ 2 网络适配器 或 PCLTA 网卡 完成 。 首先 利用 专用 的 网络适配器 和 软件 将 控制 网络 上 的 网络 变量 采集 到 计算机 上 ， 通过 动态 数据交换 （ DDE ） 将 数据 传给 通信 程序 ， 再 由 通信 程序实现 和 远程 计算机 之间 的 数据交换 。 这种 方法 因为 在 现场 要 配置 计算机 和 网络适配器 ， 若 只 监控 1 个 较 小 的 系统 成本 相对 比较 昂贵 ， 但 它 有 一个 较大 的 优点 ： 可以 对 已有 的 控制系统 不 做 任何 改动 。 因此 比较 适合 于 对 已经 投入 应用 的 系统 进行 监控 ， 或者 对系统 进行 临时 的 监控 。 而且 利用 1 台 计算机 就 可以 同时 监控 多个 系统 ， 比如 对 1 个 住宅小区 的 多部 电梯 进行 监控 ， 所以 也 具有 一定 的 应用 价值 。 这种 方案 的 结构 与 上面 的 结构图 相比 ， 只要 将 图 1 中 的 节点 1 用 计算机 和 网络适配器 代替 即可 。 计算机 和 LonWorks 网络 以及 MODEM 之间 的 连接 是 很 方便 的 。 
 2   系统 的 硬件 实现 
 　 　 在 第 1 种 方案 中 ， 还要 解决 LON 节点 1 与 MODEM 之间 的 数据通信 问题 。 所以 必须 了解 RS232 的 接口 信号 ， 在 常用 的 9 个 信号 中 ， RTS ／ CTS 请求 应答 联络 信号 是 用于 半双工 MODEM 系统 中作 送 方式 和 接收 方式 的 切换 ， 在 双工方式 系统 中 ， 因 配置 双向 通道 故不需 RTS ／ CTS 联络 信号 。 为了 使 节点 和 MODEM 之间 的 通信 简化 ， 这里 只用 了 RS232 接口 的 5 个 接口 信号 ， 如表 1 所示 。 
 表 1   RS232 引脚 信号 
 
 CD   Carrier   Detect 数据 载波 侦测 
 RXD   Receive   Data 接收数据 
 TXD   Transmit   Data 发送数据 
 DTR   Data   Terminate   Ready 数据终端 准备 好 
 SG   Signal   Set   Ready 地线 
 
 　 　 因 现场 无人 值守 ， 接 MODEM 的 DTR 信号 应该 一直 为 有效 （ 高电平 ） ， 使 MODEM 随时 能够 进行 自动应答 和 拨号 的 操作 。 MODEM 的 CD 引脚 接 节点 1 的 一个 I ／ O 口 用于 判断 MODEM 之间 是否 建立 了 载波 链路 。 由于 神经元 芯片 的 I ／ O 口 的 电平 为 TTL 电平 ， 还 必须 用 专用 芯片 如 MAXIM202 进行 TTL 电平 到 RS232 电平 的 转化 。 MODEM 的 RXD ， TXD 经 电平 转换 分别 接 神经元 芯片 的 2 个 I ／ O 口 。 （ 本 系统 采用 的 3150 神经元 芯片 、 I08 和 I010 可 分别 定义 成 输入 、 输出 串行口 ） ， 3150 的 串行 通信 是 半双工 方式 ， 要 用 一片 译码器 进行 输入 、 输出 的 选通 。 节点 1 和 MODEM 之间 的 电路 如图 2 所示 。   
 
 图 2   节点 1 与 MODEM 的 硬件 连接 示意图 
 3   监控 软件设计 
 　 　 软件 实现 分为 二 部分 ， 现场 节点 数据 采集 、 通信 和 远端 计算机 通信 部分 和 监控 界面 部分 。 LonWorks 提供 了 Neuron   C 的 编译器 ， Neuron   C 是 1 种 面向对象 的 语言 ， 语法 与 C语言 类似 ， 但 可以 对 I ／ O 口 和 网络 变量 的 变化 以 事件 触发 方式 进行 处理 ， 极大 地方 便 了 软件 的 开发 。 只要 根据 用户 的 需要 对 各种 事件 进行 处理 ， 就 可以 实现 控制 、 通信 等 各种 功能 。 从 监控 的 要求 出发 ， 只要 实时 监控 系统 中 能 反映 电梯 运行 的 一些 网络 变量 。 对于 整个 系统 我们 要求 现场 和 远端 主机 都 应 具备 双向通信 功能 ， 即 应答 和 呼叫 的 功能 ， 所以 双方 的 MODEM 都 要 设置 成 自动应答 方式 。 远端 计算机 拨通 现场 的 电话 后 ， 节点 1 首先 将 当前 的 网络 变量值 发送 过来 ， 此后 便 随着 系统 的 运行 而 实时 地 进行 更新 。 远端 主机 要 停止 监测 只 需 挂断 电话 即可 。 节点 1 还要 具备 自动 拨号 的 功能 ， 在 检测 到 控制系统 的 故障 信号 （ 比如 相应 的 网络 变量 或 I ／ O 口 发生变化 时 ） 时 ， 应该 通过 给 MODEM 发送 AT 命令 ， 拨通 远端 主机 的 电话 进行 报警 。 在 系统 正常 运行 的 情况 下 ， 各 状态 信号 只有 在 双方 建立 连接 后 ， 才 会 将 数据 发送 出去 ， 整个 节点 的 工作 流程 如图 3 所示 。 
 　 
 图 3   节点 程序流程 
 　 　 在 reset （   ） 复位 程序 中 包括 对 MODEM 的 初始化 和 网络 变量 、 I ／ O 口 状态 的 初始化 。 此后 ， 系统 等待 事件 的 发生 ， 如果 此时 远端 计算机 进行 拨号 ， 拨通 后 首先 要 进行 用户 的 口令 检查 ， 以 避免 他人 误拨 进入 系统 ， 一旦 建立 了 连接 ， 则 连接 MODEM 的 CD 信号 脚 的 I ／ O 口 将 变为 高电平 ， 同时 触发 io ＿ changes （   ） 事件 ， 在 此 事件 的 处理过程 中 首先 调用 poll （   ） 内部 函数 对 网络 变量 进行 轮询 ， 并 将 网络 变量 的 当前 值 发送 出去 。 然后 每当 有 网络 变量 发生变化 时 ， 会 触发 nv ＿ update ＿ occurs （   ） 事件 ， 在 本 事件 中 首先 判断 CD 是否 有效 ， 若 有效 则 将 该 网络 变量 编码 并 发送给 MODEM ， 再 通过 电话线 送给 远端 计算机 。 如果 系统 发生 故障 ， 则 相应 的 网络 变量值 会 发生变化 ， 不同 的 值 代表 不同 类型 的 故障 ， 此时 若 还 没有 建立 载波 链路 ， 程序 应 调用 拨号 子程序 dial （   ） 拨通 设定 的 远端 计算机 电话号码 。 在 一定 时间 内若 没有 拨通 ， 还要 进行 重拨 。 
 　 　 远端 计算机 的 数据 是 通过 串口 进入 的 ， 软件 的 设计 与 控制系统 并 无 直接 关系 ， 所以 其 编程 是 相对 独立 的 ， 只 需 对 串口 通信 进行 处理 ， 利用 DELPHI 中 的 VBX 控件 实现 Tcomm 对 串口 的 通信 是 非常 方便 的 。 有 数据 进入 指定 COM 口 的 缓冲区 时 ， 会 触发 1 个 通信 事件 ， 收到 数据 后 ， 首先 要 判断 信息 的 类别 ， 区分 是 控制 信号 还是 要 监测 的 数据 ， 然后 分别 进行 处理 。 值得注意 的 是 ， 通过 MODEM 收发 数据 ， 因为 数据格式 和 长度 不 固定 ， 要 采取 一定 的 措施 保证数据 的 有效 传输 和 接收 。 对 监控 的 数据 的 处理 相对 比较简单 ， 只 需 按照 电梯 的 工作 原理 和 各种 信号 的 逻辑关系 用 图形 动态 模拟 或用 文字 加以 说明 。 对 故障 的 发生 还要 进行 记录 ， 包括 故障 的 类型 、 发生 时间 、 次数 等 ， 以便 为 日后 维修 提供 历史数据 。 用户 也 可以 通过 MODEM 向 控制系统 发送数据 以 控制 网络 的 运行 ， 但 从 安全性 的 角度 出发 ， 本 系统 中 并 不 向 电梯 发送 控制 命令 ， 以免 误操作 引起 系统故障 。 
 　 　 对于 第 2 种 方案 ， 即 现场 用 计算机 进行 数据 采集 ， 其 工作 原理 类似 。 计算机 通过 网络适配器 接到 LonWorks 网络 上 ， 系统 的 客户程序 是 采用 Delphi 编写 的 ， 主要 是因为 Delphi 编写 的 软件 具有 执行 效率 比较 高 的 优点 ， 用 它 可以 很 方便 地 实现 应用程序 与 底层 数据 采集 系统 之间 的 动态 数据交换 ， 底层 的 数据 采集 要 利用 LonWorks 的 开发工具 ： LonManagerTM   DDE   Server 软件 ， DDE   Server 主要 的 功能 就是 实现 Windows 应用程序 与 LonWorks 控制 网络 之间 的 通信 ， 实现 Windows 应用程序 和 控制 网络 之间 的 动态 数据交换 。 DDE   Server 可以 监测 LonWorks 网络 上 的 网络 变量 或 消息 及其 变化 。 利用 DELPHI 的 DDE 编程技术 ， 将 DDE   Server 作为 服务程序 ， 指定 网络 变量 （ netvar ） 为 主题 ， 项目 则 为 具体 的 网络 变量名 ， 就 可以 实现 和 DDE   Server 之间 的 联系 ， 收集 数据 或 发送 命令 。 上位 机 的 软件 比较简单 ， 只要 对 收到 的 数据 进行 判别 、 处理 ， 再 运用 各种 方法 直观 地 显示 出来 （ 用 DELPHI 丰富 的 控件 或者 自己 编制 控件 进行 模拟 显示 非常 方便 ） 。 程序 的 流程 和 上述 一样 ， 当然 用 计算机 实现 串口 通信 、 与 MODEM 之间 的 数据传输 操作 更为 方便 。 功能 上 也 可以 做 得 更为 完善 ， 只是 由于 数据 的 采集 是 通过 动态 数据交换 得到 的 ， 在 数据 的 更新 速度 上会 有 一些 不足 。 
 　 　 本 系统 采用 了 LonWorks 现场 总线 控制系统 ， 由于 其 对 等 通信 、 无 中心 控制 ， 在 进行 系统 设计 时 解决 数据通信 问题 非常 轻松 ， 而且 由于 其 智能 分散控制 方式 等 优点 ， 大大降低 了 调试 难度 ， 提高 了 系统 的 开发 和 设计 的 周期 ， 实验 表明 用 这种 方法 实现 远程 监控 原理 简单 ， 工作 可靠 ， 具有 较强 的 实用价值 。 
 冯显勇 （ 上海 同济大学 电气工程 系  200092 ） 
 陈辉堂 （ 上海 同济大学 电气工程 系  200092 ） 
 参考文献 
 1 ， 深圳 网通 软件 有限公司 ． MODEM 应用 技术 ． 北京 ： 电子 工业 出版社 
 2 ， 汪之松 ， 陈辉堂 ， 蒋平 ． 基于 LONWORKS 技术 的 电梯 系统 ． 1998 上海市 自动化 学会 、 化学 化工 学会 专业 委员会 学术年会 论文 摘要 
 3 ， ECHELON ． NEUCRON   C   Reference   Guide ． ECHELON ， 1995 
 4 ， 姚庭宝 ． 精通 DELPHI ． 北京 ： 电子 工业 出版社 
 5 ， ECHELON ． LonManager   DDE   Server   User ＇ s   Guide 
 收稿 日期 ： 1999 － 08 － 11 
