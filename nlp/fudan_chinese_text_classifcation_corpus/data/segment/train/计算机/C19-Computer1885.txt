微型机 与 应用 
 MICROCOMPUTER   &   ITS   APPLICATIONS 
 2000 　 Vol.19 　 No.4 　 P.29 - 30 
 
 
 
 局域网 视频 数据传输 的 应用 研究 
 莫宁 　 俞宁 
 摘   要 ：   在 运行 Ｔ Ｃ Ｐ ／ Ｉ Ｐ 协议 的 局域网 环境 下 利用 Ｕ Ｄ Ｐ  用户 数据 报  实现 视频 数据传输 的 方法 ， 并 使用 该 方法 给出 了 一个 实时 视频 监视系统 的 开发 实例 ， 对 在 局域网 上 开发 视频 应用 系统 进行 了 有益 的 研究 。 
 关键词 ：   局域网 视频 传输   Ｔ Ｃ Ｐ ／ Ｉ Ｐ 协议   用户 数据 报   线程 
 　 　 如何 利用 局域网 资源 实现 视频 应用 系统 已 逐渐 成为 人们 研究 的 热门话题 。 在 局域网 上 实现 视频 应用 系统 的 技术 关键 是 如何 实现 视频 信息 的 传输 。 为了 解决 视频 数据 在 计算机网络 上 传输 的 问题 ， 国际标准化组织 提出 了 一系列 的 视频 数据压缩 传输 标准 。 如 国际电信联盟 （ ITU — T ） 提出 的 H ． 323 标准 ， 就是 针对 在 局域网 和 Internet 网络 上 传输 压缩 视频 数据 的 国际标准 。 但是 在 局域网 上 如何 传输 压缩 以后 的 视频 数据 与 网络 运行 的 具体 通信协议 有关 。 
 1 　 TCP ／ IP 网络 
 1 ． 1 　 基本概念 
 　 　 TCP ／ IP 得名 于 2 个 有名 的 协议 ， 即 TCP （ Transmission   Control   Protocol ） 协议 和 IP （ Internet   Protocol ） 协议 。 然而 “ TCP ／ IP ” 并 不仅仅 指 这 2 个 协议 ， 而是 常常 用来 代表 相关 的 一组 协议 ， 如 UDP （ 用户 数据 报 协议 ） 、 FTP （ 文件传输 协议 ） 等 。 采用 TCP ／ IP 协议 的 网络 被 称为 TCP ／ IP 网络 。 TCP ／ IP 网络 分层 模型 定义 了 5 层 网络通信 协议 （ 应用层 、 传输层 、 网际 层 、 链接 层 和 物理层 ） 。 其中 传输层 和 网际 层 是 最为 重要 的 ， 而 链接 层 和 物理层 在 局域网 上 是 采用 局域网 的 协议 标准 。 传输层 协议 包含 2 个 协议 ： 传输控制协议 （ TCP ） 和 用户 数据 报 协议 （ UDP ） 。 TCP ／ IP 的 传输层 协议 与 高层 协议 （ ULP ） 之间 的 连接 对应 关系 由套 接字 （ Socket ） 来 确定 。 网际 层 位于 传输层 的 下方 由 多种 协议 组成 ， IP 协议 是 其中 最 重要 的 一个 ， 主要 解决 网际 互联 。 应用层 则 根据 不同 的 应用 规定 了 一些 标准 ， 如 FTP （ 文件传输 协议 ） 、 TELENET （ 仿真 终端 协议 ） 、 SMTP （ 简单 邮件 传送 协议 ） 等等 。 
 1 ． 2 　 TCP 与 UDP 比较 
 　 　 对于 同一 网络 中 的 主机 到 主机 的 数据传输 来说 ， 传输层 协议 是 最 重要 的 协议 。 用户 在 编写 TCP ／ IP 通信 程序 时 ， 必须 首先 选择 采用 TCP 协议 或 UDP 协议 ， 这 往往 要 根据 用户 的 具体 应用 要求 来 决定 。 TCP 与 UDP 的 主要 差别 为 ： 
 　 　 （ 1 ） TCP 协议 是 面向 连接 的 ， 使用 TCP 协议 交换 数据 前 必须 先 建立 通信 主机 之间 的 连接 关系 ， 在 此 连接 之上 传送 TCP 分组 数据 并 维护 此 连接 ， 用户 数据 传送 完毕 后要 撤除 连接 。 UDP 协议 是 无 连接 的 ， 每个 UDP 分组 都 是 独立 的 数据 单元 。 
 　 　 （ 2 ） 在 TCP 传输 中 ， 高层 数据 可以 以 字节 流 的 形式 传递 给 TCP ， 字节 流 被 TCP 缓冲 ， 直到 积累 到 一定 的 长度 时 启动 1 次 发送 操作 。 而 在 UDP 协议 中 ， ULP 传递 给 UDP 的 是 对应 于 UDP 数据包 的 数据 块 。 
 　 　 （ 3 ） TCP 协议 提供 可靠 传输服务 ， 包括 报文 序列 、 流控制 、 差错 检测 、 优先级 等等 。 而 UDP 则 不 提供 以上 控制 ， 是 不 可靠 服务 。 
 　 　 由 以上 比较 可以 看出 UDP 协议 比 TCP 协议 实现 更 简单 ， 它 省去 了 建立 连接 和 拆除 连接 的 过程 ， 取消 了 重发 检验 机制 ， 能够 达到 较 高 的 通信 速率 ， 其 缺陷 是 不能 保证 传输 的 可靠性 。 因此 ， TCP 协议 通常 用于 数据文件 的 传输 等 可靠 传输 应用 ， 而 UDP 通常 用于 对 数据 可靠性 要求 不高 但 数据量 大 的 场合 ， 如 图像 、 语音 数据 的 传输 。 另外 ， 使用 UDP 的 传输 效果 与 网络 的 环境 密切相关 。 在 局域网 的 环境 下 ， 由于 数据传输 的 误码率 是 很 低 的 ， 使用 UDP 协议 传输 也 能 达到 很 不错 的 效果 。 
 2 　 视频 监视系统 的 设计 
 　 　 一般 对 视频 监视系统 来说 ， 要求 系统 能 实现 视频 图像 的 实时 传送 ， 尤其 是 在 工业 监视 等 应用 场合 ， 为了 能 及时 准确 地 反映 监视 现场 的 情况 ， 图像 的 延时 应 不 大于 400ms 。 而且 在 多数 情况 下 ， 要求 实现 多个 中心 监视 站 同时 监视 多个 现场 监视 站 ， 这时 通信 方式 不再 是 简单 的 点对点 方式 ， 而是 多点 对 多点 的 方式 。 UDP 协议 支持 广播 方式 通信 ， 这 对于 解决 图像 的 多点 传送 提供 了 一条 简单 方便 的 途径 。 当有 多个 中心 监视 站 需要 同时 监视 1 个 现场 监视 站 时 ， 现场 监视 站 只 需 简单 地以 广播 方式 把 数据 报 送到 网上 即可 。 当有 多个 现场 监视 站 时 ， 可以 通过 不同 的 UDP 端口号 加以 区别 。 基于 以上 的 分析 ， 提出 了 如图 1 所示 视频 传输 系统 模型 。 
 
 图 1 　 视频 传输 系统 模型 
 　 　 在 图 1 的 模型 中 ， 各个 现场 监视 站 计算机 由 1 个 视频 捕捉 卡 与 摄像机 相连 ， 负责 采集 并 以 JPEG 方式 压缩 图像 数据 ， 然后 以 UDP 数据 报 的 形式 向 中心 监视 站 发送 。 中心 监视 站 负责 接受 各个 现场 监视 站 发送 来 的 UDP 数据 报 ， 并 将 UDP 数据 报 组装 还原成 图像 数据 ， 最后 解压 显示 图像 。 由于 中心 监视 站 的 任务 比较 重 ， 因此 中心 监视 站 的 性能 应 比较 好 。 在 此 模型 中 ， 由于 采取 单帧 JPEG 格式 图像 传送 方式 ， 因此 图像 传送 延时 小 。 另外 即使 某一 图像 帧 在 网络 传送 中 发生 错误 ， 很快 就 被 下 一帧 图像 刷新 ， 不会 影响 图像 的 监视 。 
 3 　 视频 数据传输 软件 的 设计 
 3 ． 1 　 软件开发 环境 
 　 　 软件 选用 Windows98 开发 环境 ， 开发 时 充分发挥 Windows   GUI 程序 的 优点 。 实际 采用 WinSock 来 实现 现场 监视 站 与 中心 监视 站 之间 的 通信 。 它 是 Microsoft 牵头 开发 的 1 组 Windows   Socket   API 函数 ， 扩展 了 UNIX 环境 下 传统 的 4BSD   Socket ， 以 适应 Windows 的 消息 驱动 。 开发工具 选用 Inprise 公司 的 Delphi   4 ． 0 ， 它 以 其 使用方便 、 功能强大 而 深得 广大 程序员 的 喜爱 ， 而且 它 还 提供 了 1 套 Internet 组件 ， 使 开发 网络通信 程序 更加 方便 。 在 这套 组件 中 ， 包括 TNMUDP 组件 ， 这个 组件 就是 专用 于 UDP 通信 的 。 本 软件 中 的 图像 数据传输 就是 通过 它 来 完成 的 。 
 3 ． 2 　 软件 的 结构 
 　 　 根据 以上 的 视频 监视系统 模型 ， 软件设计 包括 二 部分 ： 现场 监视 站 和 中心 监视 站 软件 。 
 　 　 （ 1 ） 现场 监视 站 软件 
 　 　 现场 监视 站 软件 主要 由 视频 数据 采集 压缩 模块 和 视频 数据传输 模块 组成 。 现场 监视 站 周期性地 捕捉 图像 ， 经过 压缩 后 再 传输 。 由于 局域网 的 传输 带 是 有限 的 ， 而 图像 的 信息 又 非常 大 ， 如 1 幅 320 × 240 的 24 位 彩色图像 的 数据量 230400B ， 若 每秒 捕捉 10 帧 ， 则 图像 数据量 为 2304000B ， 若 不 进行 压缩 ， 很难 在 一般 的 局域网 上 传输 ， 因此 在 传输 前 必须 对 图像 数据压缩 。 本 系统 中 使用 的 方法 是 对 每 帧 图像 以 JPEG 的 方式 进行 软件 压缩 ， 压缩 品质 设为 80 。 经过 压缩 后 ， 每帧 图像 的 数据量 仅 有 10KB ， 能 满足 一般 局域网 传输 要求 ， 且 图像 质量 令人满意 。 由于 采用 UDP 方式 传输 图像 数据 ， 因此 软件 本身 必须 负责 将 每 帧 图像 拆成 UDP 数据包 ， 然后 发送 。 以下 是 图像 数据 的 发送 部分 程序代码 （ 假定 图像 数据 经过 压缩 后 存放 在 流 ImageStream 中 ） ： 
 　 　 bufftemp ： array ［ 1 ． ． maxsize ］ of   char ； 
 　 　 bytes ， i ， divsion ， remain ： integer ； 
 　 　 bytes ： ＝ ImageStream ． Size ； 　 　 　 ／ ／ 获取 图像 大小 
 if   bytes ， ＜ ＞ 0   then   begin 
 　 　 divsion ： ＝ bytes   div   maxsize ； 　 　 ／ ／ maxsize 为 每个 
 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ／ ／ UDP 包 大小 
 　 　 remain ： ＝ bytes   mod   maxsize ； 
 　 　 FUDP1 ． SendBuffer （ StartSend ， 5 ） ； ／ ／ 图像 传输 开始 标记 ， FUDP1 — TNMUDP 对象 
 　 　 sleep （ 1 ） ； 
 　 　 for   i ： ＝ 0   to   divsion － 1   do 　 　 　 　 ／ ／ 拆分 并 发送 图 
 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ／ ／ 像 数据 
 　 　 begin 
 　 　 　 ImageStream ． ReadBuffer （ bufftemp ， maxsize ） ； 
 　 　 　 FUDP1 ． SendBuffer （ bufftemp ， maxsize ） ； 
 　 　 end ； 
 if   remain   ＜ ＞ 0   then   begin 
 　 　 　 Imagestream ． ReadBuffer （ bufftemp ， remain ） ； 
 　 　 　 FUDP1 ． SendBuffer （ bufftemp ， remain ） ； 
 　 　 　 　 　 end ； 
 　 　 　 sleep （ 1 ） ； 
 　 　 FUDP1 ． SendBuffer （ EndSend ， 5 ） ； 　 　 ／ ／ 图像 传输 
 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ／ ／ 结束 标记 
 　 　 end ； 
 … … 
 　 　 （ 2 ） 中心 监视 站 软件 
 　 　 中心 监视 站 软件 负责 接受 UDP 数据包 并 还原成 完整 的 图像 数据 ， 然后 解压 显示 图像 。 当 中心 监视 站 的 UDP 组件 收到 1 个 数据包 时 ， 就 会 触发 OnDataReceived 事件 。 程序 可以 在 此 事件 的 处理函数 中 读取 图像 数据 。 为了 使 中心 监视 站 能 及时 接受 所有 的 UDP 数据包 ， 该 事件处理 函数 应 尽可能 简单 、 迅速 地 完成 。 另外 ， 图像 的 解压 显示 功能 应 在 另 一个 线程 中 完成 。 当 主线 程 收到 1 帧 完整 的 图像 数据 后 ， 启动 （ Resume ） 该 线程 ， 该 线程 完成 解压 图像 显示 后应 自动 挂 起 （ Suspended ） 。 以下 是 OnDataReceived 事件处理 函数 的 部分 代码 ： 
 　 　 mstream ： TmemoryStream ； ／ ／ mstream 为 全局变量 ， 存放 
 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ／ ／ 接受 到 的 图像 数据 
 　 　 procedure   TCenter ． NMUDP1DataReceived （ Sender ∷ Tcomponent ； NumberBytes ： Integer ； FromIP ： String ） ； 
 　 　 　 　 　 flag ： array ［ 1 ． ． 5 ］ of   char ； 
 　 　 　 　 　 begin 
 　 　 　 　 　 　 if   Numberbytes ＝ 5   then   ／ ／ 传输 开始 ， 结束 
 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ／ ／ 标记 长度 均 约定 为 5B 
 　 　 　 　 　 begin 
 　 　 　 　 　 　 NMUDP1 ． ReadBuffer （ flag ， 5 ） ； 
 　 　 　 　 　 If   flag ＝ Startend   then   exit ； 　 ／ ／ 接收 到 
 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ／ ／ 的 数据 是 传输 开始 标记 
 　 　 　 　 　 if   flag ＝ endsend   then 　 　 　 　 　 ／ ／ 接收 到 的 
 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ／ ／ 数据 是 传输 结束 标记 
 　 　 　 　 　 begin 
 　 　 　 　 　 　 mstream ． Seek （ 0 ， soFromBeginning ） ； 　 　 　 ／ ／ 启动 图像 显示 线程 
 　 　 　 if   threadDisplayImage ． Suspended   then   threadDisplayImage ． Resume ； 
 　 　 　 　 　 eixt ； 
 　 　 　 　 end 
 　 　 　 end ； 
 else 
 　 　 begin 　 　 　 　 ／ ／ 接收 到 的 数据 是 图像 数据 
 　 　 　 mstream ． seek （ 0 ， soFromEnd ） ； 
 　 　 　 NmUdp1 ． ReadStream （ mstream ） ； 
 　 　 　 end ； 
 … … 
 4 　 结论 
 　 　 本文 通过 分析 TCP ／ IP 网络通信 协议 的 传输 特点 以及 视频 数据 的 网络 传输 要求 ， 提出 利用 UDP 传输 协议 在 局域网 上 传输 视频 数据 的 方法 。 我们 使用 这一 方法 在 局域网 上 成功 地 实现 了 1 个 实时 视频 监视系统 。 在 此 系统 中 ， 中心 监视 站 同时 监视 4 个 现场 监视 站 。 试验 时 ， 选用 320 线 的 摄像机 ， 图像 捕捉 卡 设置 成 320 × 240 模式 ， 图像压缩 品质 设置 成 80 ， 经过 JPEG 压缩 后 ， 每帧 图像 大小 仅为 9KB 。 中心站 选用 Intel   P Ⅲ   450   CPU ， 128MB 内存 的 机器 ， 实际效果 可以 达到 15 ～ 20 帧 ／ 秒 。 由于 本 系统 使用 的 是 单帧 JPEG 图像 传送 方式 ， 因此 图像 传送 的 实时 效果 相当 好 ， 特别 适用 于 工业 监视 等 实时性 要求 比较 高 的 场合 ， 具有 较 好 的 实际 应用 前景 。 
 莫宁 （ 武汉 水利电力 大学 研 9703 班  430072 ） 
 俞宁 （ 武汉 水利电力 大学 研 9703 班  430072 ） 
 收稿 日期 ： １ ９ ９ ９ － １ １ － １ ８ 
