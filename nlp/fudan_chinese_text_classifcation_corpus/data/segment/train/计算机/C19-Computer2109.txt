计算机 工程 
 COMPUTER   ENGINEERING 
 1999 年   第 25 卷   第 12 期   vol.25   No.12   1999 
 
 
 
 计算机 传真 中 串行 通信 的 研究 与 实现 
 彭 爱国 　 李建华 
 　 　 在 现代 社会 中 ， 传真 传输 已 成为 远程 通信 领域 的 主要 工具 之一 ， 而 随着 计算机 通信 及 网络 技术 的 发展 , 传真 传输 不再 只 限于 专用 的 传真机 ， 事实上 ， 利用计算机 和 传真 调制解调器 实现 传真 功能 已经 得到 了 越来越 广泛 的 应用 。 
 　 　 设计 传真 软件 的 最 基本 也 是 最 关键 的 一部分 就是 串行 通信 ， 串行 通信 的 正确 与否 直接 关系 到 传真 是否 能 正确 接收 与 发送 。 
 1   计算机 传真 的 工作 原理 
 　 　 计算机 传真 的 基本 思想 是 在 串行 通信 的 基础 上 ， 利用计算机 、 Fax   Modem 和 电话 , 根据 T.30 和 T.4 两个 协议 来 模拟 传真机 ， 实现 所有 传真 功能 。 其中 T.30 为 传真 通信协议 ， 它 规定 了 一次 传真 会话 的 过程 ： 首先 ， 两个 调制解调器 将 建立 一个 在 PSTN 上 的 电话 连接 ； 然后 ， 通过 在 一个 300bps ( 可选为 2400bps ) 半双工 同步 连接 上 交换 HDLC 信息 帧 ， 这 两个 调制解调器 将 实现 一个 带 差错控制 的 T.30 " 会话 " ； 第三 ， 在 会 话 的 起始 部分 ， 两个 调制解调器 赞同 可 接受 的 参数 ， 这时 ， 发送 方将 发出 一个 高速 载波 脉冲 ， 以 验证 电话 线路 的 质量 ， 然后 ， 两个 调制解调器 都 将 切换 到 一个 高速 状态 ， 从而 以 半双工 方式 一次 一页 传输 图象 ； 第四 ， 在 每页 的 结束 处 ， 调制解调器 回到 一个 较 低速 ( 通常 为 300bps ) 会话 协议 ， 以 协商 下 一页 ( 如 有 必要 ， 也 可 协商 重发 上页 ) ； 最后 ， 当 无 更 多页 发送 时 ， 调制解调器 断 连 。 T.4 为 传真 图象 协议 ， 它 规定 了 T.30 中 阶段 C 中 数据 的 尺寸 和 编码 规范 ， 如 传真 文件 的 尺寸 、 扫描仪 / 打印机 的 分辨率 、 为 压缩 数据 而 采用 的 编码 算法 、 带行 同步序列 ， 即行 终码 EOL 、 阶段 C 的 带 内 转义序列 ， 即 返回 控制 信号 RTC ， 以及 适应 低速 输出设备 所 需要 的 填充 技术 等 。 
 2   传真 与 数据传输 的 差别 
 　 　 ( 1 )   传真 站 之间 传送 的 所有 数据 均 为 图象 数据 ， 在 交互式 对话 过程 中 传送 于主 系统 和 远 地 站 之间 。 
 　 　 ( 2 )   传输 单元 的 不同 。 在 XModem 或 YModem 协议 中 ， 包是 传输 单元 ， 而 在 传真 传输 中 ， 使用 的 术语 是 帧 或 HDLC ( 高级 数据链 路 控制 ) 帧 。 传真 数据 的 最小 单元 是 页 。 
 　 　 ( 3 )   数据通信 一般 是 面向 字节 进行 传输 的 ， 而 传真 传输 是 面向 比特流 的 ， 一页 上 描述 数据 的 信息 是 一系列 可变 长 的 位串 。 从 计算机 的 角度 来看 ， 这些 位串 是 被 当作 一系列 字节 来 接收 和 发送 的 ， 位串 的 每 一位 在 接收 时 都 要 被 解释 直到 它 在 T.4 描述 传真 数据 的 表中 遇到 某一 匹配 字串 时 为止 。 
 3   传真 中 串行 通信 的 几种 方法 
 　 　 利用 Fax   Modem   和 计算机 模拟 传真机 进行 传真 的 接收 与 发送 ， 是 在 串行 通信 的 基础 上 加上 对 Modem 的 操作 ， 根据 T.30 和 T.4 协议 来 实现 的 。 Windows 中有 以下 几种 常用 的 串行 通信 方法 ： 
 　 　 ( 1 )   查询 法 
 　 　 Windows   3.1 、 Win95 / 98 环境 下 的 查询 通信 方式 的 基本 编程 思想 基本一致 ， 采用 CPU 定时 查询 ， 检测 是否 接收 到 新 的 数据 或 数据 是否 发送 完毕 ， 其 基本 的 程序结构 如图 1 。 
 
 图 1 查询 方式 实现 传真 传输 框图 
 　 　 ( 2 )   利用 通信 控件 
 　 　 在 Windows3.1 下 ， VB3.0 提供 了 VBX 控件 MSCOMM . VBX ， VC1.0 / 1.5 的 类库 提供 了 CVBControl 类 ， 使得 应用程序 可以 方便 地 处理 VBX 控件 。   在 Win95 / 98 下 ， 从 VC2.0 起 ， 舍弃 了 VBX 控件 ， 逐步 由 OLE 控件 和 ActiveX 控件 取而代之 ， 与 通信 VBX 控件 MSCOMM . VBX 相对 应 通信 OLE 控件 为 MSCOMM16 . OCX ( 16 位 ) 和 MSCOMM32 . OCX ( 32 位 ) 。 
 　 　 ( 3 )   线程 事件驱动 方式 
 　 　 在 Windows   3.1 下 ， 当 设置 通信 事件 后 ， 每次 指定 的 通信 事件 发生 时 ， 通信 驱动程序 将 自动 向 应用程序 发送 通信 通知 消息 WM _ COMMNOTIFY ， 它 指示 了 一个 窗口 的 发送 和 接收缓冲区 的 状态 。   Win95 / 98 通信 机制 与 Windows3.1 有 很大 差异 ， 不再 有 WM _ COMMNOTIFY 通知 消息 ， 为了 实现 中断 通信 ， Win95 / 98 提供 了 线程 处理 方法 ， 使得 程序员 能够 完全 控制程序 片断 的 执行 ， 进行 实时 收发 数据 。 
 　 　 用 方法 1 实现 传真 通信 十分 简单 ， 但 耗时 、 效率 不高 ， 故此 方法 不能 做到 实时 收发 数据 ， 容易 引起 数据 的 丢失 。 方法 2 使用 通信 控件 ， 大大简化 了 通信 编程 ， 可 通过 其 提供 的 通信 事件 来 进行 实时 收发 数据 ， 并 提供 了 大量 的 属性 和 方法 ， 用于 普通 的 串行 通信 不失为 一种 较 好 的 方法 ， 但 该 方法 对 扩展 ASCII 字符 和 ASCII   0 ( 也 就是 该 字符 的 ASCII 值为 0 ) 的 传送 会 显得 力不从心 ， 不能 正确 完成 数据传输 ， 而 在 传真 应用程序 中 ， 传真 中 的 传输 单元 帧 中 的 许多 标志 字 有 的 就是 扩展 ASCII ， 传真 数据 是 图象 数据 经过 编码 之后 进行 传送 的 ， 是 一种 面向 比特流 的 数据 ， 因而 在 传送 的 数据 中 ， 是 会 经常 碰到 扩展 ASCII 字符 和 ASCII   0 的 ， 因而 这种 方法 也 不 适合 用于 串行 数据 的 传输 。 方法 3 克服 了 上述 几种 方法 的 不足 ， 具有 高效率 、 准确性 好 、 能 满足 传真 传输 的 基本 要求 。 
 4   线程 事件 方式 的 实现 
 　 　 在 Win95 / 98 环境 下 ， 线程 是 唯一 执行 单位 ， 是 Win32 为 程序 分配 CPU 时间 的 基本 实体 。 每个 正在 运行 的 应用程序 构成 一个 进程 ， 每个 进程 包括 一个 或 多个 线程 ， 各 线程 协同 完成 指定 操作 ， 应用程序 中 的 进程 是 作为 单独 的 线程 开始 它 的 生命期 的 。 MFC 将 执行 的 线程 封装 在 CWinThread 类中 ， 包括 创建 、 管理 和 删除 线程 的 一系列 成员 变量 和 成员 函数 。 
 　 　 线程 通信 方式 的 主要 思路 是 单独 创建 一个 通信线 程 ， 它 主要 实现 对 通信 事件 的 监视 ， 如 检测 重叠 I / O 操作 是否 完成 以及 是否 接收 到 新 的 数据 等 。 
 　 　 为了 便于 维护 ， 把 串口 通信 设计 成 一个 类 CCommCtrl ， 它 实现 了 诸如 打开 串口 、 配置 串口 、 向 串口 发送数据 、 关闭 串口 等 方法 ， 同时 还 完成 通信 事件 的 监视 。 
 　 　 当 进程 启动 之后 ， 首先 创建 主线 程 ， 然后 创建 通信线 程 ， 并 将 其 挂 起 ， 再 调用 类 CCommCtrl 中 的 成员 函数 完成 串口 的 初始化 、 创建 同步 对象 、 设置 事件 掩模 等 ， 然后 在 合适 的 时候 继续执行 通信线 程 ， 由 其 完成 通信 事件 的 监视 。 每当 有 通信 事件 时 ， 就 向 主线 程 发送 自定义 消息 。 图 2 是 主要 流程 。 
 
 
 图 2 线程 通信 实现 传真 输 流程图 
 　 　 ( 1 )   创建 线程   m _ commctrl   =   ( CCommCtrl * ) AfxBeginThread   ( RUNTIME _ CLASS ( CCommCtrl ) , THREAD _ PRIORITY _ NORMAL , 0 , REATE _ SUSPENDED ) ;   
 　 　 其中 m _ commctrl 为 CCommCtrl 对象 ， CCommCtrl 为 CWinThread 派生 对象 的 RUNTIME _ CLASS ， THREAD _ PRIORITY _ NORMAL 为 线程 的 优先级 ， CREATE _ SUSPENDED 表示 线程 的 创建 形式 为 挂 起 。 
 　 　 ( 2 )   打开 串口 和 配置 串口 
 　 　 1 ) 用 CreateFile 函数 打开 串口 资源 。 CreateFile 的 函数 原型 为 ：   
 　 　 HANDLE   CreateFile ( LPCTSTR   lpFileName ,   / / 指向 串名 的 指针 ， 如 " COM2 " ； DWORD   dwDesiredAccess ,   / / 访问 模式 ， 可以 有 是 读 或 写 或 都 是 ； DWORD   dwShareMode ,   / / 共享 模式 , 对于 通信 资源 ， 只能 为 0 ； LPSECURITY _ ATTRIBUTES   lpSecurityAttibutes ,   / / 指向 安全 模式 描述符 的 指针 ； DWORD   dwCreationDistribution ,   / / 对于 通信 资源 ， 它 必须 为 OPEN _ EXISTING ； DWORD   dwFlagsAndAttributes ,   / / 指定 属性 和 标志 ； HANDLE   hTemplateFile   / / 模板 文件 句柄 ， 对于 通信 资源 ， 必须 为 0 ) 
 　 　 如果 函数调用 成功 ， 则 返回 指定 通信 资源 的 一个 打开 的 句柄 ； 否则 返回 INVALID _ HANDLE _ VALUE 。 
 　 　 2 ) 用 GetCommState 函数 获取 串行 资源 的 当前 配置 ， 再 使用 SetCommState 函数 重新配置 串行 资源 各 参数 。 然后 再用 SetupComm 函数 来 设置 缓冲区 大小 。 
 　 　 3 ) 当 以上 都 完成 后 ， 就 可以 用 ReadFile 和 WriteFile 来 进行 串口 数据 的 读写 了 。 
 　 　 ( 3 ) 通信 事件 
 　 　 1 ) 设置 事件 掩模 
 　 　 通过 SetCommMask 函数 建立 事件 掩模 来 监视 指定 通信 资源 上 的 事件 ， 其 原型 为 : 
 　 　 BOOL   SetCommMask   ( HANDLE   hFile ,   / / 通信 设备 句柄 , 由 CreateFile 返回 ； DWORD   dwEvtMask   / / 被 监视 的 事件 ) 
 　 　 2 ) 监视 通信 事件 
 　 　 在 指定 被 监视 的 事件 掩模 之后 ， 进程 使用 WaitCommEvent 函数 等待 其中 一个 事件 发生 。 WaitCommEvent 的 原型 为 ： 
 　 　 BOOL   WaitCommEvent   (   HANDLE   hFile ,   / / 通信 设备 句柄 , 由 CreateFile 返回 ； LPDWORD   lpEvtMask ,   / / 指向 存放 当前 发生 事件 的 变量 ； LPOVERLAPPED   lpOverlapped   / /   指向 一个 LPOVERLAPPED 结构 ) 
 　 　 ( 4 ) 重叠 I / O 操作 
 　 　 重叠 操作 使得 线程 从 费时 的 I / O 操作 中 解脱 出来 ， 让 I / O 操作 在 后台 执行 ， 而 线程 可以 自由 执行 其它 任务 。 当 使用 重叠 操作 时 ， I / O 操作 不管 是否 完成 都 立即 返回 。 
 　 　 如果 要 想 通信 设备 能 执行 重叠 操作 ， 必须 在 使用 CreateFile 打开 通信 设备 时 ，   dwFlagsAndAttributes 参数 必须 指定 为 FILE _ FLAG _ OVERLAPPED 与 其它 标志 的 组合 。 同时 要 按 重叠 操作 执行 的 函数 ， 其 参数 中 必须 指定 指向 OVERLAPPED 结构 的 指针 ， 最后 ， OVERLAPPED 结构 必须 包含 手工 重置 事件 对象 。 
 5   结束语 
 　 　 利用 线程 事件 方式 来 实现 串行 通信 ， 能够 很 好地解决 传真 的 实时 接收 和 发送数据 ， 同时 也 能 保证 扩展 ASCII 字符 和 ASCII   0 的 正确 传输 ， 这种 方法 不仅 可以 用 在 传真 系统 中 ； 也 可用 在 那些 需要 实时 传输数据 的 串行 通信 场合 ， 如 监控 系统 ； 也 可用 在 文件传输 ， 尤其 是 所 传输 的 文件 是 图象 文件 等 其它 二进制 文件 。 
 作者 单位 ： 长沙 铁道 学院 信息技术 研究 中心 , 长沙 410075 
 参考文献 
 1   [ 日 ] 通信协议 手册 编委会 编 . 最新 网络通信 协议 手册 . 北京 ： 电子 工   业 出版社 , 1999 
 2   [ 美 ] Galtan   P   W . 精通 串行 通信 . 北京 ： 电子 工业 出版社 , 1994 
 3   [ 美 ] Holmes   M , Flanders   B . C++ 通信 实用程序 . 北京 ：   电子 工业 出   版社 , 1995 
 4   [ 美 ] Leinedker   R   C . Windows   98   编程 实用 大全 . 北京 ： 中国 水利 水   电 出版社 , 1999 
