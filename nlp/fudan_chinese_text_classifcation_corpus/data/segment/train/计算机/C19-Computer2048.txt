计算机 工程 
 Computer   Engineering 
 1999 年 　 第 25 卷 　 第 4 期 　 Vol.25 　 No.4 　 1999 
 
 
 
 基于 多线程 的 远程 数据库 电话 访问 系统 的 设计 与 实现 
 余华云 　 蔡莲红 　 张维 
 摘 　 要 　 介绍 了 基于 多线程 的 远程 数据库 电话 访问 系统 的 设计 与 实现 过程 。 并 对 影响 系统 生命力 的 各种因素 （ 如 ： 系统 的 可靠性 、 系统 的 可扩充性 和 系统 的 通用性 等 ） 进行 了 探讨 。 尤其 着重 对系统 的 通用性 进行 了 阐述 ， 使 系统 能力 为 不同 的 应用领域 服务 。 
 关键词 　 线程 　 电话 语音卡 　 公用电话 网 　 文语 转换 技术 
 Design   and   Realization   of   Telephone   Remote   Database   Access   System   Based   on   Multi - threads 
 Yu   Huayun 
 （ Computer   Control   Centre   of   Education   Academy   Jingzhou   434001 ） 
 Ca   Lianhong   Zhang   Wei 
 （ Department   of   Computer   Science   and   Technology ， Tsinghua   University   BeiJing   100084 ） 
 Abstract ： The   paper   introduces   design   and   realization   process   of   telephone   remote   database   access   system   based   on   threads   and   discuss   various   factor   affecting   system   life - time ， such   as   system   reliability ， extensity   and   universality   etc . Particularly   the   paper   discusses   universality   of   the   system , so   that   the   system   can   serve   in   many   application   fields . 
 Key   words : Thread ; Telephone   sound   card ; Public   telepone   not ; Convertion   technology   of   text   to   speech 
 　 　 电话 语音卡 自 1992 年 进入 我国 市场 以来 ， 其 应用 日益 广泛 ， 如 168 信息 台 、 200 长途 接线 、 114 电话号码 查询 等 各种 应用 系统 。 
 　 　 本文 所 介绍 的 基于 多线程 的 远程 数据库 电话 访问 系统 是 以 美国   Dialogic   公司 的 电话 语音卡 为 基础 、 以 Windows   NT 为 开发 平台 并 利用 Windows   NT 线程 的 特性 所 开发 的 一种 能 多线 并行 通信 且 适用性 很广 的 电脑 电话 语音 服务 系统 。 
 1 　 系统 组成 及 原理 
 1.1 系统 组成 结构 
 　 　 远程 数据库 电话 访问 系统 是 通过 电话 语音卡 将 计算机 和 公用电话 网 连接 在 一起 而 形成 的 系统 。 它 将 计算机 与 电话 的 优势 有机 地 结合 在 一起 ， 用 人们 最 熟悉 的 媒介 - - 声音 ， 通过 电话机 自动 储存 和 传递信息 ， 以 达到 从 远程 数据库 获取信息 的 目的 。 它 由 计算机 、 电话 语音卡 、 公用电话 网 、 电脑 及 相应 的 电话 语音 服务 软件 等 组成 ， 其 系统结构 见图 1 。 
 
 图 1 　 远程 数据库 电话 访问 系统 的 单 机型 结构 示意图 
 　 　 其中 ， 电话 语音卡 是 该 系统 的 重要 组成部分 ， 能够 实现 语音 处理 功能 。 常用 的 电话 语音卡 有 2 线 、 4 线 、 8 线 、 16 线 、 24 线 、 32 线及 T1 、 E1 - PCM 数字 中 接口 语音卡 以及 座席 转接卡 等 。 它 与 电话线 的 接口 主要 有 以下 3 种 ： 
 　 　 ( 1 ) 模拟 接口 　 主要 是 RJ - 11 接口 ， 它 允许 1 条 或 2 条 模拟 电话线 通过 RJ - 11 接口 直接 与 语音卡 相连 。 对于 允许 有 较 多 线路 的 语音卡 ， 可以 使用 扩展 接口板 ( 或称 电话 配线架 ) 再 与 语音卡 相连 。 
 　 　 ( 2 ) 数字 接口 　 如 数字 中继 E - 1 和 T - 1 。 
 　 　 ( 3 ) 总线 接口 　 语音卡 本身 没有 电话 的 接口 ， 需 额外 一块 卡 才能 与 电话线 相连 。 
 　 　 在 与 计算机 的 接口 方面 ， 语音卡 可以 十分 方便 地 直接 插 在 PC机 的 8 位 、 16 位 和 32 位 的 扩展槽 里 。 如果 实际 使用 的 线路 很多 ， 还 可以 在 一台 PC机 中 插 多块 语音卡 ( 如图 1 所示 ) 。 同时 ， 为了 使 系统 扩展 更 方便 、 应用 更 广泛 ， 本 系统 采用 了 网络系统 结构 ， 见图 2 。 
 
 图 2 　 远程 数据库 电话 访问 系统 的 网络结构 示意图 
 　 　 由于 系统 采用 网络结构 ， 用户 可以 通过 网络 访问 远程 服务器 中 的 数据 。 而 服务器 中 的 数据 也 可以 方便 地 通过 各个 业务 处理机 得到 更新 。 
 1.2 　 系统 工作 原理 
 　 　 此时 ， 图 1 或图 2 所示 系统 中 的 计算机 就 相当于 一部分 无人 值守 的 电话 。 用户 拨通 这部 电话 时 ， 电脑 语音 处理 系统 就 会 自动 地向 用户 提供 声讯 服务 。 用户 可以 根据 语音 提示 ， 通过 电话 按键 来 选择 所 需要 的 服务 。 计算机 则 根据 用户 的 选择 ， 相应 处理 并 完成 指定 的 功能 ， 并 将 结构 回 送给 用户 。 具体来说 ， 系统 工作 主要 包含 以下 几个 步骤 。 
 　 　 ( 1 ) 用户 来 话 呼叫 ( 即 用户 拨打 接入 多路 电话 语音 系统 的 电话号码 ) 进入 电话局 的 交换机 。 
 　 　 ( 2 ) 交换机 应答 该 呼叫 ， 接收 呼叫 到达 的 端口号 并 进行 主叫 和 被叫 号码 证实 。 
 　 　 ( 3 ) 当 呼叫 成功 应答 ， 并且 捕获 到 数字 后 ， 通过 交换机 的   RS - 232   串行口 向 被叫 方 ( 主机 ) 发送 消息 。 
 　 　 ( 4 ) 主机 检查 当时 各 语音卡 通道 的 状态 ， 选择 一个 空闲 的 信道 并 使 该 信道 处于 摘 机状态 。 此时 ， 主叫 方 ( 用户 ) 和 被叫 方 ( 计算机 ) 就 建立 了 直接 的 通信 连接 。 
 　 　 ( 5 ) 主叫 用户 可以 根据 计算机 的 语音 提示 ， 通过 电话 按键 来 选择 所 需 的 服务 。 
 　 　 ( 6 ) 计算机 则 根据 用户 的 选择 ， 进行 相应 处理 并 将 结果 回 送给 用户 。 
 　 　 ( 7 ) 当 主叫 用户 一方 挂机 时 ， 交换机 检测 拆线 信号 ， 并 向 主机 发送 端口号 等 信息 。 
 　 　 ( 8 ) 主机 程序 在 接收 到 该 消息 ， 将 语音卡 的 该 信道 置 为 挂机 状态 ， 并 等待 下 一个 用户 的 访问 。 
 2 　 系统软件 设计 与 实现 
 2.1 系统软件 设计 
 　 　 系统软件 在 设计 时 考虑 以下几点 ： ( 1 ) 软件 与 设备 的 无关 性 ； ( 2 ) 能够 满足 多个 用户 同时 访问 ( 即 多路 并行 ) ； ( 3 ) 应 具有 很 高 的 可靠性 和 可维护性 ； ( 4 ) 应 具有 较 好 的 通用性 且 易于 扩充 ； ( 5 ) 适用范围 广 。 
 　 　 为此 ， 系统 采用 模块化 的 程序设计 方法 ， 将 系统 功能 细 分成 不可分割 的 原子 动作 。 模块 之间 的 数据 传递 使用 函数 中 的 参数 进行 ， 因此 模块 之间 的 耦合度 较 低 ， 模块 之间 有 很 好 的 独立性 。 为了 满足 多个 用户 对系统 的 同时 访问 ， 系统 在 一个 进程 中 使用 了 多个 线程 ， 即 给 每 一个 通信线路 都 建立 一个 相应 的 线程 。 由于 在 Windows   NT 中 ， 线程 是 系统调度 和 运行 的 基本 单位 ， 拥有 自己 的 核心 栈 和 处理机 现场 。 当 主机 只有 一个 CPU 情况 下 ， CPU 对 线程 的 运行 是 按 时间 片 进行 轮询 的 ， 且 时间 片 的 长度 在 Windows   NT 设定 后 是 基本 不变 的 ( 一般 为 1 - 20ms ， 缺省值 为 10ms ) 。 但 这 并 不是 说 CPU 执行 每 一个 线程 的 时间 都 是 相同 的 。 当 执行 某 一线 程 的 时间 小于 时间 片 的 长度 时 ， 其 剩余 的 时间 自动 为 下 一个 线程 所 使用 。 这样 就 保证 CPU 能 高效 地 运作 ， 而 不至于 为 每 一个 线程 ( 即使 某些 线程 并 不 满足 启动 条件 ) 都 平均分配 一个 相同 的 执行 时间段 。 例 ： 本 系统 在 一个 进程 中 使用 了 64 个 线程 ， 实际 使用 时 ， 在 某 一 时刻 可能 只有 几个 线程 在 工作 ， 而 其它 大多数 线程 并 没有 被 访问 。 如果 强行 要 CPU 给 每个 线程 分配 相同 的 执行 时间 ， 很 显然 是 一种 浪费 。 只有 当 执行 每 一个 线程 所 需 的 时间 大于 或 等于 Windows   NT 系统 给定 的 时间 片时 ， 执行 每 一个 线程 的 时间 才 是 相等 的   (   即 等于 系统 给定 的 时间 片   )   。 因此 ， 时间 片 的 作用 实际上 是 为了 保证 让 CPU 能够 轮询 到 每 一个 线程 。 由于 轮询 的 时间 片 很 短 ， 一般 为 毫秒 级 ， 每 一个 线程 切换 的 延时 很 短 ， 只要 总 的 延时 不 超过 0.1 秒 ( 总 的 延时 与 CPU 的 速度 、 硬盘 存取速度 、 所接 的 线 数等 有关 ) ， 用户 是 觉察 不 出来 的 ， 因此 系统 完全 能够 满足 多个 用户 的 同时 访问 。 当 主机 中有 多个 CPU 时 ， 线程 还 可 自动 分布 到 各个 CPU 上 运行 ， 这 无疑 有利于 提高 系统 运行 速度 及 系统 的 扩充 。 同时 ， 由于 同一 任务 中 的 线程 共享 统一 的 地址 空间 ， 在 同一 任务 中 不同 线程 间 的 切换 相当 容易 且 线程 间 的 调度 开销 极小 ， 因此 系统 具有 响应速度 快 ， 资源 开销 小 的 特点 。 
 　 　 当然 ， 系统 中 所 拥有 的 线程 不能 太 多 。 因为 可 运行 的 线程 越 多 ， 对 所有 线程 轮询 一次 所 需 的 时间 越长 ， 系统 延时 越大 。 而且 线程 越 多 ， 整个 系统 的 吞吐量 将 相对 减少 ， 当 系统 总 的 延时 超过 一定 的 限制 时 ， 系统 将 变得 不可 使用 。 那么 ， 系统 到底 支持 多少 线数 呢 ? 这一 问题 是 很 难 准确 确定 的 。 因为 它 与   CPU   的 速度 、 硬盘 存取速度 、 平均 延时 、 数据 传输速度 、 PC 总线 速度 、 设备 驱动器 负载 等 多种 因素 有关 。 尽管如此 ， 这里 还是 给出 通过 程序 测试 系统 所 能 支持 的 并行 呼叫 线数 的 上限 估计值 ( 仅供 读者 参考 ) 。 例 ： 对于 PC486 / 66 、 硬盘 寻 道 时间 为 9ms 、 传输速率 为 819200B / s ， 对 语音 进行 8 比特 编码 、 8kHz 采样 的 计算机 来说 ， 系统 最大 支持 线数 为 102 线 。 因此 ， 对于 一般 的 中小 系统 而言 ， 目前 PC机 CPU 的 速度 是 完全 能够 胜任 的 。 
 　 　 由于 系统 要求 能 在 一天 24 小时 内 无间断 地 工作 ， 因此 系统 的 可靠性 和 可维护性 显得 特别 重要 。 为了 保证系统 的 可靠性 ， 除了 提高 系统 硬件 适应能力 ， 系统 在 设计 实现 时 ， 还 可以 动态 监视 每 一个 信道 的 状态 ， 以便 在 系统 出现 故障 时能 及时 进行 人工 维护 。 同时 ， 对系统 内存 的 管理 也 是 十分 重要 的 。 因为 如果 用户 对 某 一 信道 访问 后 ， 程序 没有 将 占用 的 内存 全部 及时 释放 ， 随着 时间 的 推移 ， 系统 内存 将会 被 占 满 而 使 整个 系统 无法 使用 。 
 　 　 为了 使 系统 具有 较 好 的 通用性 易于 扩充 ， 将 系统 设置 、 通信 信道 信号 检测 、 语音 处理 及 通信 等 功能 编制成 子程序 和 库函数 ， 供 系统 调用 。 同时 ， 为了 使 系统 具有 更 广泛 的 适用性 ， 避免 类似 程序 重复 开发 ， 系统 全部 语音 输出 采用 清华大学 计算机系 研制 的 文语 转换 技术 。 清华大学 计算机系 研制 的 文语 转换 系统 是 一个 无限 词汇 的 合成 系统 ， 即 按 规则 可 生成 任何 语句 而 不必 句句 录音 。 它 能 将 提供 的 文本文件 转换 为 语音 输出 且 系统 音质 清晰 ， 语句 自然 度高 。 它 不仅 解决 了 系统对 数据库 中 记录 的 语音 输出 问题 ， 而且 使 系统 具有 广泛 的 适用性 。 例 ： 从 一个 客运 信息 电话 语音 服务 系统 转变 到 一个 气象 电话 语音 服务 系统 ， 只 需 修改 本 系统 中 的 文本 提示信息 、 更改 数据库 的 内容 以及 对 各 模块 按 要求 进行 组织 即可 。 
 2.2 　 系统软件 组成 
 　 　 系统软件 主要 由 6 部分 组成 ： ( 1 ) 主控 程序 ； ( 2 ) 语音卡 驱动程序 ； ( 3 ) 多路 电话 语音 管理 子程序 ； ( 4 ) 多路 数据管理 与 通信 子程序 ； ( 5 )   数据库 信息 查询 程序 ； ( 6 ) 汉语 文语 转换 程序 。 
 　 　 主控 程序 主要 完成 对系统 进行 初始化 ， 监控 并 显示 系统 的 工作 状态 以及 对 异常情况 的 处理 等 功能 。 其 软件 流程 如图 3 所示 。 
 
 图 3 　 系统 主控 程序 
 语音卡 驱动程序 完成 对 电话 语音卡 的 驱动 和 控制 ， 是 硬件 与 软件系统 的 标准接口 ； 它 提供 的 驱动 函数 可 实现 摘 挂机 信号 检测 、 铃流 及 忙音 信号 检测 、 操作者 中断 、 DTMF 和 MF 信号 音 检测 、 录音 、 放音 及 录放音 出错 处理 、 录制 传真 数据 以及 向外 发传真 等 控制 管理 功能 。 
 　 　 多路 电话 语音 管理 子程序 采用 多线程 程序设计 ， 主要 负责 控制 管理 电话 语音卡 的 通信 信道 ， 以 并行 方式 执行 相应 的 电话 语音 通信 信道 管理 模块 。 它 可以 完成 振玲 摘机 ； 向 电话 使用者 发送 提示 语音 ； 接收 电话 使用者 拨入 的 请求 信息 ( 数字 ) ； 与 数据库 查询 系统 程序 进行 通信 ； 向 电话 使用者 回报 查询 的 语音 结果 以及 挂机 释放 信道 等 功能 。 它 是 远程 数据库 电话 访问 系统 的 核心 部分 ， 其 程序流程 如图 4 所示 。 
 
 图 4 　 信道 处理 子程序 
 　 　 多路 数据管理 与 通信 子程序 主要 完成 多路 电话 语音 管理系统 与 数据库 信息 查询 系统 之间 的 数据 信息 的 交换 、 管理 与 协调 ， 完成 数据通信 报文 的 发送 与 接收 等 功能 。 
 　 　 数据库 信息 查询 程序 主要 完成 用户 通过 电话 语音 管理系统 传来 的 请求 并 根据 用户 的 请求 查找 出 相应 的 结果 ， 再 将 结果 转换 为 文本 信息 供 多路 数据管理 与 通信 子程序 调用 等 功能 。 同时 ， 为了 进一步提高 系统 的 通用性 ， 数据库 信息 查询 程序 采用 了 微软公司 的 SQL   Server6.5 作 开发 平台 。 因为 SQL   Server6.5 不仅 提供 了 完整 的 客户 / 服务器 的 开发 环境 ， 而且 提供 了 对 多种 数据库 的 访问 工具 - - ODBC 。 通过 ODBC ， 我们 可以 实现 对 多种 数据库 的 访问 。 如 ： Foxbase 、 Foxpro 、 Access 、 Sybase 、 Oracle 、 Informix 等 。 由于 系统 提供 了 对 多种 数据库 的 访问 接口 ， 因此 系统 在 使用 时 即使 数据库 的 类型 有所 改变 ， 也 无需 另外 编程 。 
 　 　 汉语 文语 转换 程序 是 在 多路 数据管理 与 通信 子程序 中 负责 将 数据库 信息 查询 系统 所 传来 的 文本 信息 转变成 语音 ， 再 通过 电话 语音 系统 将 语音 播放 给 用户 。 
 3 　   结束语 
 　 　 几年 来 ， 以 电话 语音卡 为 基础 开发 的 各种 电脑 电话 语音 服务 系统 虽然 层出不穷 ， 但 这些 系统 普遍存在 应用领域 单一 ( 即 一个 系统 不能 为 多个 领域 所 使用 ， 在 用于 其它 领域 时 一般 需要 重新 开发 ) 、 扩充性 较差 的 缺点 。 本文 介绍 的 基于 多线程 的 远程 数据库 电话 访问 系统 具有 扩充性 好 ， 适用性 广 的 特点 。 系统 在 扩充 时 无需 作 任何 改动 ， 它会 根据 所 插 的 电话 语音卡 数量 及 语音卡 所 允许 的 最大 通信 信道 自动 改变 。 由于 系统 将 系统 功能 进行 了 细分 且 将 这些 功能 编制成 一个个 函数 供 系统 调用 ， 同时 系统 语音 输出 全部 使用 合成 语音 输出 ， 使 系统 在 无需 很大 改动 的 情况 下 就 可 适应 不同 的 应用领域 ( 如 ： 语音信箱 、 人才交流 、 气象 服务 、 客运 信息 、 高考 放榜 等 ) ， 因此 该 系统 是 一种 以 电话 语音卡 为 基础 ， 为 用户 提供 对 远程 数据库 电话 访问 的 综合 的 电脑 电话 语音 服务 系统 。 
 作者简介 ： 男 ， 30 岁 ， 讲师 ， 主要 研究 方向 为 语音 信息处理 及 多媒体 信息处理 
 作者 单位 : 余华云 　 湖北省 荆州 教育 学院 计算机 管理中心 　 荆州 434001 ， 蔡莲红 　 张维 　 清华大学 计算机科学 与 技术 系 　 北京 100084 
 参考文献 
 　 1 　 Dialogic . System   Release   Software   Installation   Reference   for   Windows   NT.1995 - 04 
 　 2 　 Dialogic . Voice   Software   Reference   for   Windows   NT.1995 - 12 
 　 3 　 Dialogic . Products   and   Services   Guide   1996.1996 - 05 
 　 4 　 张 延平 ， 林 博文 . 计算机 语音 集成 技术 和 应用 . 北京邮电大学 ， 1997 - 07 ： 33 - 36 ， 292 
 收稿 日期 : 1998 - 06 - 05 
