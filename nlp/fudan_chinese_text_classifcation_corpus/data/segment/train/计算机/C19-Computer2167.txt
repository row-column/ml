计算机 应用 研究 
 APPLICATION   RESERCH   OF   COMPUTERS 
 2000     Vol.17 　 No.1 　 P.102 - 103 
 
 
 
 
 基于 ActiveX 的 多通道 数据 曲线 编辑 控件 的 实现 
 彭莉辉 　 吴鸿修 
 摘   要   提出 了 基于 ActiveX 的 多通道 数据 曲线 编辑 控件 的 设计 思想 ， 并 详细 讨论 了 其 具体 实现 方法 ， 同时 给出 了 该 控件 的 应用 实例 ， 说明 了 使用 该 控件 的 优越性 。 
 关键词   ActiveX   控件   多通道 数据 曲线 
 1   引言 
 　 　 随着 计算机 软 、 硬件 技术 的 迅速 发展 ， 越来越 多 的 用户 开始 使用 计算机 来 观察 和 处理 数据 。 在 常见 的 各种 数据 采集 装置 中 ， 最后 得到 的 数据 通常 是 以 16 位 二进制 的 格式 存放 在 一个 纯 文本 的 文件 中 。 众所周知 ， 人 的 大脑 在 图形 识别 方面 特别 敏感 ， 当 数据 以 图形 形式 显示 时 ， 用户 可以 很快 地 从中 提取 所 需 的 信息 。 对于 数据 的 曲线 显示 与 编辑 的 要求 也 应运而生 ， 同时 也 出现 了 一些 相关 的 控件 ， 但 这些 控件 通常 没有 考虑 到 来自 多个 通道 的 数据 曲线 显示 问题 ， 也 没有 提供 标尺 ， 而 在 实际 应用 中 ， 这些 对于 用户 都 是 非常 重要 的 。 如 我们 在 研究 大脑神经 网络 时 ， 就 需要 一个 能 显示 、 分析 多通道 数据 的 控件 。 本文 将 详细 讨论 一个 基于 ActiveX 的 数据 曲线 编辑 控件 LabCurve . ocx 的 具体 实现 方法 。 
 2   ActiveX 控件 
 　 　 ActiveX 是 一种 标准 ， 利用 这个 标准 可以 使 通过 不同 语言 开发 的 软件 构件 在 单机 或 网络 环境 中 相互 操作 。 同时 ， ActiveX 也 是 以 组件 对象 模型 为 基础 的 开放 技术 的 集合 ， 它 代表 了 应用程序 与 Internet 的 一种 集成 策略 。 ActiveX 组件 最 常用 的 有 三种 ： 控件 ( Control ) 、 自动化 服务器 ( Automation   Server ) 和 文档 ( Document ) 。 ActiveX 控件 作为 一种 可 重用 的 组件 ， 相当于 一个 封装 好 的 代码 模块 ， 通过 其 方法 、 属性 、 事件 与 应用程序 进行 通信 。 ActiveX 控件 是 一种 特殊 的 OLE 控件 ， 它 不仅 可以 在 支持 OLE 控件 的 容器 中 使用 ， 更 可以 作为 一个 Internet 控件 ， 直接 成为 网页 的 一部分 。 ActiveX 控件 的 开发 可以 用 各种 语言 ， 如 ： VB 、 VC 等 ， ActiveX 控件 的 使用 也 可以 是 不同 的 语言 和 工具 ， 如 Delphi 、 IE 等 。 
 3   控件 的 主要 功能 
 3.1   数据 的 采集 
 　 　 不管 所用 的 数据 采集 装置 为 何种 ， 只要 数据 采集 装置 通过 与 硬件 相配套 的 软件 将 数据 存放 在 一个 缓冲区 ， 即可 调用 Record 方法 将 数据 保存 在 所选 的 文件 中 。 数据文件 以 16 位 二进制 的 格式 存放 所 采集 到 的 数据 ， 为 保持 控件 的 通用性 ， 文件 中 并 不 包含 通道 数等 与 采集 相关 的 信息 。 
 3.2   数据 的 波形 显示 
 　 　 用户 可以 根据 自己 的 研究 需要 ， 动态 调整 实际 显示 的 通道 数 。 并 可 将 不同 通道 的 数据 的 幅度 以 不同 的 比例 缩放 ， 在 不同 的 幅度 范围 内 观察 。 基于 数据 是 多通道 同时 采集 的 ， 为 方便 研究 数据 的 时间 相关性 ， 所有 通道 均 以 相同 的 时间 比例 显示 相同 时间 区域 的 数据 。 当然 ， 显示 时间 比例 和 时间 区域 都 是 可调 的 。 为 突出 观察 某些 重要 通道 ， 还 可 调整 每一 通道 的 显示 区域 大小 。 同时 ， 还 可 动态 调整 整个 控件 窗口 的 尺寸 大小 ， 便于 来自 不同 文件 的 数据 进行 比较 。 
 　 　 为 使 数据 的 观察 与 分析 更加 直观 ， 在 显示 区里 ， 添加 了 两个 标尺 。 每个 标尺 都 带有 一个 可 上下 拖动 的 文本框 ， 可 左右 拖动 标尺 。 从 标尺 的 文本框 中 迅速 得到 任意 一点 所在 的 时间 和 幅度 大小 ， 并 可 通过 两个 标尺 进行 简单 的 数据分析 ， 例如 通过 两个 标尺 的 时间差 和 两个 标尺 间 的 周期 数 得到 两个 标尺 间 数据 的 频率 。 同时 ， 还 可以 通过 标尺 的 小 横线 直观 看出 所在 点 幅度 在 整个 曲线 幅度 中所处 位置 。 
 3.3   数据 的 编辑 
 　 　 用户 可以 随时 将 两个 标尺 移 到 当前 的 显示 区域 ， 也 可 迅速 将 曲线 恢复 最初 的 显示 比例 。 我们 还 提供 了 将 鼠标 所 选择 的 区域 进行 数据 曲线 的 剪切 、 复制 和 粘贴 的 功能 。 另外 ， 还 提供 了 曲线 波形 的 打印 功能 ， 可 将 数据 曲线 按 当前 的 显示 比例 打印 出来 ， 以 方便 进一步 地 分析 与 研究 。 
 4   基于 ActiveX 的 实现 
 　 　 V C++ 5.0 提供 了 四种 开发 ActiveX 的 选择 ： MFC 、 ActiveX 模板 库 、 BaseControl 框架 和 建立 自己 的 框架 。 最 简便 快捷 的 便是 使用 MFC ， 只 需 从 File 菜单中选择 New 命令 打开 New 对话 ， 在 Projects 选项卡 中 单击 代表 MFC   ActiveX   Control   Wizard 的 图标 。 在 后续 步骤 中 ， 默认 其 选择 ， Control   Wizard 提问 完毕 后 ， 基本 的 框架 代码 已经 生成 。 
 　 　 然而 ， 我们 还 需要 为 控件 添加 属性 、 方法 和 消息 处理程序 函数 ， 以 实现 所 要求 的 功能 。 属性 是 控件 和 包 容器 内部 的 公共数据 ， 它 可以 用来 向 对方 描述 自己 。 包 容器 可以 读取 该 控件 的 属性 ， 来 了解 它 当前 的 状态 ， 如果 控件 允许 的话 ， 还 可以 重写 属性 ， 以 改变 控件 的 行为 。 LabCurve 的 属性 大部分 为 自定义 属性 。 所谓 自定义 属性 就是 控件 设计者 想 展现 给 包 容器 的 数据 。 包 容器 通过 调用 MFC 中 作为 Get 和 Set 方法 的 函数 来 读写 控件 的 属性 ， 这些 方法 是 由 该 控件 导出 的 。 用户 在 按 鼠标 右键 所弹 出 的 对话框 中 可以 读取 或 改变 相应 权限 的 LabCurve 的 自定义 属性 。 方法 为 ActiveX 控件 展现 给 包 容器 应用程序 的 函数 ， 允许 客户 调用 。 消息 处理函数 完成 了 对外部 动作 的 反应 和 控件 的 绘制 ， 是 整个 控件 的 核心 部分 。 
 4.1   数据 采集 的 实现 
 　 　 在 Windows 环境 下 ， 由于 Windows 的 多任务 性 和 数据 采集 的 速度 要求 ， 同时 考虑 到 当 掉电 时 ， 所 采集 到 的 数据 不 应 丢失 ， 数据 的 采集 应 使用 多线程 。 也就是说 在 一个 线程 中 ， 通过 与 采集 硬件 相配套 的 软件 将 数据 存放 在 一个 缓冲区 ， 在 另 一个 线程 中 调用 LabCurve 的 Record 方法 将 数据 保存 在 所选 的 文件 中 。 文件名 由 FileName 属性 决定 。 文件 中 的 数据 依次 来自 各 通道 ， 例如 ， 采集 通道 0 至 通道 2 的 数据 ， 则 文件 中 的 数据 依次 来自 通道 ： 0 、 1 、 2 、 0 、 1 、 2 、 0 ...... 。 
 4.2   多通道 数据 波形 显示 的 实现 
 　 　 由于 文件 中 并 不 包含 与 采集 相关 的 信息 ， 因此 需要 设置 通道 数 、 采样 频率 和 各 通道 的 增益 大小 ， 即 通过 改变 控件 的 属性 nChannelNum 、 nSampleFre 和 nGain ， 达到 使 控件 能 正确 地 从文件 中 读取 和 显示信息 的 目的 。 为 突出重点 ， 用户 还 可 改变 nChannelDisp 属性 ， 以 动态 调整 通道 的 显示 数目 。 
 　 　 在 控件 内部 ， 定义 了 n 个 数组 ( n = nChannelNum ) 。 每个 数组 依 通道 数 轮流 从文件 中 读取数据 ， 代表 来自 于 一个 通道 的 数据 。 所 读取数据 在 文件 中 的 位置 由 当前 显示 的 时间 区域 决定 ， 即 由 XLeftLimit 和 XRightLimit 属性 决定 。 
 　 　 为了 使 不同 通道 的 数据 的 幅度 可以 按 不同 的 比例 缩放 ， 在 不同 的 幅度 范围 内 观察 。 在 控件 内部 ， 每个 通道 都 有 一个 有关 幅度 显示 区域 的 SCROLLINFO 类型 和 有关 幅度 缩放 比例 的 成员 变量 。 当 用户 改变 某一 通道 的 YTopLimit ( Y 轴 顶端 幅度 ) 、 YBottomLimit ( Y 轴 底端 幅度 ) 属性 ， 或 按动 垂直 滚动条 和 垂直 拉缩钮 ， 就 会 引起 相应 通道 变量 的 变化 ， 从而 使 显示 达到 所 需 要求 。 
 　 　 基于 所有 通道 均 以 相同 的 时间 比例 显示 相同 时间 区域 的 数据 。 控件 内部 只有 一个 有关 时间 显示 区域 的 SCROLLINFO 类型 和 有关 时间 缩放 比例 的 变量 成员 。 用户 改变 XLeftLimit 、 YRightLimit 属性 ， 或 按动 水平 滚动条 和 水平 拉缩钮 ， 即会 引起 这些 变量 的 相应 变化 ， 从而 使 显示 达到 所 需 要求 。 
 　 　 为 调整 整个 控件 窗口 的 尺寸 大小 ， 在 控件 中 构造 了 一个 具有 SBS _ SIZEBOX 样式 的 特殊 滚动条 ， 并 对 WM _ SIZE 消息 进行 了 处理 。 当父 窗口 尺寸 大小 改变 时 ， 也 可 调用 控件 的 Size 方法 使 控件 窗口 的 大小 作出 相应 变化 。 
 　 　 通过 有关 标尺 的 属性 和 nActiveChannel ( 当前 通道 ) 属性 以及 对 鼠标 消息 的 处理 ， 使 标尺 能 对 用户 动作 作出 正确 反应 。 
 　 　 采用 对 WM _ SETCURSOR 消息 进行 处理 的 方法 ， 使得 当 拖动 标尺 、 改变 显示 区域 大小 、 改变 控件 窗口 大 小时 ， 鼠标 形状 都 会 相应 改变 。 
 　 　 用户 还 可以 根据 自己 的 喜好 ， 改变 有关 颜色 、 字体 和 X - Y 轴 坐标 显示 等 属性 ， 调整 控件 的 外观 显示 。 
 4.3   数据 曲线 编辑 的 实现 
 　 　 在 进行 数据 曲线 的 剪切 、 复制 、 粘贴 时 ， 使用 了 Windows 的 剪贴板 。 应 注意 如果 位图 被 选进 设备 环境 中 ， 那么 它 就 不能 再 被 送到 剪贴板 中 。 在 此 ， 我们 使用 了 两个 位 图 解决 了 这 一 问题 。 
 　 　 我们 对 OnDraw ( ) 和 OnPaint ( ) 函数 都 重新 进行 了 设计 ， 在 控件 的 Print 方法 和 OnPaint ( ) 函数 中 都 调用 了 OnDraw ( ) 函数 ， 使得 数据 曲线 按 当前 的 显示 比例 打印 出来 。 
 5   应用 实例 
 　 　 我们 使用 V C++ 5 ， 利用 LabCurve . ocx 完成 了 一个 神经网络 电 生理 信息 采集 与 分析 系统 。 如图所示 ， 窗口 的 中间 即为 LabCurve 控件 。 此 系统 完成 了 神经网络 电 生理 信息 的 采集 、 保存 、 显示 和 一系列 的 分析 。 由于 使用 了 LabCurve 控件 ， 省去 了 一些 繁琐 的 工作 ， 使 整个 结构 显得 相当 明 了 。 我们 所 开发 的 细胞 图象 分析 系统 、 膜片钳 系统 都 采用 了 这个 控件 ， 有效 提高 了 工作效率 ， 缩短 了 整个 开发 过程 。 
 
 6   结束语 
 　 　 本文 详细 介绍 了 基于 ActiveX 的 多通道 数据 曲线 编辑 控件 LabCurve . ocx 的 实现 方法 ， 并 给出 了 其 应用 实例 。 ActiveX 控件 作为 可 重用 代码 组件 ， 不仅 应用 广泛 ， 还 可 节约 开发 时间 。 ActiveX 控件 将 大量 的 细节 隐藏 起来 ， 以 简明 的 接口 与 用户 交互 ， 易于 使用 。 对 ActiveX 技术 的 研究 将 成为 新 的 热点 和 潮流 。 
 彭莉辉 （ 华中理工大学 控制 科学 与 工程系   武汉   430074 ） 
 吴鸿修 （ 华中理工大学 控制 科学 与 工程系   武汉   430074 ） 
 参考文献 
 1 ， Beck   Zaratian .   Microsoft   Visual   C++ 6.0 程序员 指南 .   北京 ： 希望 电脑公司 ,   1998 
 2 ， Jerry   Anderson .   Visual   C++ 5   ActiveX 编程 指南 .   北京 ： 清华大学出版社 ,   1998 
 3 ， Peter   Norton ,   Rob   McGregor .   MFC 开发 Windows   95 / NT   4 应用程序 .   北京 ： 清华大学出版社 ,   1998 
 收稿 日期 ： 1999 年 7 月 26 日 
