微型机 与 应用 
 MICROCOMPUTER   &   ITS   APPLICATIONS 
 2000 　 Vol.19 　 No.6 　 P.41 - 43 
 
 
 
 
 用于 电器 商品 安全 检验 的 Windows 数据 采集 系统 
 钟冠平 　 徐玉霖 
 摘要 ： 在 Windows 环境 下 ， 把 电器 商品 安全 检测 的 模拟信号 波形 采集 输入 微机 ， 对 波形 进行 显示 、 存储 、 打印 的 软硬件 设计 方法 。 
 关键词 ： 电器 安全 检验   波形 显示   漏 电流 
 　 　 机电类 商品 的 安全 检测 是 各国 都 强制性 执行 的 法定 项目 ， 其中 要求 绝缘 强度 必须 经受 高压 试验 而 不 击穿 ， 试验 通过 的 电流 峰值 不 超过 通常 人体 能 承受 的 电流 。 如 对于 带 保护 接地 端的 电器 ， 其 试验 的 高压 为 交流 50Hz 、 有效值 为 1500V ， 限定 的 试验 电流 峰值 不得 超过 10mA ， 持续时间 1min 。 
 　 　 通常 以 专用 的 高压 仪来 测试 ， 高压 仪 可以 输出 高压 ， 加 在 电器 需要 绝缘 隔离 的 二端 ， 并且 检测 回路 的 电流 ， 当 电流 峰值 超过 限定值 时 ， 切断 高压 输出 ， 并 作出 不 合格 判定 。 因为 高压 试验 的 波形 特征 复杂 、 不规则 ， 有 的 绝缘材料 没有 重复性 现象 ， 如 第 1 次 击穿 后 第 2 次 不再 击穿 ， 或 第 1 次 击穿 后 第 2 次 击穿 得 更 严重 ， 或 出现 飞弧 、 闪烁 。 用 普通 示波器 无法 观察 、 保留 波形 ， 而 存储 示波器 价格昂贵 ， 也 难以 保存 长时间 的 波形 数据 。 
 　 　 据此 ， 笔者 在 计算机 Windows 环境 下 ， 用 多媒体 声卡 及 Borland   C ＋ ＋ 编程 ， 设计 了 一 微机 模拟信号 采集 系统 ， 方便 了 上述 问题 的 分析 和 解决 。 经过 半年 的 应用 ， 效果 良好 。 该 系统 能 把 安全 测试 波形 的 模拟量 采集 送入 微机 ， 进行 显示 、 存储 、 打印 等 操作 ， 显示 波形 可 在 大 范围 内 缩放 ， 刻度 清楚 。 该 系统 与 通常 的 存储 示波器 相比 ， 有 记录 容量 大 、 方便 保存 拷贝 、 价格低 的 优点 。 
 1     关键技术 及 运行机制 
 　 　 本 系统 利用 目前 广泛 使用 的 声卡 作为 A ／ D 转换 工具 ， 经过 衰减 和 取样 电路 得到 的 模拟信号 送 至 声卡 的 线路 输入 端 Line   in ， A ／ D 转换 结果 在 Windows 管理 下 送入 微机 ， 测试 过程 中 可以 观察 波形 。 
 　 　 应用程序 采用 Windows 下 的 Borland   C ＋ ＋ 编写 。 在 开发 声卡 的 Windows 程序 时 ， 最 简单 的 方法 是 利用 媒体 控制 高层 调用 接口 。 高层 调用 封装 了 对 硬件 设备 操作 的 许多 细节 ， 编程 者 可以 采用 它 的 结果 ， 但 无法 改动 其中 的 细节 以 满足 自身 程序 的 需要 ， 例如 对 采集 数据 进行 实时处理 、 加工 等 。 要 解决 这一 问题 ， 必须 采用 能 控制 硬件 细节 的 低层 调用 技术 ， 并且 在 数据 输入 过程 中 ， 采用 双 缓冲 技术 ， 以便 使 输入 数据流 连续 而 不 丢失 。 双 缓冲 技术 是 指 二个 缓冲区 轮流 接收 输入 数据流 ， 当 一个 缓冲区 填满 数据 时 ， 交给 应用程序 进行 处理 ， 同时 另 一个 缓冲区 接收 输入 数据流 ， 二者 轮流 进行 ， 不断 循环 。 
 　 　 应用 程序处理 的 数据量 很大 ， 它 是 以 数据 块 为 单位 ， 把 分配 好 的 空 内存 块 交给 声卡 设备 ， 内存 块 的 地址 、 大小 、 信息格式 必须 由 应用程序 指定 。 当 采集 数据 填满 数据 块 时 ， 设备 送 1 个 消息 或 触发 事件 通知 应用程序 ， 应用程序 提交 另 一个 空 内存 块 给 设备 并 对 数据 进行 处理 。 声卡 设备 通知 应用程序 的 消息 或 事件 有 4 种 方式 ， 本 应用程序 采用 给 设备 指定 1 个 窗口 的 方法 ， 当 设备 用 完 数据 块 、 打开 或 关闭 时 ， 把 消息 发送给 窗口 。 
 2     硬件 电路 的 设计 与 连接 
 　 　 下面 说明 高压 试验 过程 中 ， 观察 回路 漏 电流 波形 的 电路设计 和 连接 方法 。 
 　 　 高压 试验 的 漏 电流 一般 为 几 mA ， 有时 会 达到 几十 mA ， 多数 安全 标准规定 判定 上限 为 10mA ， 高压 仪中 可 设定 的 判定 电流 从 0.5 至 100mA 。 
 　 　 微机 采集 信号 声卡 线性 输入 端 Line   in 适合 的 输入 峰 － 峰 电压 为 3V ， 输入阻抗 大于 1K Ω 。 
 　 　 设计 原则 为 ： 采集 信号 的 一端 必须 为 高压 仪 的 保护地 ， 取样 电路 的 接入 不 影响 高压 测试 ( 不 明显 改变 回路 电阻 、 允许 通过 较 宽 的 漏 电流 范围 使 击穿 现象 正常 发生 ) ， 微机 采集 线路 的 接入 不 影响 取样 电路 ， 取样 电路 的 电压 范围 适合 于 微机 采集 信号 输入 端 。 
 　 　 根据 欧姆 定理 ， 当取峰 － 峰 电压 V ＝ 0.1 V ， I ＝ 10mA 时 ， 得出 R ＝ 10 Ω ； 当取峰 － 峰 电压 V ＝ 0.1 V ， I ＝ 100mA 时 ， 得出 R ＝ 1 Ω 。 10 Ω 的 电阻 对 几兆 的 高压 测试 回路 来说 可以 忽略不计 。 当漏 电流 取 100mA 时 ， 电阻 R 应 承受 的 功率 为 P ＝ I2R ＝ 0.1 × 0.1 × 10 ＝ 0.1 W ， 选取 功率 为 5W 的 电阻 ， 以 保证 其 承受能力 。 取样 电路 在 漏 电流 为 100mA ， R ＝ 10 Ω 时 ， 峰 － 峰 电压 为 2V ， 其 电压 范围 适合 微机 采集 信号 输入 端 。 
 　 　 测试 漏 电流 波形 的 硬件 电路 连接 方法 如图 1 所示 。 
 
 图 1     测试 漏 电流 波形 的 电路 连接 图 
 3     软件系统 的 设计 与 实现 
 　 　 本 系统 的 软件开发 在 Borland   C ＋ ＋   5.0   for   Windows 下 进行 ， 其 使用 环境 必须 是 Windows   95 、 98 或 以上 操作系统 ， 系统 必须 安装 声卡 。 
 软件开发 使用 对象 Windows 库 ( 即 OWL ) 生成 程序 框架 ， 使用 类 、 低层 代码 调用 及 一些 必要 的 API 完成 本 软件 的 应用 功能 的 编程 ， 下面 主要 介绍 程序 的 功能 实现 部分 ， 以 说明 设计 方法 。 程序 的 主要 功能 由 mmshlwnd . h 和 mmshlwnd . cpp 完成 ， 为了 使用 多媒体 的 低层 调用 技术 ， 在 程序 的 头文件 中 必须 包含 mmsystem . h 文件 。 
 　 　 文件 mmshlwnd . cpp 按 以下 方法 实现 存储 示波器 的 功能 。 在 消息 响应 表中 加入 用户 命令 ， 如 启动 示波器 输入 、 停止 示波器 输入 、 保存 文件 、 打开 文件 显示 、 打印 、 打印机 设置 等 消息 响应函数 ， 以及 设备 发送 的 消息 ， 如 打开 设备 、 数据 输入 满 、 关闭 设备 等 处理函数 。 
 　 　 在 启动 示波器 输入 的 响应函数 中 ， 首先 在 内存 中 开辟 1 个 长度 为 MAXSIZEOFDATA 的 采集 数据 缓冲区 ， 并 清除 其中 内容 ， 分配 和 建立 信息格式 块 ， 打开 声卡 设备 ， 分配 和 传递 1 个 数据 块 ( 长度 为 VIEWBLOCK ) 给 设备 ， 启动 数据 采集 ， 同时 分配 和 传递 第 2 个 数据 块 给 设备 ， 使 其 在 第 1 个 数据 块 之后 等待 ， 当 第 1 个 采集 数据 块 填满 时 ， 设备 会 发送 消息 给 窗口 ， 同时 第 2 个 数据 块 进入 接收数据 的 工作 。 应用程序 收到 消息 后 必须 马上 取回 数据 块 并 进行 数据处理 。 
 　 　 常量 宏 定义 放在 头文件 中 ： 
 ＃ define   MAXSIZEOFDATA     常量 1 
 ＃ define   VIEWBLOCK           常量 2 
 　 　 CPP 的 实现 过程 如下 ： 
 void   TMmshelWindow : : CmScopein ( ) 
 ｛ 
 　 ／ ／ INSERT ＞ ＞ Your   code   here . 
 　 分配 MAXSIZEOFDATA 缓冲区 ； 
 　 清除 显示 数据 缓冲区 ； 
 　 设置 输入 数据 的 信息格式 ； 
 　 打开 输入 设备 ； 
 　 为 第一 数据 块 分配内存 VIEWBLOCK ， 并 得到 其首 地址 指针 ； 
 　 为 第二 数据 块 分配内存 VIEWBLOCK ， 并 得到 其首 地址 指针 ； 
 　 准备 和 传递 第一个 数据 块 给 设备 ； 
 　 开始 输入 数据 ； 
 　 准备 和 传递 第二个 数据 块 给 设备 ； 
 　 启动 数据处理 程序 ， 保存 数据 ； 
 　 开始 在 屏幕显示 波形 ； 
 ｝ 
 　 　 其中 的 内存 分配 、 数据处理 和 波形 显示 等 使用 OWL 和 API 进行 编程 ， 与 声卡 设备 有关 的 编程 使用 低层 代码 调用 。 停止 示波器 输入 的 响应函数 包括 停止 输入 数据 、 清理 数据 、 释放 内存 、 关闭 输入 设备 和 保存 数据 至 磁盘 文件 中等 ， 如下 所示 ： 
 void   TMmshelWindow : : CmScopestop ( ) 
 ｛ 
 　 ／ ／ INSERT ＞ ＞ Your   code   here . 
 　 停止 输入 数据 ； 
 　 复位 数据 块 ； 
 　 撤销 数据 块 的 准备 ； 
 　 关闭 设备 ； 
 　 读取数据 并 释放 内存 ； 
 　 打开 保存 文件 对话框 ， 取得 文件名 ； 
 　 保存 文件 ； 
 　 … … 
 } 
 　 　 单个 数据 块 装满 数据 时 ， 设备 会 发送 消息 给 窗口 ， 应用程序 必须 取出 数据 ， 更换 空 数据 块 给 设备 ， 其 响应函数 如下 所示 ： 
 void   TMmshelWindow : : MmWimDataFull ( ) 
 { 
 　 ／ ／ INSERT ＞ ＞ Your   code   here . 
 　 撤销 数据 块 的 准备 ； 
 　 取回 数据 块 ； 
 　 读取数据 并 移至 MAXSIZEOFDATA 显示 缓冲区 ； 
 　 数据 块 清空 后 还给 设备 ； 
 ｝ 
 　 　 波形 显示 、 保存 文件 和 打印 波形 的 响应函数 与 一般 OWL 、 API 应用程序 类似 ， 为 节省 篇幅 ， 以上 只 叙述 本 软件 实现 的 主要 思想 方法 及 低层 调用 方式 。 
 4     试验 效果 
 　 　 ( 1 ) 合格 样品 的 漏 电流 波形 
 　 　 图 2 所示 为 1 台 合格 的 电视机 高压 试验 漏 电流 波形 ， 
 用于 电器 商品 安全 检验 的 Windows 
 数据 采集 系统 它 也 是 交流 50Hz ， 但 已经 不是 正弦波 ， 其 峰值 为 4.7 mA 。 
 
 图 2     合格 的 电视机 高压 试验 漏 电流 波形 
 　 　 ( 2 ) 不 合格 样品 的 漏 电流 波形 
 　 　 对于 不 合格 的 测试 样品 ， 其漏 电流 波形 不是 恒定 的 周期 信号 ， 而是 开始 部分 出现 一段 冲击波 形 ， 在 仪器 对 电流 作出 判定 并 切断 高压 后 ， 出现 放电 波形 。 如图 3 所示 为 1 台 不 合格 的 进口 传真机 高压 试验 漏 电流 波形 （ 判定 电流 为 10mA ） 。 该 样品 在 开始 测试 多次 时 ， 均 击穿 不 合格 。 经过 装卸 移动 之后 ， 由于 振动 使 绝缘 距离 微小 变化 及 空气 温湿度 影响 等 ， 不再 击穿 不 合格 ， 但 根据 标准 这 也 是 不 允许 的 ， 因为 该 样品 经过 再次 人为 振动 之后 仍会 击穿 不 合格 。 由于 测试 时 采用 了 该 微机 采集 存储系统 ， 波形 保留 完好 ， 随时 可调 出 观察 ， 外商 对此 信服 ， 并 做 赔偿 处理 。 
 
 图 3       不 合格 的 传真机 高压 试验 漏 电流 波形 （ 判定 电流 ： 10mA ） 
 　 　 该 微机 存储 示波器 不仅 适合 于 电器 安全 试验 各项 目的 波形 测试 ， 而且 适合 于 多数 需要 测量 电压 、 电流 波形 的 情况 ， 其 采样 间隙 可 达到 22 μ s ， 采样 精度 可 达到 双 字节 （ 即 65536 个 分级 精度 ） ， 微机 硬件 普及 ， 软件 操作 简单 ， 在 电子电器 （ 或 其它 专业 的 商品 ） 检验 的 许多 项目 上 都 可以 得到 很 好 的 应用 。 本文 所述 方法 也 可供 其它 实时处理 的 应用 参考 和 借鉴 。 
 钟冠平 （ 厦门 出入境 检验 检疫局 机电 所 361012 ） 
 徐玉霖 （ 厦门 出入境 检验 检疫局 机电 所 361012 ） 
 参考文献 
 1 ， 王培杰 ． Borland   C ＋ ＋ 环境 下 Windows   3 ． 1 ～ 95 编程技术   及 实例 ． 北京 ： 机械 工业 出版社 ， 1997 
 2 ， 木 林森 ． Windows95 应用 编程 与 范例 ． 北京 ： 清华大学 出   版社 ， 1997 
 3 ， 吴炜煜 ． 多媒体技术 开发 指南 ． 大连 ： 大连理工大学 出版   社 ， 1994 
 收稿 日期 ： 1999 － 12 － 22 
