微型机 与 应用 
 MICROCOMPUTER   &   ITS   APPLICATIONS 
 1999 年   第 18 卷   第 2 期   Vol.18   No.2   1999 
 
 
 
 虚拟现实 技术 在 微机 上 的 实现 
 钱 　 玮 　 路 　 巍 　 李 劲松 
 　 　 摘 　 要 ： 虚拟现实 技术 在 微机 上 的 实现 方法 及 虚拟现实 系统 的 工作 原理 ， 并且 从 硬件 和 软件 两 方面 说明 了 虚拟现实 技术 在 微机 上 实现 的 要点 。 
 　 　 关键词 ： 虚拟现实 　 PCI 总线 　 微机 
 　 　 虚拟现实 ( VR ) 技术 ， 也 称 临场感 技术 ， 它 通过 环境模拟 使人 产生 身临其境 的 感觉 。 其中 视觉 临场感 技术 是 非常 重要 的 一环 。 一般来说 ， 虚拟现实 视觉 技术 是 通过 双眼 图像 系统 使人 在 视觉 感受 上 具有 观察 实际 物体 的 三维空间 立体 感觉 。 目前 虚拟现实 视觉 技术 主要 有 双眼 头盔 显示方式 和 分时 双眼 显示方式 。 本文 介绍 了 分时 双眼 显示 系统 的 原理 及其 在 微机 上 的 实现 方法 。 
 1 　 分 时 双眼 显示 原理 
 　 　 左右 摄像机 的 图像 在 显示屏 上 分时 交替 显示 ， 观察者 戴上 1 种 液晶 光阀 眼镜 进行 观看 ， 左右 2 眼 的 液晶 光阀 分时 轮流 进行 打开 和 关闭 。 当 液晶 光阀 的 开关 与 屏幕 上 显示 的 左右 2 个 摄像机 的 图像 交替 显示 的 频率 同步 时 ， 即 屏幕 上 显示 左 摄像机 的 图像 时 ， 左眼 的 液晶 光阀 打开 ， 使 观察者 左眼 可以 看到 左 摄像机 传到 屏幕 上 的 图像 ， 而 这时 右眼 液晶 光阀 关闭 使 观察者 右眼 看不到 任何 图像 ， 反之亦然 。 这样 观察者 左眼 就 始终 只能 看到 左 摄像机 传来 的 图像 ， 右眼 始终 只能 看到 右 摄像机 传来 的 图像 。 当 这种 左右 交替 的 速度 大于 60Hz 时 ， 由于 人眼 “ 视觉暂留 现象 ” 存在 ， 就 能 使 人 左右 2 眼 分别 看到 2 组 分别 来自 2 台 放置 位置 和 视角 与 人眼 相似 的 摄像机 的 连续 流畅 的 图像 ， 从而 使人 产生 很 好 的 立体 视觉效果 〔 1 〕 。 
 2 　 分 时 双眼 显示 系统 的 硬件 构成 
 　 　 本 系统 由 数据 采集 ( 见图 1 ) 和 显示 ( 见图 2 ) 二 部分 组成 。 物理 结构 是 基于 PCI 总线 的 2 块 微机 插卡 。 数据 采集 部分 是 由 同步 控制器 控制 的 2 台 摄像机 实现 的 ， 同步 拍摄 供给 左右 2 眼 的 电视 图像 ， 2 路 电视信号 分别 进行 A / D 转换 ( AD8708 芯片 ) 和 数字 解码 ( 7196 芯片 ) ， 在 同步 切换 控制器 控制 下 ， 从 左 摄像机 来 的 视频 数据 中取 奇场 数据 ( CCIR 制式 下 1 个 视频 帧 由 奇偶 两场 信号 组成 ) ， 从右 摄像机 来 的 视频 数据 中取 偶场 数据 。 由于 2 摄像机 已 同步 ， 因此 奇偶 场 数据 虽然 来自 不同 的 视频流 ( 左右 2 摄像机 视频信号 ) ， 但 在 信号 的 时域 结构 上 来看 可以 合成 1 帧 图像 。 这样 来自 不同 视频流 的 场频 数据 在 同步 切换 控制 下 重新 合成 为 帧频 数据 。 经 PCI 总线 接口 芯片 打包 后 ， 在 计算机 DMA 控制 下 将 数据 实时 送至 ET4000 显卡 的 帧 存中 。 在 显卡 的 控制 下 图像 帧 按奇 、 偶场 顺序 交替 在 显示屏 上 显示 。 观察者 戴 液晶 光阀 眼镜 ， 在 分时 同步 切换 的 控制 下 ， 使 左眼 液晶 光阀 只 在 屏幕 上 显示 奇场 图像 时 打开 。 右眼 液晶 光阀 只 在 屏幕 上 显示 偶场 图像 时 打开 。 
 
 图 1     数据 采集 部分 
 
 图 2     显示 部分 
 3 　 系统软件 的 编程 
 　 　 1 . 硬件 系统 编程 控制 
 　 　 硬件 系统 的 控制 编程 采用 Watcom   C 保护模式 编程技术 ， 这种 选择 基于 以下 几 方面 原因 。 
 　 　 ( 1 ) PCI 接口 芯片 ZR36120 的 端口 控制 采用 内存 映射 方式 ， 映射 地址 是 32 位 真实 物理地址 ( 与实 模式 16 段址 + 16 位 偏移 位 不同 ) 。 
 　 　 ( 2 ) 为了 达到 系统 的 设计 要求 ， 经 ZR36120 接口 进入 主机 的 图像 数据 要 直接 进入 显示 缓存 ， 而 在 实 模式 下 ， 显示 缓存 的 写入 是 通过 一种 页 映射 方式 完成 的 ， 需置 段 选择 寄存器 ， 速度 无法 达到 要求 。 
 　 　 ( 3 ) Watcom   C 编译系统 是 由 加拿大 WATCOM 系统软件 公司 以新 的 美国 国家标准 ANSIX3.159 为 基础 于 1992 年 推出 的 具有 32 位 编程 功能 的 软件包 ， 它 不仅 能 访问 机器 中 的 所有 内存 ， 而且 程序 的 执行 速度 亦 能 成倍 提高 ， 有利于 提高 系统 的 性能 。 
 　 　 2 . 系统 控制软件 编程 要点 
 　 　 ( 1 ) 系统 控制软件 流程图 ( 如图 3 所示 ) 
 
 图 3     系统 控制软件 流程图 
 　 　 ( 2 ) ZR36120 的 ASR 寄存器 编程 说明 
 　 　 ZR36120 的 I / O 口 是 通过 内存 映射 方式 工作 的 ， 因此 ， 须 访问 PCI 的 配置 空间 ， 获取 ZR36120 的 ASR 寄存器 基址 ， 利用 该 基址 加 偏移 地址 生成 32 位 的 物理 指针 就 可以 对 其 寄存器 进行 读写操作 。 
 　 　 ZR36120 共有 20 个 32 位 的 寄存器 ， 统称 为 ASR 〔 2 〕 ， 通过 这组 寄存器 可以 实现 对 整个 采集卡 的 硬件 控制 ， 其中 第 18 个 寄存器 为 I2C — BUS 寄存器 ， 通过 该 寄存器 的 读写 ， 可以 控制 连接 在 I2C 总线 上 的 设备 ， 如 解码 芯片 7196 以及 同步 控制器 。 
 　 　 ( 3 ) 解码 芯片 7196 的 控制 说明 
 　 　 7196 共有 64 个 寄存器 ， 分为 二 部分 ： 
 　 　 前 32 个 为 编码 控制 ， 后 32 个 为 scaler 控制 。 
 　 　 编码 控制 包括 ： 视频 制式 选择 ( PAL 、 NTSC ) 、 同步 信号 输出 方式 、 数字 视频格式 ( YUV 、 RGB ) 、 象素 格式 ( 64K ， 16M ) 。 
 　 　 scaler 控制 包括 ： 图像 尺寸 、 采样 精度 等 。 
 　 　 7196 寄存器 的 读写 格式 如图 4 〔 2 〕 ： 
 
 图 4 　 7196 寄存器 读写 格式 
 　 　 S = start   condition 
 　 　 slave   address = 0100000 或 010100001 
 　 　 A = acknowledge   generated   by   the   slave 
 　 　 subaddress = subaddress   byte   ( 0 ～ 64 ) 
 　 　 DATA ＝ date   byte 
 　 　 P = stop   condition 
 　 　 X = 0   write 
 　 　 X = 1   read 
 　 　 ( 4 ) 显示卡 线性 模式 编程 
 　 　 PCI 总线 的 显示卡 有 二种 显示方式 ： ① 基于 段 选择器 的 显示方式 ； ② 连续 线性 地址 显示方式 。 我们 采用 的 是 第 2 种 方式 。 
 　 　 由于 ET4000 显示卡 目前 比较 多 ， 并且 有 大量 的 文章 对 其 进行 介绍 和 分析 ， 因此 本文 对 ET4000 卡 的 编程 控制 介绍 从略 。 
 　 　 ( 5 ) 硬件 控制 关键 部分 程序清单 
 　 　 ① 访问 PCI 的 配置 空间 ， 获取 ZR36120 的 ASR 寄存器 基址 的 子程序 ， 通过 PCI 中断 B1 读取 ASR 基址 ， 配置 空间 说明 见 文献 〔 2 〕 。 
 　 　 long   getASRBase ( ) 
 　 　 { 
 　 　 union   REGS   r ; 
 　 　 unsigned   long   ab ; 
 　 　 r . h . ah = 0xb1 ; 
 　 　 r . h . al = 0x0a ; 
 　 　 r . w . di = 0x10 ; 
 　 　 int   386 ( 0x1A , & r , & r ) ; 
 　 　 return ( r . x . ecx ) ; 
 　 　 } 
 　 　 ② ASR 寄存器 的 读写 函数 
 　 　 WriteASR ( int   index , long   value ) 
 　 　 / * 　 index 是 ASR 寄存器 索引 ， values 是 写入 的 值 * / 
 　 　 { 
 　 　 long   * ASR ; 
 　 　 ASR = getASRBase ( ) ; 
 　 　 * ( ASR + index ) = value ; 
 　 　 } 
 　 　 ReadASR ( int   index ) 　 / * index 是 ASR 寄存器 索引 * / 
 　 　 { 
 　 　 long   * ASR , t ; 
 　 　 ASR = getASRBase ( ) ; 
 　 　 t = * ( ASR + index ) ; 
 　 　 return ( t ) ; 
 　 　 } 
 　 　 ③ 7196 寄存器 的 读写 函数 
 　 　 7196 寄存器 的 读写 通过 I2C 总线 来 完成 。 I2C 总线 是 通过 ZR36120 的 18 号 寄存器 进行 操作 。 具体操作 函数 如下 ： 
 　 　 long   * ASRbase ; 　 / * ASR 基址 ， 全局变量 * / 
 　 　 IICstart ( void ) 　 / * 设置 起始 条件 * / 
 　 　 { 
 　 　 * ( ASRbase + 0x44 ) = 3 ; 
 　 　 delay ( 1 ) ; 
 　 　 * ( ASRbase + 0x44 ) = 1 ; 
 　 　 delay ( 1 ) ; 
 　 　 return ; 
 　 　 } 
 　 　 IICstop ( void ) 　 / * 设置 结束 条件 * / 
 　 　 { 
 　 　 * ( ASRbase + 0x44 ) = 1 ; 
 　 　 delay ( 1 ) ; 
 　 　 * ( ASRbase + 0x44 ) = 3 ; 
 　 　 delay ( 1 ) ; 
 　 　 return ; 
 　 　 } 
 　 　 IICbitwrite ( unsigned   char   databit )   / * 写 7196 寄存器 * / 
 　 　 { 
 　 　 if ( databit = = 0 ) 
 　 　 { 
 　 　 * ( ASRbase + 0x44 ) = 0 ; delay ( 1 ) ; 
 　 　 * ( ASRbase + 0x44 ) = 1 ; delay ( 1 ) ; 
 　 　 * ( ASRbase + 0x44 ) = 0 ; delay ( 1 ) ; 
 　 　 } 
 　 　 if ( databit = = 1 ) 
 　 　 { 
 　 　 * ( ASRbase + 0x44 ) = 2 ; delay ( 1 ) ; 
 　 　 * ( ASRbase + 0x44 ) = 3 ; delay ( 1 ) ; 
 　 　 * ( ASRbase + 0x44 ) = 2 ; delay ( 1 ) ; 
 　 　 } 
 　 　 } 
 　 　 IICbitread ( void ) 　 / * 读 7196 寄存器 * / 
 　 　 { 
 　 　 unsigned   char   readvalue ; 
 　 　 * ( ASRbase + 0x44 ) = 2 ; delay ( 1 ) ; 
 　 　 * ( ASRbase + 0x44 ) = 3 ; delay ( 1 ) ; 
 readvalue = * ( ASRbase + 0x44 ) ; 
 if ( readvalue > = 2 )   readvalue = 1 ; 
 else   readvalue = 0 ; 
 　 　 * ( ASRbase + 0x44 ) = 2 ; delay ( 1 ) ; 
 　 　 return ( ( int ) readvalue ) ; 
 　 　 } 
 4 　 结束语 
 　 　 本 系统 设计 中 所 涉及 的 软硬件 内容 十分 广泛 ， 由于 篇幅 限制 ， 不能 每 一部分 都 作 深入 讨论 ， 仅能 对 所 设计 的 虚拟现实 视觉 系统 的 工作 原理 和 实现 思路 做 简单 描述 。 这些 描述 虽然 简单 ， 但 力求 准确 ， 读者 通过 本文 可以 对 分时 双眼 虚拟现实 视觉 系统 的 实现 和 组成 有 一个 比较 全面 的 了解 。   
 中国科学院 合肥 智能 机械 研究所 ( 230031 ) 
 参考文献 
 1 　 Steve   B . Virtual   Reality   in   Scientific   Visualization . IEEE 
 Computer & graphics , 1993 ; 17 ( 6 ) 
 2 　 ZORAN . ZR36120   Data   Sheet , 1995 
 3 　 Philips . DATA   HandBook ， IC22.1995 
 4 　 ZORAN . ZR36060   Data   Sheet , 1996 
 ( 收稿 日期 ： 1998 - 08 - 10 ) 
