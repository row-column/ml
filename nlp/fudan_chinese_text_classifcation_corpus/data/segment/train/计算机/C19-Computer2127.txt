计算机 工程 
 COMPUTER   ENGINEERING 
 1999 年   第 25 卷   第 12 期   vol.25   No.12   1999 
 
 
 
 基于 是 RSVP 的 VoD 的 实际 应用 与 系统 性能 分析 
 陆健贤 　 张 　 凌 　 冯穗力 
 1   综合 业务网 及 RSVP 协议 
 1.1   综合 业务网 ( Integrated   Service   Internet ) 
 　 　 大量 基于 IP 网 的 多媒体 应用 表明 传统 的 最好 效果 服务 并 不适 用于 实时 业务 的 传输 。 因此 ， IETF 正在 考虑 将 传统 IP 网 逐步 改造 为 支持 QoS 的 综合 业务网 的 方法 。 综合 业务网 包括 以下 要素 ： ( 1 )   新 的 服务类型 ;   ( 2 )   用于 在 网络 中 预留 资源 的 控制协议 ;   ( 3 )   能够 对 不同 IP 流 进行 包 分类 ( classification ) 和 调度 ( scheduling ) 的 路由器 ;   ( 4 )   一套 能 利用 QoS 服务 的 应用 程序接口 [ 4 ] 。 
 1.2   RSVP 协议 
 　 　 RSVP 作为 网络 中 预留 资源 的 控制协议 在 综合 业务网 中 具有 重要 意义 。 RSVP 是 一 信号 机制 , 并 不 用于 传递 业务 数据 。 客户端 可以 用 RSVP 协议 在 发送 端 和 接收端 之间 为 业务 流 请求 所 需 的 QoS 。 RSVP 资源 预留 机制 如图 1 所示 ， 发送 端 ( Sender ) 在 发送 业务 数据 之前 先 向 接收端 ( Receiver ) 发送 路径 消息 。 路径 消息 中 包含 发送 端到 接收端 的 路由 信息 以及 对 业务 流 的 描述 ， 如 平均 速率 ， 峰值 速率 ， 包长 ， 最大 时延 等 ， 但 RSVP 协议 并 不 解释 这些 参数 。 接收端 在 收到 路径 消息 后 将 根据 其中 包含 的 路由 信息 逐跳 向 发送 端 回送 预留 消息 。 预留 消息 向 其 经过 的 每 一 网络 元素 请求 所 需 的 QoS 。 若 网络 元素 支持 RSVP 协议 ， 它 将 根据 预留 消息 中 的 流量 参数 ， 用 接入 控制 ( access   control ) 和 策略 ( policy ) 模块 判断 是否 能够 提供 预留 消息 请求 的 QoS 。 若 网络 元素 能够 提供 请求 的 QoS ， 它 将 继续 向下 一跳 发送 预留 消息 ， 反之 ， 通知 接收端 预留 失败 。 RSVP 是 用 传输 期 ( session ) 的 三元组 ( 发送者 ， 接收者 ， 传输 协议 ) 以及 过滤 参数 ( filter   specification ， 如 TCP / UDP 的 端口 ) 来 标识 每一 IP 流 的 。   
 
 图 1RSVP 资源 预留 机制 
 　 　 RSVP 本身 并 不是 路由 协议 ， 也 不能 直接 预留 网络 元素 的 资源 ， 只是 提供 了 一种 信号 机制 。 因此 ， 要 使用 RSVP 保障 实时 业务 的 QoS 必须 有 以下 支持 ： 网络 元素 必须 能 解释 RSVP 消息 中 的 流量 描述 参数 ， 并 将 映射 为 适当 的 调度 策略 ， 如 ： Strict   Priority , CBQ ( Class - Based   Queuing ) 、 WFQ ( Weight   Fair   Queuing ) 以及 相应 的 拥塞 控制策略 ， 如 ： RED ( Random   Early   Detection ) ,   WRED ( Weighted   Random   Early   Detection ) [ 2 ] 。 同时 ， 能 根据 RSVP 对 IP 流 的 标识 定义 对 IP 包 进行 分类 以 保证 业务 的 QoS 。 
 2   基于 RSVP 的 VoD 实验 系统 
 　 　 图 2 为 一 IP 网上 基于 RSVP 的 VoD 实验 系统 。 图 2 各 子网 均 为 10M 以太网 。 两个 路由器 由 同步 串行口 相联 ， 时钟 频率 为 4M ， 实际 带宽 为 2.7 M 。 视频 服务器 Video   Server 位于 202.112 . 18 网段 ， 客户机 VoD   Client 位于 202.112 . 20 网段 。 视频 服务器 向 客户机 发送 以 UDP 封装 的 MPEG1 数据 ， 以 f1 表示 此 数据流 。 f1 需 占用 约 1.5 M 的 带宽 。 以 f2 , f3 表示 Host1 , Host2 发至 Host3 的 数据流 。 Bi 表示 fi 占用 的 带宽 。 f1 模拟 网络 中 的 实时 业务 ， f2 、 f3 模拟 一般 数据业务 。 系统 中 的 路由器 采用 CISCO   IOS   11.2 ( 7a ) 操作系统 ， 并 将 其 配置 为 支持 RSVP 协议 。 Video   Server 和 VoD   Client 通过 WinSock2   API 调用 RSVP 在 发送者 与 接收者 之间 预留 资源 。 表 1 为 路由器 中 有关 RSVP 的 设置 。 路由器 用 WFQ 保证 RSVP 请求 的 带宽 。 使 3 个 数据流 的 总 带宽   Σ iBi   大于 串口 的 带宽 ， 整个 系统 的 瓶颈 将 出现 在 连接 两个 路由器 的 串口 上 。 以下 实验 均 基于 此 系统 且 系统 设置 相同 。 
 
 图 2 基于 RSVP 的 VoD 实验 系统 
 表   1   路由器 设置 
 
 RSVP 协议 最大 可 预留 带宽 ( 发太 网口 ) 5Mbits / s 
 每一 业务 流 最大 可 预留 带宽 ( 以太网 口 ) 5Mbits / s 
 RSVP 协议 最大 可 预留 带宽 ( 串口 ) 1.7 Mbits / s 
 每一 业务 流 最大 可 预留 带宽 ( 串口 ) 1.7 Mbits 
 Fair   queuingEnable 
 
 
 　 　 实验 1 .   f2 、 f3 使用 TCP 协议 。 实验 表明 ， 无论 有无 RSVP 此时 VoD 的 画面质量 并 无 明显 下降 ， f2 、 f3 对 实时 业务 流 f1 影响 较 小 。 表 2 为用 TCPSpeed 测试 的 结果 。 
 表 2   视频 数据 发送 前后 ， 使用 TCP 的 业务 流 流量 比较 
 
 　 f2 , f3 独占 信道 
 f1 一发 视频 数据 f1 , f2 , f3 同时 发送数据 
 B2 + B32.174 Mb / s1.49 Mb / s 
 
 
 　 　 实验 2 .   f2 、 f3 使用 UDP 协议 ， 包长 为 1024B 。 f2 、 f3 均 为 1.6 Mb / s 的 UDP 数据流 。 f1 包长 为 1024B 。 3 个 数据流 总 带宽 Bi = 4.7 Mb / s ， 路由器 上 产生 拥塞 。 若 不 使用 RSVP 为 f1 在 两 路由器 上 预留 资源 ， 从 实验 观察 到 VoD 画面质量 明显 下降 ， 有 明显 停顿 和 马赛克 现象 。 若 RSVP 为 f1 在 路由器 上 预留 1.6 Mb / s 带宽 ， VoD 画面质量 有 明显改善 与 网络 轻载 时 基本相同 。 图 3 为 VoD   Client 在 使用 RSVP 和 不 使用 RSVP 时 接收 视频 数据 的 流量 比较 。 可见 ， 即使 在 网络 发生 拥塞 时 ， 使用 RSVP 仍 可以 保证 业务 流 的 带宽 ； 而 不 使用 RSVP ， 业务 流可 使用 带宽 将 比 网络 畅通 时 显著 下降 。 
 　 　 实验 3 .   f2 、 f3 使用 UDP 协议 ， 包长 为 1024B 。 f2 、 f3 均 为 1.6 Mb / s 的 UDP 数据流 。 f1 包长 为 8192B 。 此时 无论 有无 RSVP ， VoD   Client 画面 处于 停顿 状态 ， 其 接收 的 数据 为 0 。 因为 链路层 的 最大 包长 MTU ＝ 1500B , 若 IP 包 的 包 长大 于 链路层 的 最大 包长 ， IP 包将 被 分割 封装 在 多个 链路层 数据包 中 。 若以 B 表示 路由器 输出 带宽 ， 则 在 无 RSVP 的 情况 下经 路由器 的 链路层 数据包 的 平均 丢失 率为 RLmac   ， 若 IP 包被 分割 为 N 个 链路层 数据包 ， 则 当 其中 任一 链路层 数据包 丢失 ， IP 包将 无法 重组 。 因此 IP 包 的 丢失 率 ：   
 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 RLip ∝ ( RLmac ) N 。 
 与 IP 包 的 分割 数 成 指数 关系 ， 较大 的 IP 包在 网络 拥塞 时 更易 丢失 。 
 　 　 当 路由器 支持 RSVP 时 ， 它 将 RSVP 消息 中 的 预留 参数 映射 为 WFQ 中 的 权重 w ， 保证 预留 资源 的 数据流 获得 不少 于 w% 的 输出 带宽 。 RSVP 是 使用 IP地址 、 端口号 、 协议 三元组 来 标识 一个 流 的 。 故 f1 可以 ( IP   address ,   UDP   port ,   UDP 协议 号 ) 表示 。 以 P 表示 VoD   Server 发送 的 IP 包 ， 包长 为 8192B ; 以 pi 表示 分割 后 形成 的 第 i 个 较 小 的 IP 包 ， pi < MTU 。 则 仅 有   p1 含有 UDP 包头 ， pi ( i > 1 ) 均 不 含有 UDP 包头 。 故除 p1 外 ， pi ( i > 1 ) 均 不能 用 ( IP   地址 , UDP 包 端口号 , UDP 协议 号 ) 标识 ； 只有 p1 获得 RSVP 请求 的 QoS ， pi ( i > 1 ) 只是 当作 普通 IP 包 。 在 此 情况 下 P 的 丢失 率 RLip ： 
 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 RLip ∝ ( RLmac ) N － 1 。 
 
 * 为 网络 畅通 时 的 流量 曲线 ， × 为 网络 拥塞 时 使用 RSVP 的 流   量 曲线 ，   o 为 网络 拥塞 时 不 使用 RSVP 的 流量 曲线 
 图   3   VoD 系统 流量 比较 图 
 　 　 结论 1 .   TCP 协议 由于 具有 拥塞 控制 机制 ， 因此 在 网络 发生 拥塞 时 发送窗口 减小 而 使源 发送 速率 迅速 降低 。 相反 ， UDP 由于 无 拥塞 控制 机制 ， 此时 将 占用 更 多 资源 。 在 无 优先级 控制 、 资源 预留 等 接入 控制 机制 的 情况 下 ， TCP 数据流 在 与 UDP 数据流 竞争 网络带宽 时 将 处于 不利 地位 。 
 　 　 结论 2 ： 在 易于 拥塞 的 网络 ， 采用 较 小 的 IP 包 更 利于 保证 传输 带宽 。 
 　 　 另一方面 ， 较 小 的 IP 包将 增加 传输 的 延迟时间 ， 影响 MPEG1 码流 的 播放 质量 。 在 实验 中 ， 当 包长 为 1024B 时 , 画面 已 产生 可 觉察 的 抖动 。 为 解决 这一 矛盾 可 采取 自 适应 算法 。 在 网络 畅通 时用 8192B 的 包 传送 视频 数据 ， 若 客户端 在 门限 T 内未 收到 数据 则 通知 服务器 将 包长 降为 1024B 。 在 时间 ti 后 进行 试探 ， 包长 恢复 为 8192B 。 若 n 次 试探 均 未 发生 接收 超时 ， 传送 恢复正常 状态 ， 包长 为 8192B 。 若 试探 中有 一次 接收 超时 ， 系统 重回 拥塞 状态 ， 包长 为 1024B 。 为 防止 频繁 试探 引起 的 抖动 ， ti 选择 一 递增 序列 。 实验 表明 ， 采用 自 适应 算法 可 改善 画面质量 。 
 
 图 4   VoD 系统 自 适应 算法 
 3   结束语 
 　 　 RSVP   资源 预留 控制 机制 的 引入 ,   为 在 IP 网上 实现 具有 QoS 特征 的 实时 业务 的 传输 提供 了 可能性 。 正确 地 应用 RSVP 协议 可以 明显改善 网络 拥塞 时 实时 业务 的 服务质量 。 本文 根据 具体 的 的 实验 ， 分析 和 研究 了 RSVP 的 功能 和 具体 应用 的 效果 ,   并 就 在 建立 实时 系统 时 可能 出现 的 若干 问题 ,   如 包长 设置 ,   传输 质量 的 自 适应 调节 等 ,   提出 了 具体 的 解决 方法 。 以上 实验 是 在 同一 子网 畅通 的 情况 下 进行 的 ， 一个 更 完善 的 实时 业务 系统 应 包括 链路层 的 802.1 p 协议 ， 以 保证 实时 业务 在 交换式 的 以太网 上 有 传输 的 优先 度 ,   在 会话层 上 应用 的 RTP 协议 ,   以 保证 实时 业务 传输 的 规范 和 各种 时序 特性 的 恢复 ,   等等 。 RSVP 协议 的 普及 应用 将 有力 推动 IP 网上 的 实时 业务 多媒体 传输 业务 的 发展 。 
 作者 单位 ： 华南理工大学 网络 中心 ， 广州 150641 
 参考文献   
 1   Braden   R ,   Zhang   L , Berson   S , et   al .   RFC   2205   Resource   Reserv -   ation   Protocol   ( RSVP )   Version   1   Functional   Specification .   1997   - 09 
 2   Guarene   E ,   Fasano   P ,   Vercellone   V . IP   and   ATM   Integration   Perspectives . IEEE   Communications , 1998 , 36 ( 1 ) : 74 - 80 
 3   Carde   G , Biersark   G   W . Survey   of   Error   Recovery   Techniques   for   IP - based   Audio - visual   Multicast   Application . IEEE   Network , 1997 ,   11 ( 6 ) : 24 - 35 
