计算机 应用 
 Computer   Applications 
 1999 年   第 19 卷 　 第 8 期   Vol.19 　 No.8   1999 
 
 
 
 远程 公网 电话 报警 信息 的 实时处理 技术 
 丰国炳 　 
 　 　 摘 　 要 　 本文 探讨 了 远程 公网 报警 信息 的 获取 路径 及 显示 平台 的 构筑 方式 ， 提出 了 大幅 图 的 设计 方法 及片 图 地名 信息 的 压缩 处理 方法 ， 并 对 显示方式 作 了 深入 的 探讨 。 
 　 　 关键词 　 主线 程 ， 辅助线 程 ， 压缩 处理 
 1 　 显示 平台 的 构成 
 　 　 构造 连接 城市 市话 公网 的 特种 服务 信息 网络平台 比较复杂 ， 我们 仅 论述 与 信息 显示 有关 的 设备 。 首先 由 电信 部门 提供 2 兆口 光纤 进入 光复 用 设备 （ 光端机 ） ， 为 排队 交换机 提供 数字 中继 ， 由 排队 交换机 维护 计算机 获取 的 电话号码 ， 通过 网络系统 送 显示 平台 ， 显示 平台 的 程序 的 主线 程 负责 不间断 远程 查号 ， 辅助线 程 不间断 对 报警 电话号码 进行 信息 和 地图 定位 ， 并 生成 出动 命令 文件 ， 出动 命令 文件 通过 显示 平台 电脑 （ PC机 ） 多 串口 发 往 辖区 中队 ， 多 串口 中 的 COM1 通过 专线 Modem 连接 不同 的 中队 ， 其中 远程 查号 的 路径 是 DDN 专线 ， 而 出动 命令 下达 的 路径 为 普通 专线 。 排队 交换机 维护 台 计算机 与 显示 平台 电脑 通信 采用 Windows   95 自带 的 网络通信 程序 ， 在 对话框 中 指出 各自 的 IP地址 即可 ， 网关 采用 3COM 的 3C509 网卡 。 显示 平台 电脑主机 可以 连接 普通 的 21 寸 电脑 显示屏 ， 也 可接 大屏幕 投影仪 ， 或者 接 大屏幕 背投 电视 。 每个 值班员 席 电脑 也 能 由 通信 服务器 多 串口 连接 不同 的 中队 。 见图 1 ： 
 
 
 图 1 
 2 　 大幅 图 的 设计 及 地名 信息 的 压缩 
 　 　 桌面 地理信息系统 普遍 选用 的 开发工具 为 MAPINFO ， 在 客户机 一 服务器 结构 形式 的 系统 设计 中 ， 用 MAPINFO 来 设计 前端 的 地理信息系统 效果 较佳 ， 其 开放性 及 与 多种 数据库 兼容性 较 好 ， 尤其 是 后台 使用 大型 关系数据库 SYBASE 的 TSQL 编程 效果 更佳 。 但 此种 模式 运用 的 设备 较 多 ， 费用 相当可观 。 我们 采用 V C++ （ 4.10 版本 ） 制作 大幅 地图 也 能 达到 此 目的 ， 一幅 城市 的 大区 图 常用 的 作图 要素 为点 和 线 ， 完全 可用 MFC 的 数据 串行化 处理 。 我们 设计 成 横向 像素 为 7200 ， 纵向 像素 为 6000 的 大幅 空白 页面 ， 使用 滚动条 进行 自动 搜索 ， 在 600 * 480 的 分辨率 上 ， 每一 满屏 代表 一 区域 片图 ， 这样 大幅 空白 页面 横向 被 分成 12 等 分 ， 纵向 被 分 成长 10 等 分 ， 共有 120 个 满屏 即可 容纳 120 块 片区 地图 。 
 　 　 选择 一 标准 的 南京市 区 详图 （ 1 ： 10000 ） ， 上面 标有 南京市 所有 道路 、 水系 、 植被 、 高地 、 桥梁 、 重点 单位 及 大大小小 所有 地名 ， 然后 在 这张 详图 上 进行 横向 12 等 分 、 纵向 10 等 分 处理 ， 用 标尺 把 南京市 区 全图 分成 了 120 个 片区 图 。 如 地图 还 提供 地下 管线 情况 ， 同样 可 纳入 处理 。 这样 对 每 一片 区图 可 逐一 输入 到 计算机 ， 对 不同 的 地图 要素 可 采用 不同 颜色 来 处理 ， 这样 拼接 起来 就是 一幅 南京市 区 全图 。 
 　 　 地名 的 处理 比较复杂 ， 我们 仍然 用 V C++ （ 4.10 ） 处理 。 先 从 地名 委员会 取得 南京 城市 的 所有 地名 近 3000 条 （ 含 别名 ） ， 对照 分析 ， 发现 有 两字 地名 、 三字 地名 、 四字 地名 、 五 字 地名 等等 ， 其中 三字 地名 居多 ， 有 1016 个 ， 据此 ， 我们 把 同 字数 的 地名 归于 一类 。 然后 查找 每一 地名 落在何 片区 图中 ， 片区 图 的 编码 用 二维 矩阵 表示 。 
 
 
 　 　 如 C5 、 C6 、 D5 、 D6 等等 。 形成 了 地名 与 片 图 的 映射 关系 ， 如兰园 → F6 ， 三 牌楼 → D5E6 ， 王府 园 → F8 ， 竹林 新村 → H7 等等 ， 这样 就 把 南京市 所有 地名 与 片图 建立 了 映射 关系 。 每 一片 图中 有 许多 地名 、 街道 ， 如 在 C6 图中 ， 草场 门 大街 这一 名称 完全 在 C6 中 ， 地名 与 图 号 的 映射 成为 “ 草场 门 大街 → C6 ” ； 许多 地名 特别 是 一些 小区 皆 在 一个 片图 图 号 中 ， 如 “ 宝地 园 → C6 ” 。 但是 有 一些 街道 可能 要 跨 几个 片区 ， 如 江东 北路 分别 落 在 C6 和 C7 片区 图中 ， 映射 关系 相对 复杂 一些 ， 即 一 地名 对应 两个 或 多个 片区 。 “ 江东 北路 → C6C7 ” ， 对于 这种 情况 ， 跨地 图片 区路名 可带 特征 字符 ， 即 门牌号 ， 由 地名 、 特征 字符 共同 确定 片区 图号 ， 如 “ 江东 北路 1 号 - 200 号 → C6 ” ， “ 江东 北路 200 号 - 447 号 → C7 ” ， 这样 就 确定 了 一一对应 关系 。 除此之外 ， 加上 辖区 中队 信息 ， 建立 成 “ 路 名 — — 片区 图号 — — 辖区 中队 ” 的 一一 映射 关系 并 建成 数据库 。 对于 两字 地名 库存 而言 ， 库中 结构 为 ： 
 struet   wtld1 { char   dm ［ 4 ］ ； 
 / * 两字 地名 名称 * / 
 char   tz ［ 6 ］ ； 
 / * 特征 门牌号码 * / 
 char   th ［ 2 ］ ； 
 / * 图号 * / 　 　 　 　 
 char   zd ［ 6 ］ ； 
 / * 辖区 中队 队号 * / 
 } wtld1 ［ 114 ］ ； 
 　 　 对于 三字 地名 、 四字 地名 、 五 字 地名 ， 皆 如 上法 炮制 。 另外 要 建立 片图 图 号 库 ， 库 中共 有 120 条 记录 ， 库 结构 为 ： 
 struct   dtxy { char   th ［ 2 ］ ； 
 / * 片图 图 号 * / 
 int   xm ； 
 / * 该片 图 对应 左上角 X 座标 * / 
 int   ym ； 
 / * 该片 图 对应 左上角 Y 座标 * / 
 } dtxy ［ 120 ］ ； 
 　 　 这样 就 为 报警 信息 的 实时 显示 提供 了 固定 库 文件 ， 这些 库 文件 短小精悍 ， 皆 建立 在 本地 硬盘 上 ， 安全性 强 。 
 3 　 报警 信息 文件 的 形成 
 　 　 在 远程 查号 程序设计 中 ， 我们 采用 V C++   4.10 版 ， 根据 排队 交换机 返回 的 主叫 号码 来 远程 查询 市 电信局 信息中心 大型 SYBASE 数据库 ， 得到 主叫 号码 对应 的 用户名 和 用户 地址 。 程序设计 中要 用 三个 关键 远程 通信 函数 ： 
 　 　 打开 串行口 并 初始化 函数 OpenComm ( ) , 具体 形式 为 OpenComm ( LPCSTR   lpDevice , UINT   nsizeinqueue , UINT   nsize   Outqueue ) ; 
 　 　 写 串口 函数 WriteComm ( ) , 具体 形式 为 WriteComm ( int   port - id , Const   void   FAR * lep   Out   Buffer , int   nSize — Buffer ) ; 
 　 　 读 串口 函数 ReadComm ( ) , 具体 形式 为 ReadComm ( int   ComPort , void   FAR * ipBuf , int   nRead ) 。 
 　 　 这 三个 函数 皆 为 API 函数 。 
 　 　 因 考虑 到 此查 号 程序 与 市 电信局 信息中心 远程 联网 ， 向 信息中心 发送 的 是 报警 电话号码 ， 因此 WriteComm ( ) 中 的 int   nSize — Buffer 为 11 ， 正好 满足 中国电信 数字 移动电话 即将 升 11 位 号码 要求 ， 此处 可 修改 ， 有 的 大城市 如 北京 、 上海 为 8 位 ， 有 的 为 7 位 ； 接收 的 是 用户名 和 地址 信息 ， 长度 固定 为 100 ， 即 50 个 汉字 ， 在 Read   Comm ( ) 中 int   nRead 为 100 。 在 获取 报警 信息 的 同时 ， 一方面 发 往 空闲 的 接警 台 ， 另一方面 在 本地 硬盘 形成 两个 二进制 文件 fjy 和 fjy0 ， 其中 fjy 存储 报警 日期 、 报警 时间 、 报警 电话号码 、 用户名 和 用户 地址 信息 ： 
 m — hPrint = fopen ( " fjy " , " w + " ) ; 
 fwrite ( szPrintMsg , 1 , szPrintMsg . GetLength ( ) , m — hPrint ) ; 
 fclose ( m — hPrint ) ; 
 　 　 其中 fjyo 文件 仅 存储 报警 电话 对应 的 用户 地址   strUserAddr : 
 m — hPrint = fopen ( " C : \ \ MSDEV \ \ DSYP \ \ fjyo " , 
 " w + " ) ; 
 / * 在 指定 的 目录 中 形成 文件 fjyo * / 
 fwrite ( strUserAddr , 30 , 1 , m — hPrint ) ; 
 fclose ( m — hPrint ) ; 
 　 　 在 形成 fjyt 和 fjyo 的 两段 源码 中 ， m — hPrint 为 指向 文件 的 指针 ， szPrintMsg 为 一 字符 缓冲区 ， szPrintMsg . Get   Length ( ) 为 字符 缓冲区 的 总 字节 长度 ， strUserAddr 为 存放 报警 用户 地址 的 字符串 。 
 4 　 报警 文字 和 图形 信息 的 定位 显示 
 　 　 报警 文字 信息 获取 并 定位 后要 立即 驱动 片图 定位 显示 ， 我们 使用 多线程 处理 ， 主线 程 用来 远程 查号 ， 辅助线 程 用于 文字 和 图形 信息 的 定位 操作 。 文字 信息 的 定位 主要 包括 辖区 中队 的 自动 确认 、 车辆 器材 的 调度 确认 、 火场 信息 的 确认 、 标准 行车 路线 的 自动 确认 ； 图形 信息 的 定位 包括 辖区 片图 的 确认 、 片图 中 道路 和 水源 的 自动 确认 。 
 　 　 在 辅助线 程中要 根据 报警 地址 来 判断 从属 什么 路 名 ， 然后 查询 对应 的 片 图图 号 并 把 片图 漫游 到 屏幕 正中间 ， 并 注出 辖区 中队 。 
 　 　 如下 代码段 表示 （ 以 两字 地 名为 例 ） ： 
 mf1   =   fopen ( " c : \ Msder \ dsyp \ \ fjy1 " , " r + b " ) ; 
 fread ( wtld1 , sizeof ( char ) , ( MAX * 1 + 1 ) * 12 , mf1 ) ; 
 fclose ( mf1 ) ; 
 for ( int   i = 0 ; i < MAX1 + 1 ; i ++ { 
 if ( ( strncmp ( ff , wtld1 ［ I ］ . dm , 4 ) ) = = 0 ) { 
 for ( int   j = 0 ; j < 120 ; j ++ ) { 
 if ( ( strcmp ( wtld1 ［ I ］ . th , dtxy ［ j ］ . th , 2 ) ) = = 0 ) 
 { tagPOINT   pt = { dtxy ［ j ］ . xm , dtxy ［ j ］ . ym } ; 
 ScrollToPosition ( pt ) ; 
 PDC - > TextOut ( dtxy ［ j ］ . Xm + 560 , dtxy ［ j ］ . ym + 300 , dtxy ［ j ］ . th ) ; 
 Strncpy ( gb1 , wtld1 ［ j ］ . zd , 6 ) ; 
 Strcat ( gb2 , gb1 ) ; 
 PDC - > TextOut ( dtxy ［ j ］ . Xm + 5 , dtxy ［ j ］ . Ym + 60 , gb2 ) ; 
 } 
 } 
 } 
 　 　 其中 （ MAX1 + 1 ） 为 两字 地名 的 个数 ， gb1 、 gb2 为 存放 辖区 中队 队号 的 字符串 。 
 　 　 对于 三字 地名 、 四字 地名 、 五 字 地名 等 皆 用 上述 方法 进行 匹配 。 所以 一 报警 地址 获取 后 ， 分别 取前 两个 汉字 、 三个 汉字 、 四个 汉字 等 与 两字 地名 库 、 三字 地名 库 、 四字 地名 库 等 匹配 ， 直至 完全 定位 。 其中 片图 定位 的 MFC 函数 ： 
 　 　 tagPOINT   pt = { dtxy ［ j ］ . Xm , dtxy ［ j ］ . Ym } ; 
 ScrollToPosition ( pt ) ; 
 　 　 该 函数 是 通过 移动 滚动条 的 方法 把 文字 信息 对应 的 片图 移动 至 屏幕 正中 。 
 作者简介 ： 丰国炳 　 硕士 。 研究 方向 ： 计算机 通信 。 
 作者 单位 ： 丰国炳 　 南京 公安消防 指挥 中心 　 江苏 ． 南京 （ 210008 ） 
 　 　 收稿 日期 : 1999 - 04 - 06 
