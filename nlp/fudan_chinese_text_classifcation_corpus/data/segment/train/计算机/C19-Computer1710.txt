软件 学报 
 JOURNAL   OF   SOFTWARE 
 1999 年   第 1 期   No.1   1999 
 
 
 
 视频点播 服务器 中 服务 策略 的 研究 * 
 刘衡 竹 　 陈旭灿 　 陈福接 
 　 　 摘要 　 研讨 了 同时 为 多个 点播 用户服务 的 轮转 服务 策略 和 比例 服务 策略 , 并 提出 了 VOD ( video - on - demand ) 服务器 在 不 破坏 各路 点播 流 实时 播放 率 的 前提 下 , 应用 这些 服务 策略 的 方法 . 
 　 　 关键词 　 轮转 服务 策略 , 比例 服务 策略 , 视频点播 , 视频流 , 数据分布 . 
 　 　 中图法 分类号 　 TP391 
 Study   of   Servicing   Policies   in   Video - on - Demand   Server   
 LIU   Heng - zhu 　 CHEN   Xu - can 　 CHEN   Fu - jie   
 　 　 Abstract 　 The   round   robin   servicing   policies   and   the   proportional   servicing   policies   which   can   simultaneously   serve   for   the   multiple   subscribers   of   a   VOD   ( video - on - demand )   server   are   studied   in   this   paper .   And   how   to   use   these   policies   without   violating   the   real - time   playback   rates   of   the   subscribers   of   a   VOD   server   is   also   proposed . 
 　 　 Key   words 　 Round   robin   servicing   policy ,   proportional   servicing   policy ,   video - on - demand ,   video   stream ,   data   placement . 
 　 　 中图法 分类号 　 TP391 
 　 　 飞速发展 的 计算机 和 网络 技术 已经 使 中 、 大规模 的 VOD ( video - on - demand ) 系统 成为 可能 . ［ 1 , 2 ］ 目前 已有 一些 系统 问世 , 但 这些 系统 为了 保证 一定 数目 的 并发 点播 流 , 都 预留 了 大量 的 设备 资源 , 这须 以 较 高 的 系统 成本 为 代价 . 为了 降低 VOD 系统 的 成本 , 使 它 真正 走向 实用 , 必须 对 视频 服务器 、 网络 传输 、 机顶盒 等 几个 方面 的 一些 支撑 技术 问题 进行 较 深入 的 研究 , 使 预留 的 设备 资源 尽量 多 地被 应用 起来 . 基于 这种 需要 , 本文 对 服务 时间 的 优化 技术 进行 了 研究 , 在 保证 每路流 严格 按 其 播放 率 所 要求 的 速度 来 读取 的 同时 , 为 尽量 多 的 点播 用户 提供 VOD 服务 . 本文 在 对 VOD 系统 的 视频 服务器 设计 进行 量化 分析 的 基础 上 , 讨论 了 同时 为 多个 点播 用户服务 的 轮转 策略 （ 在 一个 服务 循环 中 ［ 3 ］ , 每路流 读取 的 数据 块数 一样 多 ） , 提出 了 比例 服务 策略 （ 在 一个 服务 循环 中 , 读出 的 视频流 的 数据 块数 与 视频流 的 播放 帧 率 成正比 ） , 在 保证 视频 播放 率 的 前提 下 , 证明 了 比例 服务 策略 是 一种 能 同时 为 最 多用户 提供 服务 的 策略 . 
 　 　 本文 第 1 节 讨论 了 保证 多路 流 实时 播放 的 约束条件 ; 第 2 节 讨论 了 轮转 服务 策略 和 比例 服务 策略 , 且 证明 了 比例 服务 策略 是 一种 能 支持 最 多 并发流 的 服务 策略 ; 第 3 节是 实验 结果 , 对 轮转 服务 策略 和 比例 服务 策略 的 性能 进行 了 比较 . 
 1 　 保证 多条 点播 流 连续 播放 的 约束条件 
 　 　 本文 主要 研究 服务 时间 的 优化 技术 , 在 保证 每条流 严格 按 其 播放 率 所 要求 的 速度 来 读取 的 同时 , 为 尽量 多 的 点播 用户 提供 VOD 服务 . 为了 较 精确 地 表示 这些 要求 , 假设 视频 服务器 正在 为 n 个 点播 用户 提供 服务 , 对应 的 n 路 点播 流为 S1 , S2 , ... , Sn . 由于 等位 率 MPEG ( moving   picture   experts   group ) 视频流 便于 控制 , 带宽 分配 和 平滑 策略 都 较 变位 率 视频流 要 简单 , 故 在 VOD 系统 的 开发 和 研制 中用 得 很多 . 我们 在 讨论 和 实验 中 , 主要 针对 恒位 率流 , 且 假定 在 压缩 过程 中 , 做到 每 一个 GoP ( group   of   picture ) 包括 同样 多 的 帧 , 在 存储 分布 过程 中 选择 一个 GoP 为 一块 , 在 磁盘 上 存储 , 显然 这是 一种 CTL ［ 4 ］ （ constant   time   length ） 数据分布 方法 的 变型 （ 对于 具有 相同 播放 帧 率 的 视频流 是 按 CTL 存储 的 ） . 本文 所 得出 的 结论 稍加 修改 , 同样 适合 于 变位 率流 . 对于 压缩 的 等位 率 视频流 （ 例如 , 等位 率 MPEG 流 ） , 让 Bframe ( 1 ) , Bframe ( 2 ) , ... , Bframe ( n ) 分别 为 各路 流 每块 数据 对应 的 帧 数 , 根据 前面 的 假设 , 它们 都 应 相同 , 就 记为 Bframe , 单位 为 ： 帧 / 块 ； Sframe ( 1 ) , Sframe ( 2 ) , ... , Sframe ( n ) 分别 为 各路 流 每块 数据 中 平均 每帧 的 大小 （ 因为 针对 恒位 率流 , 所以 通过 插入 填充 位 或者 填充 字节 可以 做到 同 一路 流 每块 数据 中 平均 每帧 的 大小 相同 ） , 单位 为 ： 字节 / 帧 ； Rpl ( 1 ) , Rpl ( 2 ) , ... , Rpl ( n ) 分别 为 各路 流 的 播放 帧 率 , 单位 为 ： 帧 / 秒 . 这些 参数 一般 因 各路 视频流 的 压缩 方法 、 视频 制式 和 图像 质量 等 的 不同 而 不同 . 从 宏观 上 看 , 视频 服务器 同时 为 n 路流 提供 播放 , 实际上 是 通过 分 时 服务 完成 的 , 为流 Si 传输 Ki 块 数据 后 , 切换 到 为 流 Si + 1 提供 Ki + 1 块 数据传输 . 传输 序列 K1 , K2 , ... , Kn 构成 了 一个 服务 循环 . 服务器 重复 这个 服务 循环 , 直至 n 路流 所 需 的 数据 全部 播送 完成 为止 . 
 　 　 从 一路 流 切换 到 另 一路 流 , 需 把 磁头 从 前面 的 数据 块 移到 另 一路 流 的 数据 块 的 开始 处 , 这一 过程 所 需 的 时间 小于 盘 的 最大 寻址 时间 ＋ 磁盘 旋转 一周 所 需 的 最大 时间 . 在 此 , 我们 不妨 假设 一条 磁道 上 至少 可 存储 1 个 数据 块 , 则 在 这 段时间 里 , 肯定 可以 读出 第 1 块 数据 . 这样 , 在 服务 周期 中 , 读取 流 Si 的 Ki 块 数据 所 需 的 时间 由 两 部分 组成 . 
 　 　 ( 1 )   额外 开销 加上 传输 第 1 块 数据 所用 的 时间 T1 ( i ) ． 因为 磁盘 寻址 时间 ≤ , 磁盘 旋转 一周 所用 的 时间 ≤ , 所以 有 T1 ( i ) ≤ ; 
 　 　 ( 2 )   传输 Ki － 1 块 数据 所 需 的 时间 T2 ( i ) . 
   
 其中 Rdr 为 磁盘 数据传输 带宽 , 单位 为 ： 字节 / 秒 . 
 　 　 为流 Si 读取 Ki 块 数据 所 需 的 时间 为 T ( i ) = T1 ( i ) ＋ T2 ( i ) , 一个 服务 循环 所用 的 时间 为 
   
 要 满足 n 路流 都 能 严格 按照 它们 各自 播放 率 的 要求 来 读取 , 必须 满足 一个 服务 循环 周期 要 比 n 路流 中 播放 率 最高 的 流 Si 播放 Ki 块 数据 所用 的 时间 小 , 即 
 　 　 　 　 　 ( 1 )   
 因为 式 （ 1 ） 包括 n 个 参数 k1 , k2 , ... , kn , 要 确定 ki 则 必须 有 另外 的 条件 . 
 2 　 服务 策略 
 2.1 　 轮转 服务 策略 
 　 　 轮转 服务 策略 ： 在 一个 服务 循环 中 每路流 都 读取 相同 块 数据 , 即 k1 = k2 = ... = kn = k . 
 　 　 这时 , 式 （ 1 ） 变为 
   
 其中 可 推导 出 
 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ( 2 )   
 任何 流 Si 的 一个 块 都 能 在 时间 内 读出 , 
 故 　 　 　 　 　 　 　 　 　 　 　 　 
 又 因为 k ≥ 0 , 所以 
   
 令 nrmax 为 轮转 服务 策略 能 支持 的 最 多 点播 用户数 , 则 有 
 　 　 　 　 　 　 　 　 　 　 　 　 ( 3 )   
 由式 （ 3 ） 可以 看出 , 用 轮转 服务 策略服务器 同时 为 点播 用户 提供 服务 的 个数 受 播放 率 最快 的 那个 用户 所 限制 , 这时 得出 的 最大 用户数 nrmax 通过 稍加 改进 服务 策略 就 可 得以 增加 . 这 是因为 , 播放 最快 的 用户 在 一个 服务 循环 中 所 读出 的 数据 正好 够 它 播放 一个 服务 循环 的 时间 , 而 其他 用户 所 读出 的 数据 超过 了 它 在 一个 服务 循环 中所 能播 完 的 数据 , 因此 , 可以 减少 这些 用户 的 数据传输 , 而 为 更 多 的 用户 提供 服务 . 
 　 　 下面 , 我们 提出 一种 在 一个 服务 循环 中 一路 流所 读出 的 数据 块数 与 它 的 播放 帧 率 成正比 的 服务 策略 , 不妨 简称 为 比例 服务 策略 . 然后 , 我们 证明 它 是 一种 能 同时 为 最 多用户 提供 服务 的 策略 . 
 2.2 　 比例 服务 策略 
 　 　 比例 服务 策略 ： 在 每个 服务 循环 中 , 为 每路流 读取 的 数据 块数 与 该 流 的 播放 帧 率 成正比 , 即 
  i ∈ ［ 1 , n ］ 　 　 　 ki ∝ Rpl ( i ) .   
 　 　 让 c 为 比例 常数 , 则 
 k1 = c . Rpl ( 1 ) , k2 = c . Rpl ( 2 ) , ... , kn = c . Rpl ( n ) .   
 　 　 这时 , 式 （ 1 ） 变成 
 　 　 （ 4 ）   
 因为 所 讨论 的 是 恒位 率流 , 显然 当 Rpl ( i ) 增大 时 , Sframe ( i ) 减小 ; 当 Rpl ( i ) 减小 时 , Sframe ( i ) 增大 , 所以 , 可以 得出 
  　 　 　 　 　 　 ( 5 )   
 其中 　 　 　 　 　 　 　 　 　 
 由式 （ 4 ） 、 （ 5 ） 可 得出 
 　 　 　 　 　 　 　 　 　 　 ( 6 ) 
 　 　 　 　 　 ( 7 )   
 令 npmax 为 轮转 服务 策略 能 支持 的 最 多 点播 用户数 , 则 有   
 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ( 8 )   
 　 　 如果 给定 同时 提供 点播 服务 的 用户数 n ≤ npmax , 可由式 ( 6 ) 求出 c , 因此 就 可以 求出 在 一个 服务 循环 中 每路 流需 读出 的 数据 块数 , ki = c . Rpl ( i ) , i = 1 , 2 , ... , n . 由 ki 可 进一步 对 缓冲 空间 提出 要求 , 以 保证 连续 播放 . 
 　 　 在 以上 的 讨论 中 , 我们 一直 假设 数据 从盘 上 读出 都 是 以块 为 单位 的 , 每块 包含 整数 个 帧 , 因为 视频 帧 的 大小 在 帧 与 帧 之间 都 是 变化 的 , 这 要求 上述 从盘 上 读取 的 块 大小 是 可变 的 . 在 从 盘 上 读出 数据 的 单位 块 大小 是 固定 的 情况 下 , 这时 是 一种 CDL 存储 分布 ［ 4 ］ （ constant   data   length ） , 那么 , 一个 盘块 数据 不 一定 刚好 包括 整数 个 帧 , 因此 , 盘块 边界 和 帧 的 边界 不 可能 总是 耦合 的 , 在 这种 情况 下 , 同时 为 n 个 点播 用户 提供 服务 , 可以 根据 播放 位率 （ 而 不是 像式 （ 1 ） 那样 根据 播放 帧 率 ） 来 建立 约束 公式 . 这样 可 得出 
 　 　 　 　 　 ( 9 )   
 D 为 一个 盘块 大小 , Rbr （ i ） 为 第 i 个 点播 用户 所 需要 的 传输 位率 （ 如果 为 MPEG 流 , 在 流 参数 中有 指示 ） . 这时 要求 出 最 多 可 同时 为 多少 点播 用户 提供 服务 , 可 按 如下 方法 来 计算 . 
 　 　 在 一个 服务 循环 中 每路流 所 需 传输 的 数据 块数 与 播放 该流 所 要求 的 传输 位率 成正比 . 即   i ∈ ［ 1 , n ］ , ki ∝ Rbr ( i ) , 如果 c 为 比例 常数 , 则 ki = c . Rbr （ i ） , i = 1 , 2 , ... , n , 把 它们 代入 式 （ 9 ） 可 求得 
 　 　 　 　 　 　 　 　 　 　 　 　 　 ( 10 ) 
 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ( 11 )   
 如果 应用 轮转 服务 策略 , 可求 出 
 　 　 　 　 　 　 　 　 　 　 　 　 ( 12 ) 
 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ( 13 )   
 2.3 　 比例 服务 策略 是 一种 能 同时 为 最 多用户 提供 服务 的 策略 的 证明 
 　 　 一般 比例 服务 策略 可 同时 提供 点播 服务 的 个数 比 轮转 服务 策略 能 同时 提供 的 服务 个数 要 多 , 这 可 由 下式 明显 看出 . 比例 服务 策略 最 多 同时 能 提供 的 服务 个数 为 npmax , 轮转 服务 策略 最 多 同时 能 提供 的 服务 个数 为 nrmax , 
   
 各路 流 演播 帧 率 （ 或 传输 位率 ） 相差 很大 时 , 这个 比值 也 就 较大 . 我们 可以 证明 比例 服务 策略 是 一种 能 同时 为 最 多用户 提供 服务 的 策略 , 证明 过程 见 如下 命题 . 
 　 　 命题 1 .   在 保证 各路 流都 能 按 它们 各自 的 播放 帧 率 要求 读取 的 前提 下 , 比例 服务 策略 能 支持 最 多路 独立 并发流 的 演播 （ 即 , 比例 服务 策略 是 一种 能 同时 为 最 多用户 提供 服务 的 策略 ） . 
 　 　 证明 ： 不失 一般性 , 不妨 设 Rpl ( 1 ) ≥ Rpl ( 2 ) ≥ ... ≥ Rpl ( i ) . 这样 可以 得出 
 Rpl ( 1 ) = a2 . Rpl ( 2 ) = ... = ai . Rpl ( i ) , 　 　 　 a1 = 1 .   
 如果 有 一种 服务 策略 , 在 保证 各路 流都 能 按 它们 各自 播放 帧 率 要求 读取 的 前提 下 , 它 能 同时 提供 最 多 点播 服务 个数 , 不妨 设 服务 个数 为 n , 在 某个 服务 循环 中 , 第 i 路流 读出 的 数据 块 数为 k ′ i , 因为 该 策略 能 保证 各路 流都 按 它们 各自 播放 帧 率 要求 读取 , 所以 k ′ 1 , k ′ 2 , ... , k ′ n 应该 满足 方程 （ 1 ） . 
 　 　 这时 , 只要 我们 能够 找到 分别 与 播放 帧 率 Rpl ( i )   成正比 的 ki （ 其中 i = 1 , 2 , ... , n ） , 使得 
 k1 = a2 . k2 = a3 . k3 = ... = an . kn （ 即 a1 = 1 ） 也 满足 式 （ 1 ） , 且 比例 因子 , 这样 就 证明 了 ： 在 每个 服务 循环 中 每路流 分别 读取 k1 , k2 , ... , kn 块 数据 的 比例 服务 策略 , 在 保证 各路 流 按 点播 帧 率 读取 的 前提 下 , 也 能 同时 为 n 个 点播 用户 提供 服务 . 这 也 说明 了 ： 在 保证 各路 流 按 点播 帧 率 读取 的 前提 下 , 比例 服务 策略 不比 任何 其他 服务 策略 最多能 提供 的 服务 流数少 . 故 命题 成立 . 下面 的 主要 问题 是 , 如何 寻找 k1 , k2 , ... , kn . 
 让 　 　 　 　 　 
 显然 有 　 　 　 　 　 　 　 　 　 　 　 
 增加 k ′ m1 到 km1 , 使得 am1 . km1 = am2 . k ′ m2 , 这时 可 得出   
   
 即 , 这时 在 一个 服务 循环 中 , 流 m1 和 m2 分别 读取 km1 和 k ′ m2 块 数据 , 如果 这时 式 （ 1 ） 仍然 成立 的话 , 那么 , 这 两路 流 的 读取 就 符合 一种 比例 服务 策略 , 且 能 保证 各路 流 按 点播 帧 率 读取 . 现在 来 证明 , 把 k ′ m1 块 提高 到 km1 块 后 , 不会 使式 （ 1 ） 成立 的 条件 受到破坏 . 
 　 　 式 （ 1 ） 的 右手 端 ： 
   
 我们 可以 构造 如下 函数 
   
 　 　 为了 保证 流 Si 能 按 播放 率 Rpl ( i ) 连续 播放 , 必须 要求 读取 一块 数据 所用 的 时间 小于 或 等于 一块 数据 能 播放 的 时间 , 
 故有 　 　 　 　 　 　 　 　 　 
 所以 　 　 　 　 　 　 
 即 f ( k1 , k2 , ... , kn ) 是 ki 的 递增 数 , i = 1 , 2 , ... , n . 
 　 　 因为 k ′ 1 , k ′ 2 , ... , k ′ n 满足 式 （ 1 ） , 所以 , f ( k ′ 1 , k ′ 2 , ... , k ′ n ) ≥ 0 , 
 　 　 因为 km1 ≥ k ′ m1 , 故有 
 f ( k ′ 1 , k ′ 2 , ... , km1 , ... , k ′ n ) ≥ f ( k ′ 1 , k ′ 2 , ... , k ′ m1 , ... , k ′ n ) ≥ 0 ,   
 即 k ′ 1 , k ′ 2 , ... , km1 , ... , k ′ n 满足 式 （ 1 ） . 
 　 　 因此 , 当 k ′ m1 增加 到 km1 时 , 不会 破坏 式 （ 1 ） 的 成立 . 
 　 　 我们 用 Mprop 表示 那些 在 一个 服务 循环 中 视频流 回取 的 数据 块数 与 该 播放 的 帧 率成 比例 的 那些 视频流 的 集合 . 这样 , Mprop = { m1 , m2 } . 只要 ｜ Mprop ｜ ＜ n , 就 说明 还有 一些 流不在 集合 Mprop 中 . 
 让 　 　 　 　 　 　 　 　 　 　 
 增加 Mprop 集合 中流 对应 的 km1 , km2 , ... , 使得  这样 , 增加 kmi 同样 满足 式 （ 1 ） , 证明 过程 与 以上 步骤 相同 , 然后 , 令 Mprop = Mprop ∪ { m } , 这一 过程 一直 进行 下去 , 直到 ｜ Mprop ｜ = n . 这时 , k1 = a2 . k2 = a3 . k3 = ... = an . kn , 且 k1 , k2 , ... , kn 满足 式 （ 1 ） . 　 　 　 　 　 　 　 　 　 □   
 3 　 实验 结果 
 　 　 针对 以上 所 讨论 的 服务 策略 , 在 我们 构筑 的 VOD 开发 平台 上 , 做 了 一些 实验 , 对 服务 策略 进行 了 一些 模拟 , 对 性能 进行 了 初步 评估 , 我们 所用 系统 的 数据 传输率 为 100MB / s . 我们 对 PAL 制式 和 NTSC 制式 的 影片 按 MPEG - 1 进行 了 压缩 , 并且 每个 GoP 有 10 帧 , I 帧 , P 帧 , B 帧 的 演播 次序 为 IBBPBBPBBP , 每个 GoP 为 一个 存储 块 , 所得 的 限制 参数 压缩 视频流 特性 分别 为 ： 
 　 　 PAL 制式 ： 视频流 传输 位率 为 ： 180000 字节 / s 　 　 　 播放 帧 率 为 ： 25 帧 / s 
 　 　 　 　 　 　 I 帧 平均 每帧 为 ： 21000 字节 　 　 　 　 　 　 P 帧 平均 每帧 为 ： 11000 字节 
 　 　 　 　 　 　 B 帧 平均 每帧 为 ： 3000 字 　 　 　 　 　 　 　 节 平均 每个 GoP ： 72000 字节 
 　 　 NTSC 制式 ： 视频流 传输 位率 为 ： 180000 字节 / s 　 　 播放 帧 率 为 ： 30 帧 / s 
 　 　 　 　 　 　 　 I 帧 平均 每帧 为 ： 18000 字节 P 帧 　 　 　 平均 每帧 为 ： 9500 字节 
 　 　 　 　 　 　 　 B 帧 平均 每帧 为 ： 2250 字节 　 　 　 　 　 平均 每个 GoP ： 60000 字节 
 　 　 在 一个 服务 循环 中 , 当 点播 流由 以上 两种 类型 流 构成 时 , 轮转 服务 策略 最多能 支持 多达 485 路流 的 播放 , 而 比例 服务 策略 最多能 支持 582 路流 的 播放 . 在 不 增加 任何 硬件资源 的 前提 下 , 把 系统 的 效率 大约 提高 了 20% , 这是 十分 可观 的 . 
 本文 研究 得到 国防 预研 基金 资助 。 
 作者 介绍 ： 刘衡 竹 , 1963 年生 , 副研究员 , 主要 研究 领域 为 分布式 多媒体 。 
 　 　 　 　 　 陈旭灿 , 1966 年生 , 女 , 讲师 , 主要 研究 领域 为 并行 技术 . 
 　 　 　 　 　 陈福接 , 1935 年生 , 教授 , 博士生 导师 , 主要 研究 领域 为 大规模 并行 、 存储技术 , 分布式 多媒体 . 
 本文 通讯联系 人 ： 刘衡 竹 , 长沙   410073 , 长沙 工学院 计算机科学 系 617 研究室 
 作者 单位 ： 刘衡 竹 　 陈旭灿 　 陈福接 　 长沙 工学院 计算机科学 系 　 长沙 　 410073 
 E - mail :   hzhliu @ nudt . edu . cn 
 参考文献 
 　 ［ 1 ］ Rangan   P   V ,   Vin   H   M ,   Ramanathan   S .   Designing   a   multiuser   multimedia   on - demand   service .   IEEE   Communications ,   1992 , 30 ( 7 ) : 56 ～ 65 
 　 ［ 2 ］ Sincoskie   W   D .   System   architecture   for   a   large   scale   video   on   demand   service .   Computer   Networks   and   ISDN   System ,   1991 , 22 ( 2 ) : 155 ～ 162 
 　 ［ 3 ］ Vin   H   M ,   Rngan   P   V .   Designing   a   multi - user   HDTV   storage   server .   IEEE   Journal   on   Selected   Areas   in   Communi 
 cations ,   1993 , 11 ( 1 ) : 153 ～ 164 
 　 ［ 4 ］ Edward   Te   Chang .   Storage   and   retrieval   of   compressed   video   ［ Dissertation ] .   Berkeley ,   California :   University   of   California ,   1996 
 本文 1997 - 07 - 18 收到 原稿 , 1998 - 01 - 23 收到 修改稿   
