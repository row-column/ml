微型机 与 应用 
 MICROCOMPUTER   &   ITS   APPLICATIONS 
 2000   Vol.19   No.3   P.6 - 7 , 52 
 
 
 
 NCR   LifeKeeper 技术 及其 应用 简介 共享 磁盘阵列 柜 方式 
 北京 创统 科技 有限公司 ( 100081 ) 
 1   NCR   LifeKeeper 原理 
 　 　 1 . NCR   LifeKeeper 定义 、 特性 、 资源 保护 
 　 　 LifeKeeper   For   Windows   NT 提供 了 一个 完全 容错 的 软件 解决方案 , 并 提供数据 、 应用程序 和 通信 资源 的 高度 可用性 。 LifeKeeper 不 需要 任何 特别 的 容错 硬件 。 你 可以 集合 使用 2 ～ 16 个 NT 结点 。 并 访问 特定 地点 的 配置 数据 。 然后 , LifeKeeper 会 自动 地 提供 错误 检测 和 多层 现场 恢复 。 
 在 出现 故障 的 情况 下 , LifeKeeper 会 将 保护 资源 自动 转换 到 一个 根据 优先权 而 设定 的 系统 。 在 实际 进行 切换 用户 时 , 会 经历 一个 十分 短暂 的 休眠 , 但是 , 当 系统 完成 了 切换 操作 后 , LifeKeeper 会 在 所 选择 的 系统 上 自动 地 恢复 操作 。 
 　 　 可以 被 LifeKeeper2.0 保护 起来 的 资源 是 : 卷 （ Volume ） 、 IP地址 、 共享 文件 、 LAN （ 局域网 ） 管理器 服务器 名称 、 应用程序 、 定义 的 用户 、 MSCS 应用程序 
 　 　 2 . 心跳 故障 检测 Heartbeat 
 　 　 LifeKeeper 在 集群 节点 间 保持 着 间歇 的 通信 信号 , 也 叫做 心跳 信号 , 是 一个 错误 检测 机制 , 即 通过 每 一个 通信 路径 , 在 2 个 对 等 系统 之间 进行 周期性 的 握手 。 如果 连续 没有 收到 的 心跳 信号 到 了 一定 的 数目 , LifeKeeper 就 把 这条 路径 标示 为 失效 （ 红色 ） 。 
 如果 你 只 定义 了 一条 通信 路径 , 当 LifeKeeper 把 这 唯一 的 1 条 通信 路径 标为 失效 时 , LifeKeeper 便 立即 开始 恢复 过程 。 然而 , 如是 你 有 冗余 路径 , LifeKeeper 能够 通过 第 2 条 路径 确定 是 系统故障 还是 只是 通信 路径 有 问题 。 如果 LifeKeeper 开启 优先级 第二 的 通信 路径 并 收到 了 心跳 信号 , 它 就 不 开始 failover 恢复 , 只 需要 把 第一条 通信 路径 标成 红色 （ 失效 ） , 作为 信号 告诉 你 需要 修理 一下 有 故障 的 路径 。 
 　 　 一般 情况 下 LifeKeeper 只 在 下列 事件 发生 时 , 启动 系统 恢复 功能 : 
 　 　 （ 1 ） 所有 的 通信 路径 故障 。 如果 所有 节点 都 没能 收到 心跳 信号 , 把 所有 通信 路径 都 标为 失效 , LifeKeeper 开始 安全检查 。 
 　 　 （ 2 ） 安全检查 失败 。 当 所有 通信 路径 故障 时 , LifeKeeper 向 整个 网络 发出 安全检查 信号 。 如果 信号 指出 配对 系统 还 “ 活 ” 着 , 则 LifeKeeper 不 启动 Failover 。 如果 安全检查 没 从 配对 节点 返回 信号 , LifeKeeper 就 开始 Failover 。 
 　 　 因而 , 为了 减少 由于 潜在 的 通信 错误 所 引起 的 不必要 的 系统 切换 , 建议您 使用 不同 介质 的 多条 通信 路径 。 
 　 　 3 . 通信 路径 
 　 　 LifeKeeper 支持 在 节点 之间 和 心跳 通信 中 , 使用 如下 通信 路径 : 
 　 　 （ 1 ） socket , 即套 接字 。 无论 使用 哪 种 网络 硬件 接口 , 只要 它 能够 支持 TCP / IP 的 通信协议 即可 。 这样 的 硬件 包括 : 以太网 、 快速 以网 、 令牌环 网 以及 FDDI 或 CDDI 。 
 　 　 （ 2 ） 串行口 在 LifeKeeper 配置 中 , 应当 配置 有 一个 串行口 通信 路径 。 串口 通信 路径 需要 利用 RS232 的 拟 调解 线路 来 与 LifeKeeper 系统 相连接 。 
 　 　 （ 3 ） 共享 磁盘 。 可以 定义 1 个 共享 磁盘分区 来 作为 LifeKeeper 的 通信 中介 。 可以 只 使用 小至 1MB 的 分区 , 当然 , 也 可以 使用 更大 的 空间 。 
 　 　 LifeKeeper 假定 , 当 通过 心跳 信号 检测 其它 服务器 失败 时 , 则 认为 此 服务器 是 关闭 的 , 因此 , 为了 避免 不必要 的 失效 切换 , 最好 建立 二种 以上 独立 的 物理 路径 , 使用 至少 二种 心跳 信号 。 
 　 　 例如 , 如果 2 个 服务器 被 1 个 串口 连接起来 , 并且 由 从属 服务器 来 的 心跳 信号 无法 被主 服务器 所 检测 到 , 则 下面 之一 是 可能 引起 这一 现象 的 原因 : （ 1 ） 服务器 的 RS - 232 卡 或者 端口 失败 ; （ 2 ） 电缆 失效 ; （ 3 ） 主 服务器 暂时 挂 起 ; （ 4 ） 主 服务器 失败 。 
 　 　 失效 切换 只 可能 在 最后 一种 情况 下才 发生 。 因此 , 节点 间 的 多种 通信 路径 可以 帮助 避免 不必要 的 失效 切换 。 
 2   NCR   LifeKeeper 配置 示范 
 　 　 NCR   LifeKeeper 配置 示范 如图 1 所示 。 
 
 注释 :   支持 的 数据库系统 : NT   SQL   Server 、 Sybase 、 Oracle 等 ; 支持 的 
 软件 : lotus   Notes 、 Exchange   server 等 ; 其它 : SAP   R / 3 。 NCR 除 
 了 提供 以上 的 恢复 工具包 外 , 还 提供 了 一个 用户 自定义 接口 , 
 使 您 的 应用 也 能 处于 LifeKeeper 的 保护 之下 。 
 图 1   NCR   LifeKeeper 配置 示范 
 　 　 1 . 软件 、 硬件 配置 
 　 　 软件 : NCR   LifeKeeper   2.0 及 Recovery   Kit 
 　 　 硬件 : 服务器 可以 是 任何 Intel 基础 上 的 平台 , Server 的 型号 、 配置 不必 一致 , 只要 硬件平台 能 保证 NT 运行 , 磁盘阵列 即可 正常 使用 。 
 　 　 2 . NCR   LifeKeeper 运行机制 
 　 　 （ 1 ） 共享 的 SCSI 和 LifeKeeper 软件 锁定 
 　 　 LifeKeeper   For   Windows   NT 软件 锁定 : LifeKeeper 管理 共享 磁盘 上 的 数据 , 以 防止 多个 服务器 在 同一时间 访问 数据 。 LifeKeeper 在 逻辑设备 级 （ 卷 ） 上 控制 对 数据 的 访问 , 并 让 Windows   NT 软件 或硬件 RAID   Controllers 管理 物理 级 。 有 了 Lifekeeper   For   Windows   NT 来 管理 对 共享 数据 的 访问 , 用户 就 可以 不必 担心 群中 的 其它 服务器 访问 数据 时 , 可能 会 带来 的 数据 访问 冲突 。 LifeKeeper 自动 在 被 应用 程序定义 为 共享资源 的 磁盘 卷上 设置 锁定 。 当 被 保护 的 应用程序 由 一个 服务器 被 移动 / 转换 到 另 一个 服务器时 , LifeKeeper 控制 这些 锁定 , 只 保证 激活 服务器 对 共享 卷 的 访问 。 
 　 　 在 主 系统 发生 故障 的 情况 下 , 次 节点 系统 将 能够 在 磁盘 上 建立 SCSI 锁定 , 并 在 备份 的 系统 上将 资源 投入使用 。 
 　 　 （ 2 ） Local   Recovery （ 局部 恢复 ） 
 　 　 LifeKeeper   2.0 在 快速 检查 （ Quickcheck ） 和 深入 检查 （ deepcheck ） 的 时间 间隔 执行 预先 定义 的 行为 , 以 察看 资源 本身 是否 失效 。 如果 快速 检查和 深入 检查 均 局部 告 失败 , 系统 将 尝试 局部 恢复 资源 。 如果 尝试 成功 , 资源 将 不会 向下 一 优先级 的 节点 进行 失效 切换 （ failover ） 。 如果 局部 恢复 尝试 失败 , 系统 将 向下 一 优先级 的 节点 进行 失效 切换 。 
 　 　 例如 , 你 可以 在 LifeKeeper 服务器 上 配置 多块 N IC卡 , 当 定义 的 NIC 发生 故障 时 , 就 可以 配置 将 IP 资源 切转 到 另 一个 NIC 上 , 从而 避免 不必要 的 失效 切换 。 
 　 　 （ 3 ） Failover （ 失效 切换 ） 
 　 　 指定 主要 的 节点 或 资源 失败 时 , 重新 恢复 资源 的 过程 。 一个 失效 切换 通常 是 没有 事先 计划 的 , 它 将 发生 在 被 从属 系统 所 检测 到 并 确定 为 失败 的 情况 下 。 
 　 　 （ 4 ） ACS （ 管理员 可 配置 的 迁回 ） 
 　 　 Administrator   Configurable   Switchback （ ACS ） 允许 LifeKeeper 管理员 通过 命令行 或 GUI 界面 来 指定 资源 , 其 所在 LK 节点 发生 故障 而后 又 恢复正常 , 该 资源 将 被 自动 地 切换 回到 原来 节点 上 。 可能 的 值 是 Intelligent （ 智能 的 ） 和 Automatic （ 自动 的 ） 。 如果 选择 Automatic , 那么 , 一旦 发生 故障 的 节点 回到 服务 状态 时 , 被 配置 失效 切换 的 层次 都 将 被 切换 回到 该 节点 上 。 如果 策略 是 Intelligent , 即使 当 发生 故障 的 节点 回到 服务 状态 时 , 被 配置 失效 切换 的 层次 也 会 留在 它们 被 失效 切换 到 的 节点 上 , 等待 由 管理员 决定 合适 的 时候 进行 切换 。 
 　 　 （ 5 ） Switchover （ 正常 切换 ） 
 　 　 指 用 一个 有 顺序 的 方式 关闭 资源 , 然后 将 它们 恢复 到 一个 备用系统 的 过程 。 在 通常 发生 在 当 你 处于 维护 或者 测试 模式 中 的 情况 下 , 这时 , 没有 任何 东西 失败 。 
 　 　 3 . 工作 方式 
 　 　 （ 1 ） Active / Standby 
 　 　 如图 2 所示 , 在 1 个 激活 / 备用 对 中 , 主 节点 处于 处理 状态 , 从属 节点 处于 备用 状态 , 以防 主 节点 上 发生 失败 。 备用系统 可以 是 一个 小 一点 、 性能 低 一点 的 系统 。 但是 , 当主 节点 失败 时 , 它 必须 有 保证 资源 可用性 的 处理 能力 。 例如 , 假设 NT   Server1 是 主 “ 激活 ” 节点 , NT   Server2 是 次 “ 备用 ” 节点 。 如果 NT   Server1 发生 了 故障 , 它 的 被 保护 资源 由 NT   Server2 节点 来 恢复 。 当 节点 NT   Server1 恢复 后 , 资源 可以 从 NT   Server1 重新 获得 。 然而 , 当 NT   Server2 节点 失败 时 , NT   Server2 节点 上 并 没有 需要 被 NT   Server1 节点 恢复 的 资源 。 
 
 图 2   Active / Standby 工作 方式 示意图 
 　 　 （ 2 ） Active / Active 
 　 　 如图 3 所示 , 在 1 个 激活 / 激活 对 中 , 2 个 节点 都 是 激活 的 处理器 , 但是 它们 也 可 分别 作为 其 对应 节点 上 的 资源 和 资源 层次 的 从属 节点 。 
 
 图 3   Active / Active 工作 方式 示意图 
 　 　 在 激活 / 激活 的 图表 中 , 有 2 个 主要 应用 : APPA 处于 Volume   W : , 并且 在 NT   Server1 上 激活 。 APPB 存储 在 Volume   M 上 , 并且 在 NT   Server2 上 激活 。 在 这 一 配置 中 , NT   Server1 应该 是 Volume   W ： \ 资源 的 主 节点 。 NT   Server2 应该 是 Volume   M ： \ 资源 的 主 节点 。 
                 当 NT   Server2 失败 时 , LifeKeeper 应该 将 Volume   M ： \ 转换 到 NT   Server1 上去 。 如果 系统资源 是 足够 的 , 这一 转换 不会 影响 到 已 在 NT   Server1 上 运行 的 APPA , 转换 只是 简单 地 将 NT   Server2 上 需 保护 应用程序 （ APPB ） 加到 NT   Server1 的 运行 负载 上去 。 
 　 　 （ 3 ） N - Way   （ N = 3 , N = 4 … … N = 16 ） 
 　 　 如图 4 所示 , N - Way 配置 是 激活 / 激活 或 激活 / 备用 的 1 个 有 3 ～ 16 个 服务器 的 扩展 。 服务器 A 被 配置 为 服务器 B 和 服务器 C 的 备份 。 而且 , 服务器 A 可以 被 配置 为 除了 服务器 B 和 服务器 C 的 其它 服务器 的 备份 。 当 任何 一个 服务器 发生 故障 时 , 被 保护 的 应用程序 被 从 该 服务器 上 转到 备用 的 服务器 上 。 
 
 图 4   N - Way 工作 方式 示意图 
 　 　 在 N - Way 配置 中 , 可以 配置 Cascading   Recovery （ 层叠 恢复 ） 。 当主 节点 发生 故障 时 , 层叠 恢复 允许 多个 从属 节点 被 按照 一定 的 优先级 次序 恢复 一个 资源 或 层次 。 
 3   NCR   LifeKeeper 的 关键 特点 
 　 　 1 . 不用 增加 任何 额外 硬件 投资 , 纯 软件 方式 实现 双机 容错 , 且 对 备份 机无 硬件 配置 要求 。 
 　 　 2 . 可 支持 Notes 、 Exchange 、 SQL   Server 、 Sybase 、 Informix 、 Oracle 、 SAP 等 多种 系统 的 应用层 热 恢复 。 
 　 　 3 . 是 同时 支持 NT 操作系统 和 UNIX 平台 的 容错 软件 。 支持 远程 灾难 备份 。 
 　 　 4 . 支持 共享 磁盘阵列 柜 和 扩展 镜像 二种 方式 , 给 用户 提供 了 选择 上 的 灵活性 , 同时 也 能 适应 各种 机型 、 网络结构 、 软件平台 及 应用 系统 。 
 　 　 5 . LifeKeeper 在 扩展 镜像 或 共享 磁盘阵列 任意 方式 下 , 均 能 实现 二台 NT 服务器 各自 运行 不同 应用 且 相互 热 备份 , 即 实现 双 Active 运转 模式 。 
 　 　 6 . 使用 共享 磁盘阵列 柜 方式 时 , 最 多 可以 支持 16 个 节点 , 远远 大于 其它 类似 系统 所 支持 的 2 个 节点 数 。 
 　 　 7 . 最大 限度 地 保护 用户 端的 应用 连续性 。 用户 的 硬件资源 （ 如 网卡 ） 及 软件资源 （ 如 NT 操作系统 、 数据库 管理系统 、 数据库 应用 系统 、 电子邮件系统 等 ） 均 能 处于 LifeKeeper 的 保护 之下 , 当 这些 被 保护 资源 出现 技术 故障 时 , LifeKeeper 可 随时 实施 系统资源 切换 。 如此 , LifeKeeper 真正 实现 了 用户 硬件 或是 软件资源 发生 故障 时 系统 及 应用层 上 的 在线 热切 换 。 
 　 　 8 . LifeKeeper 占用 系统资源 极少 , 不 增加 网络 负荷 , 且 不 打扰 任何 具体 应用 系统 的 任何 操作 。 
 　 　 9 . LifeKeeper 真正 实现 无人 值守 , 全自动 地 实现 应用 资源 切换 , 且 图形界面 操作 , 简单 方便 。 
 　 　 10 . 自 投入使用 以来 , 已 经历 了 大量 交易 高峰 的 实际 考验 , 其 执行 效率 很 高且 运行 十分 稳定 可靠 。 
 收稿 日期 ： 1999 - 12 - 25 
