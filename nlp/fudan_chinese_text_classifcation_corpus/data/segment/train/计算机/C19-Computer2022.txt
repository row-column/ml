微型机 与 应用 
 MICROCOMPUTER   &   ITS   APPLICATIONS 
 1999 年   第 18 卷   第 4 期   Vol.18   No.4   1999 
 
 
 
 NEC 单片机 78P014 在 X光 检查仪 控制器 中 的 应用 
 岳 胜利 
 　 　 摘 　 要 ： 介绍 了 使用 NEC 单片机 78P014 构成 的 X光 检查仪 控制器 ， 以及 对 检查仪 的 工作 过程 控制 及 电池组 维护 的 原理 及 软硬件 设计 。 
 　 　 关键词 ： X光 检查仪 控制器 　 78P014 单片机 　 锯齿 波 
 　 　 X光 检查仪 主要 用于 安全检查 。 X光 可穿透 被测 物体 ， 并 使 放于 物体 后面 的 X光 底片 曝光 ， 达到 检查 目的 。 检查仪 以 脉冲 方式 发射 X光 ， 每个 脉冲 的 剂量 为 3mR ， 可 通过 预置 脉冲 个数 来 控制 底片 曝光 量 。 X光 的 产生 需 120kV 高 电压 ， 因此 升压 电路 需 较大 的 工作电压 和 电流 。 本 设备 为 便携式 ， 内置 24 节 Ni - Cd 可 充电电池 ， 因为 工作 时 必须 由 电池组 供电 ， 所以 在 实际 应用 中 ， 电池组 的 维护 非常 重要 。 为了 减轻 记忆效应 ， 需 定时 对 电池组 进行 充放电 维护 ， 因此 检查仪 控制器 须 完成 的 功能 主要 是 ： 接受 设置 、 启动 检查仪 工作 电源 发射 X光 ， 并 对 其 进行 计数 控制 、 测量 电池组 电压 及 对 其 进行 充放电 维护 。 
 1 　 硬件 组成 
 　 　 78P014 内置 32KBROM 、 1KBRAM 、 P0 ～ P6 共 46 条 I / O 口线 、 8 通道 8 位 A / D 转换器 、 WATCHDOG 等 功能 ， 只 需外 接晶振 和 复位 电路 即可 正常 工作 。 根据 MPU 的 资源 及 检查仪 控制器 须 完成 的 功能 ， 其 硬件 组成 如图 1 。 
 
 
 图 1 　 硬件 组成 图 
 　 　 ( 1 ) 功能键 输入 。 控制器 共 8 个 功能键 ， 由于 78P014 的 口 资源 很 丰富 ， 不 需要 用 3 * 3 键盘 ， 只 将 8 个键 分别 接至 P3.0 ～ P3.7 口 ， 简化 了 软件设计 。 
 　 　 ( 2 ) LED 显示 。 控制器 由 2 只 7 段 数字 LED 显示 脉冲数 ， 分别 接至 P5 、 P6 口 ， 直接 由 单片机 驱动 （ 78P014 的 口 输出 电流 最大 20mA ） 。 
 　 　 ( 3 ) 功率 驱动 输出 。 78P014 的 P2.1 、 P2.2 口 分别 为 充放电 控制 ， 经 电平 转换 后 驱动 相应 的 大功率 开关 管 。 P2.3 口 输出 放大 后 驱动 继电器 ， 由 继电器 控制 启动 X光 高压电源 。 
 　 　 ( 4 ) A / D 转换 。 由于 78P014 内置 A / D 转换器 ， 模拟量 转换 电路 非常简单 ， 只 需 对 电池组 电压 、 充电 电压 取样 后接 至 78P014 的 A / D 转换 输入 角 即可 ， 其 基准 电压 为 ＋ 5V ， 直接 由 ＋ 5V 电源 提供 ， 其他 工作 均 由 软件 完成 。 
 　 　 ( 5 ) 计数 脉冲 整形 。 X光 高压电源 启动 后 ， X光 以 脉冲 方式 发射 ， 脉冲 宽度 100ns ， 间隔 约 0.3 s 。 在 此 过程 中其 内部 传输 线路 可 输出 一 负极 性 锯齿 波 电压 ， 其 下降 沿 与 X光 脉冲 相对 应 ， 整形 后 可 用于 计数 控制 。 
 2 　 软 　 件 
 　 　 本 系统 的 软件 部分 主要 由主 程序模块 、 X光 发射 模块 、 电池 维护 模块 以及 被 这 3 个 模块 调用 的 读 键盘 子程序 、 A / D 转换 子程序 、 BCD 码 转换 子程序 、 LED 显示 子程序 、 定时器 中断 服务 子程序 等 组成 。 其 流程图 如图 2 。 
 
 
 
 
 图 2 　 流程图 
 　 　 ( 1 ) 主 程序模块 。 主 程序模块 完成 的 任务 是 根据 功能键 的 输入 ， 完成 发射 脉冲数 的 设置 、 RECALL （ 重复 上 1 次 脉冲数 ） 、 RESET 等 功能 ， 并 调用 其它 模块 完成 X光 发射 、 电池组 充放电 功能 。 78P014 完成 以上 工作 只 需 很少 的 时间 资源 ， 因此 大多数 时间 处于 等待 状态 。 为了 减少 系统 的 电流 消耗 ， 78P014 在 等待 时 进入 休眠状态 ， 此时 CPU 停止 工作 ， 时钟 信号 只供 内部 定时器 工作 ， 定时器 溢出 后 CPU 解除 休眠 ， 重新 回到 主程序 。 
 　 　 ( 2 ) X光 发射 控制 模块 。 当主 模块 接收 到 发射 命令 后 ， 即 调用 X光 发射 控制 模块 。 该 模块 首先 判断 是否 需要 延时 ， 如 需要 则 延时 10s 后 启动 脉冲 高压电源 。 在 发射 过程 中该 模块 对 检查仪 返回 的 信号 （ 即 整形 后 的 锯齿 波 ） 去 抖动 、 计数 。 当 发射 的 脉冲数 与 设定 相等 时 ， 关闭 脉冲 高压电源 ， 并 记录 已 发射 的 脉冲数 。 
 　 　 ( 3 ) 电池 维护 模块 。 当 “ 充电 键 ” 被 按 下 、 且 220V 充电 电缆 插头 已 接通 时 ， 主程序 调用 电池组 维护 模块 。 该 模块 首先 检测 “ 充电 键 ” 是否 放开 ， 如该 键 持续 按住 3s ， 则 程序 进入 放电 － 充电 模式 ， 否则 进入 充电 模式 。 在 放电 过程 中 ， 当 电池 电压 下降 到 额定 放电 电压 以下 时 ， 停止 放电 ， 转入 充电 模式 。 在 充电 过程 中 ， A / D 转换器 每隔 100ms 检测 1 次 电池组 电压 （ 检测 过程 中 充电 暂时 停止 ） ， 并 计算 电池组 电量 是否 充满 。 电池组 电量 充满 的 算法 ： 
 　 　 ① 电池组 电压 是否 高于 额定 电压 Vmax ？ 
 　 　 ② 电池组 电压 是否 开始 下降 ？ 
 　 　 ③ 充电 时间 到 。 
 　 　 当 以上 3 个 条件 中 的 任 1 条 满足 时 ， 即可 确认 电池组 电量 已 充满 ， 此时 停止 充电 ， 返回 主程序 。 
 　 　 该 控制器 已于 1998 年 5 月 正式 取代 原来 的 分立元件 控制器 ， 工作 稳定 可靠 、 未 出现异常 情况 。 
 作者 单位 ： 北京 瑞琦 时代 公司 技术 开发部 （ 100080 ） 
 参考文献 
 　 1 　 NEC 公司 . NEC 单片机 用户手册 
 　 2 　 NEC 公司 . RA78K0 汇编程序 包 （ 操作 ） 
 　 3 　 NEC 公司 . RA78K0 汇编程序 包 （ 汇编语言 ） 
 收稿 日期 ： 1998 - 10 - 03 
