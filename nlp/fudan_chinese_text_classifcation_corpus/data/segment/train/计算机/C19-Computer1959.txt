微型机 与 应用 
 MICROCOMPUTER   &   ITS   APPLICATIONS 
 1999 年   第 18 卷   第 1 期   Vol.18   No.1   1999 
 
 
 
 超媒体 系统 中 ODBC 通用 查询 接口 的 设计 与 实现 
 宋 四根 　 吴玲达 　 庄世杰 
 　 　 摘 　 要 ： 开放 数据库 互连 ( ODBC ) 的 一般 工作 原理 和 基本 的 体系结构 ， 以及 在 超媒体 系统 中 使用 ODBC 技术开发 一个 关系数据库 通用 查询 接口 的 设计 思想 与 实现 方法 。 
 　 　 关键词 ： 超媒体 　 开放 数据库 互连 ODBC 　 数据源 　 驱动程序 
 1 　 ODBC 的 工作 原理 和 体系结构 
 　 　 ODBC 通过 驱动程序 使 应用程序 独立 于 数据库 管理系统 。 驱动程序 是 1 个 用以 支持 ODBC   API 调用 的 模块 ( 通常 是 1 个 DLL ) ， 应用程序 通过 调用 驱动程序 所 支持 的 API 函数 来 操纵 数据库 。 应用程序 要 操作 不同 的 数据库 就要 动态 地 链接 到 不同 的 驱动程序 上 。 ODBC 的 基本 结构 如图 1 所示 。 
 
 图 1 　 ODBF 的 体系结构 
 　 　 ODBC 将 数据源 映射 为 适当 的 驱动程序 、 网络软件 、 服务器 名称 或 地址 以及 DBMS 中 的 上下文 。 DBMS 处理 来自 ODBC 驱动程序 的 请求 ， 并 将 结果 返回 给 驱动程序 。 
 　 　 当前 关系数据库 产品 分 2 类 ： 一类 是 本地 型 ( Local ) ， 如 xBase 、 Foxpro 等 ； 另一类 是 客户 / 服务器 型 ( Client / Server ) ， 如 Oracle 、 Sybase 等 。 因此 作为 ODBC 中介 的 驱动程序 也 分 2 类 ： 单级 驱动程序 与 多级 驱动程序 。 单级 驱动程序 相当于 本地 型 的 DBMS ， 即 充当 了 数据库 引擎 。 多级 驱动程序 负责 在 数据库 引擎 和 应用程序 间 传送 命令 和 数据 ， 它 不 进行 数据处理 ， 仅起 1 个 中间 翻译 的 作用 ， 即将 请求 翻译成 给定 的 数据库 通信接口 所 能 理解 的 形式 ， 服务器 上 的 数据库 引擎 处理 并 将 结果 返回 。 图 2 给出 了 应用 在 这 2 类 数据库系统 中 的 ODBC 结构 。 
 
 图 2 　 2 类 数据库系统 的 ODBG 结构组件 
 2 　 ODBC 通用 查询 接口 的 设计 与 实现 
 　 　 超媒体 系统 是 由 节点 ( 信息 块 ) 和 链 ( 块间 转移 ) 构成 1 个 信息网 ， 它 通过 节点 、 链 机制 管理 和 浏览 网上 的 多媒体信息 。 节点 可以 由 单一 媒体 窗口 组成 ， 也 可以 由 多种类型 媒体 窗口 组成 。 为了 能 在 超媒体 系统 中 浏览 到 网上 众多 数据库 信息 ， 我们 在 超媒体 系统 中 引入 了 ODBC 类 媒体 节点 ( 暂且 把 各种 关系数据库 信息 媒体 统称 为 ODBC 类 媒体 ) ， ODBC 类 媒体 与 其它 类 媒体 如 ： 文本 、 图形 、 图像 、 声音 、 视频 、 动画 等 媒体 一样 可以 在 超媒体 系统 中 进行 编辑 和 表现 。 
 　 　 超媒体 系统 中 ODBC 通用 查询 接口 的 设计 与 实现 包括 2 个 部分 ： ( 1 ) ODBC 通用 查询 系统 的 设计 与 实现 ， 其 设计 与 实现 方法 是 把 ODBC 通用 查询 系统 作为 1 个 窗口 类来 实现 ， 即 对 网上 各种 数据库 的 任意 查询 操作 均 定义 在 此 窗口 类中 ， 暂且 称该 窗口 类为 ODBC 通用 查询 窗口 类 。 这里 “ 通用 查询 ” 的 意思 是 用户 可任意 选择 数据库 、 表 、 列 和 条件 等 进行 查询 ， 它 以 1 个 通用 查询 窗口 作为 用户界面 。 ( 2 ) ODBC 通用 查询 系统 与 超媒体 系统 的 接口 部分 ， 其 设计 与 实现 方法 是 把 ODBC 类 媒体 窗口 ( ODBC 通用 查询 窗口 类 的 1 个 对象 ) 作为 1 个 节点 ， 在 超媒体 系统 中 对 该 节点 进行 节点 编辑 、 链 的 建立 及其 表现 ， 从而 实现 超媒体 系统 与 ODBC 通用 查询 接口 的 无缝 连接 。 
 　 　 我们 采用 Windows   95 环境 下 Visual   C++ 4.2 作为 开发工具 ， 使用 ODBC   API 函数 和 强大 的 MFC 类库 进行 编程 实现 。 
 2.1 　 ODBC 类 媒体 
 　 　 1 . ODBC 类 媒体 节点 编辑 
 　 　 在 超媒体 系统 的 节点 编辑 窗口 中 提供 了 编辑 各类 媒体 的 工具条 按钮 。 当 用户 选择 ODBC 类 媒体 编辑 后 ， 系统 在 节点 编辑 窗 中弹 出 1 对话框 让 用户 输入 ODBC 类 媒体 属性 值 ， 输入 完毕 后 关闭 对话框 ， 则 在 节点 编辑 窗口 中 生成 1 个 ODBC 类 媒体 窗口 ， 即 ODBC 通用 查询 窗口 ， 用户 可 移动 和 放大 缩小 窗口 。 编辑 完后 通知 超媒体 系统 保存 该 ODBC 通用 查询 窗口 属性数据 ( 如 窗口 的 位置 和 大小 等 属性 ) 。 数据 的 存储 和 读取 由 超媒体 系统 的 文档 类 统一 负责 。 
 　 　 2 . ODBC 类 媒体 节点 表现 
 　 　 当 用户 在 进行 超媒体 系统 的 表现 时若 鼠标 触发 了 1 条超链 ， 而 其链 宿为 ODBC 类 媒体 节点 ， 则 系统 读取 由 上面 存储 的 ODBC 通用 查询 窗口 属性数据 ， 并 生成 该 ODBC 通用 查询 窗口 。 此时 用户 可 在 该 窗口 中 进行 数据源 的 连接 、 表和列 的 选择 、 查询 条件 的 任意 选择 、 执行 查询 并 显示 查询 结果 等 操作 。 
 　 　 3 . ODBC 类 媒体 链 的 设计 
 　 　 链源 和 链宿 可以 是 节点 、 媒体 窗口 或 媒体 数据 片段 。 对于 ODBC 通用 查询 窗口 没有 必要 把 链建 在 ODBC 通用 查询 窗口 中 的 数据 片断 上 ， 这里 把 由 ODBC 类 单一 媒体 窗口 组成 的 节点 作为 链源 或 链宿 ， 该链 的 建立 由 超媒体 系统 来 统一 完成 。 
 2.2 　 ODBC 通用 查询 窗口 类 的 设计 
 　 　 上述 ODBC 类 媒体 节点 的 编辑 与 表现 以及 链 的 建立 是 超媒体 系统 与 ODBC 通用 查询 系统 的 接口 部分 ， 利用 超媒体 系统 的 节点 编辑 模块 、 链 编辑 模块 以及 表现 模块 进行 ODBC 类 媒体 节点 的 编辑 、 链 编辑 和 节点 表现 。 把 ODBC 通用 查询 系统 作为 1 个 窗口 类来 实现 ， 即 对于 查询 网络 上 的 各种 关系数据库 信息 所 进行 的 操作 全部 定义 在 1 个 由 CWnd 派生 的 ODBC 通用 查询 窗口 类中 ， 在 类 的 构造函数 中 通过 调用 Create ( ) 和 ShowWindow ( ) 函数 生成 带有 滚动条 的 窗口 。 有 了 ODBC 通用 查询 窗口 类后 ， 只须 在 超媒体 系统 的 节点 编辑 和 表现 模块 中 分别 定义 1 个 该 窗口 类 的 对象 ， 通过 给 窗口 构造函数 传递 不同 的 参数 ， 并 调用 new 操作 分别 生成 编辑 窗口 和 表现 窗口 。 
 　 　 ODBC 通用 查询 窗口 类 总 的 设计 目标 是 ： 用户 通过 该 查询 窗口 能以 一致 的 界面 查询 网上 各种 不同 类型 的 关系数据库 信息 。 具体 应 具有 以下 几 方面 功能 ： 
 　 　 1 . 一致 的 用户 查询 界面 ， 包括 用户 选择 数据源 、 表 、 列 界面 、 用户 交互 输入 查询 条件 的 界面 以及 查询 结果显示 等 界面 。 
 　 　 2 . 对 数据源 、 表 、 列 、 条件 等 用户 可任意 选择 ， 包括 增 、 删 、 减等 操作 ， 充分体现 查询 操作 的 通用性 。 
 　 　 3 . 可以 选择 多表 联合 查询 ， 可以 对 查询 结果 进行 分组 和 排序 。 
 　 　 4 . 用户 交互 选择 表 、 列 、 条件 等 内容 后 系统 自动 在 后台 生成 1 个 SQL 语句 进行 数据库 的 查询 。 系统 同时 提供 1 个 可 直接 写入 SQL 语句 进行 查询 的 接口 ， 以便 让 那些 对 SQL 语言 非常 熟悉 的 用户 进行 更 高级 的 查询 。 
 2.3 　 ODBC 通用 查询 窗口 类 的 实现 
 　 　 1 个 ODBC 应用 系统 的 实现 大致 经过 以下 几步 ： 分配 ODBC 环境 和 连接 句柄 、 与 数据源 连接 、 分配 语句 句柄 、 语句 处理 与 检索 、 释放 语句 句柄 、 与 数据源 断开 、 释放 连接 句柄 和 环境 。 因此 ， 根据 ODBC 通用 查询 窗口 类 的 设计 目标 以及 ODBC 应用 系统 的 基本 结构 要求 ， 其 主要 的 实现 方法 如下 ： 
 　 　 1 . 在 构造函数 中 调用 Create ( ) 函数 生成 1 个 带 滚动条 的 窗口 ， 该 窗口 用来 显示 查询 结果 。 分配 ODBC 环境 句柄 ， 在 其析构 函数 中 释放 环境 句柄 。 
 　 　 2 . 在 窗口 中 按 下 鼠标 左键 则 生成 1 个 弹出式 菜单 ， 即 在 类 的 OnLButtonDown ( ) 成员 函数 中 调用 CreatePopupMenu ( ) 函数 生成 1 个 弹出式 菜单 。 菜单 包括 ： 连接 数据源 、 断开 数据源 、 选择 表 、 选择 表 连接 、 选择 列 、 选择 条件 、 选择 排序 / 分组 、 SQL 语句 、 执行 查询 等 菜单项 。 
 　 　 3 . 连接 数据源 。 在 该 菜单项 对应 的 函数 中 分配 连接 句柄 ， 通过 调用 SQLDriverConnect ( ) 显示 数据源 列表 让 用户 选择 1 个 数据源 进行 连接 ， 最后 分配 语句 句柄 。 
 　 　 4 . 断开 数据源 。 在 该 菜单项 对应 的 函数 中 释放 语句 句柄 、 与 数据源 断开 、 释放 连接 句柄 。 
 　 　 5 . 选择 表 。 在 该 菜单项 对应 的 函数 中 通过 调用 SQLTables ( ) 函数 查询 出 数据源 中 的 所有 表名 ， 它 还 定义 1 个表 选择 对话框 类 对象 并 显示 该 对话框 ， 在 初始化 对话框 时 把 所有 表名 、 所有者 名及 限定词 放入 对话框 的 对应 列表 控件 中 让 用户 选择 要 查询 的 表 。 用户 选择 完后 将 所选 的 表名 保存 到 1 个表串 中 。 
 　 　 6 . 选择 列 。 在 该 菜单项 对应 的 函数 中 通过 调用 SQLCols ( ) 函数 查询 出 用户 选择 的 表 的 所有 列名 ， 它 定义 1 个列 选择 对话框 类 对象 并 显示 该 对话框 ， 在 初始化 对话框 时 把 所有 列名 放入 对话框 中列 ( Column ) 列表 控件 中 让 用户 选择 要 查询 的 列 。 用户 选择 完后 保存 所选 的 列名 到 1 个 列串 中 。 
 　 　 7 . 选择 条件 。 在 该 菜单项 对应 的 函数 中 通过 调用 SQLCols ( ) 函数 查询 出 用户 上面 选择 的 表 的 所有 列名 ， 它 定义 1 个 条件 选择 对话框 类 对象 并 显示 该 对话框 ， 在 初始化 对话框 中列 的 列表 控件 中 让 用户 选择 要 输入 条件 的 列 。 该 对话框 还 包括 操作符 列表 控件 、 条件 值 编辑 控件 等 。 用户 选择 完后 保存 所选 的 条件 到 1 个 条件 串中 。 
 　 　 对于 上述 用户 选择 表 、 列 、 条件 后 系统 自动 生成 1 个 SQL 语句 ， 若 用户 修改 了 已 选择 的 表 、 列 、 条件 等 内容 ， 系统 也 自动 修改 已 生成 的 SQL 语句 。 
 　 　 8 . 生成 SQL 语句 。 该 菜单项 显示 自动 生成 的 SQL 语句 对话框 ， 用户 也 可 在 SQL 语句 编辑 控件 中 修改 这一 SQL 语句 或 直接 输入 1 个 新 的 SQL 语句 。 
 　 　 9 . 执行 查询 。 该 菜单项 调用 SQLExecDirect ( ) 函数 执行 查询 并 使 窗口 重画 以 显示 查询 结果 。 结果显示 由 窗口 类 的 OnPaint ( ) 成员 函数 实现 ， 滚动 显示 查询 结果 由 OnVScroll ( ) 与 OnHScroll ( ) 2 个 成员 函数 来 实现 。 
 　 　 上面 简单 介绍 了 窗口 类中 几个 主要 成员 函数 的 实现 方法 ， 对于 窗口 类中 其它 一些 功能 成员 函数 的 实现 在 这里 不再 一一 列出 。 
 作者 单位 ： 长沙 国防科技大学 七系 研究生 队 ( 410073 ) 
 参考文献 
 　 1 　 孟小峰 译 . 开放 数据库 互连 — ODBC2 使用 大全 . 北京 ： 清华大学出版社 ， 1995 
 　 2 　 侯雪萍 译 . 开放式 数据库 互连 ODBC 方案 集粹 . 北京 ： 电子 工业 出版社 ， 1995 
 　 3 　 王国 印译 . Visual   C++ 技术 内幕 . 北京 ： 清华大学出版社 ， 1996 
 ( 收稿 日期 ： 1998 - 06 - 12 ) 
