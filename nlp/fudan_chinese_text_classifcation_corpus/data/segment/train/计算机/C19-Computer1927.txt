微型机 与 应用 
 MICROCOMPUTER   &   ITS   APPLICATIONS 
 2000 　 Vol.19 　 No.6 　 P.32 - 33 
 
 
 
 
 NAT 技术 及其 在 防火墙 中 的 应用 
 户 现锋 　 张 大陆 
 摘要 ： 讨论 了 NAT 的 工作 原理 及其 在 防火墙 中 的 应用 ， 并 对 NAT 技术 的 安全性 进行 了 分析 。 
 关键词 ： 网络地址 转换 技术   连接   防火墙   代理 
 　 　 随着 Internet 网 的 飞速发展 ， 每年 连入 的 主机 数 成倍增长 。 由于 开始 设计 Internet 网 的 时候 并 没有 考虑 到 这么 大 的 规模 ， 所以 分组 的 地址 选择 了 32 位 ， 它 可以 使 分组 的 格式 很 好 地 对齐 ， 但 Internet 网 面临 着 B 类 地址 耗尽 、 路由表 爆炸 和 整个 地址 耗尽 的 危机 。 网络地址 转换 NAT ( Network   address   translation ) 技术 和 无 类域 间 路由 ( CIDR ) 就是 为 解决 这些 问题 而 开发 的 一种 直接 的 解决方案 。 它 可以 使 Internet 网 得到 足够 的 喘息 时间 来 等待 新一代 IP 协议 的 出台 。 由于 NAT 技术 提供 了 一种 掩饰 网络 内部 本质 的 方法 ， 即 NAT 通过 1 个 外部 地址 来 响应 外部 世界 的 寻址 ， 从而 在 防火墙 中 得到 了 广泛 的 应用 。 
 1     NAT 技术 的 工作 原理 
 　 　 NAT 技术 的 基本功能 就是 用 1 个 或 几个 IP地址 来 实现 1 个 局域网络 上 的 所有 主机 都 可以 访问 Internet 。 NAT 技术 可以 为 TCP 、 UDP 以及 lcmp 的 部分 信息 进行 透明 中继 。 下面 以 TCP 为 主要 对象 讨论 其 工作 原理 。 
 　 　 TCP 是 建立 在 所谓 的 连接 抽象 （ connection   abstraction ） 之上 的 ， 它 所 对应 的 对象 不是 TCP 的 一个 单独 的 端口 而是 1 条虚 电路 连接 ， 也就是说 ， TCP 是 使用 连接 而 不是 使用 协议 端口号 作为 基本 的 抽象概念 。 在 TCP 中 连接 是 用 1 对 端点 来 标识 的 。 TCP 把 端点 （ endpoint ） 定义 为 一对 整数 （ host ， port ） ， 因此 可以 将 1 条 TCP 连接 用 1 个 4 元组 （ Source   address ： source   port ； destination   address ： destination   port ） 来 定义 ， 这样 的 一个 连接 抽象 允许 多个 连接 共享 1 个 端点 ， 例如 2 条 连接 （ 192.168 . 1.1 ： 1184 ； 192.168 . 1.3 ： 80 ） 、 （ 192.168 . 1.2 ： 1184 ； 192.168 . 1.3 ： 80 ） 共享 同 1 个 端点 （ 192.168 . 1.3 ： 80 ） ， 但 又 并 不会 引起 歧义 ， 从而 可以 看出 这种 基于 连接 的 抽象 为 利用 1 个 IP地址 进行 外部 世界 的 访问 提供 了 基础 。 实际上 ， 虽然 UDP 是 无 连接 的 ， 但 可以 将 它 作为 虚 连接 来 看待 。 
 　 　 NAT 网关 上 运行 的 TCP ／ IP 网关 软件 与 常规 的 网关 软件 并不相同 。 通常 常规 路由器 只是 机械 地 根据 IP 包中 的 目的 IP地址 以及 路由表 将 IP 数据 报从 一个 网络 转发给 另 一个 网络 ， 而 NAT 网关 在 Internet 内部 网络 和 Internet 之间 中继 IP 数据 报 并非 凭借 目的 IP地址 ， 它 的 中继 是 面向 连接 的 ， 如图 1 所示 。 
 
 图 1     网关 在 Internet 内部 网络 和 Internet 之间 中继 IP 数据 报 的 连接 
 　 　 假设 在 局域网 LAN   A 接入 Internet 处有 1 个 NAT 网关 ， 网关 处理 所有 网络 内外 之间 的 TCP ／ IP 连接 。 NAT 网关 具有 内 网 端口 和 外网 端口 ， 2 个 端口 各 被 分配 1 个 IP地址 ， 其中 外 网 端口 的 IP地址 是 合法 的 全球 唯一 的 IP地址 200.200 . 200.200 ， 内 网 端口 的 IP地址 一般 为 保留 地址 ， 如设 为 192.168 . 1.1 。 当 内部 网络 中 的 1 台 主机 ( 例如 A ) 要 访问 Internet 上 的 Web 服务器 X （ 主机 地址 为 202.202 . 202.202 ） ， 那么 首先 A 要 与 X 建立 TCP 连接 ， 设定 主机 A 为 此次 连接 分配 的 TCP 端口 为 1030 ， 此时 主机 A 将 IP 数据包 （ D ＝ 202.202 . 202.202 ： 80 ， S ＝ 192.168 . 1.2 ： 1030 ） 发向 NAT 网关 ， 当 NAT 接受 到 数据包 后 ， 会 动态 地 分配 1 个 未用 TCP 端口 ， 例如 1330 ， 然后 修改 数据包 中 的 地址 为 （ D ＝ 202.202 . 202 ： 80 ， S ＝ 200.200 . 200.200 ： 1330 ） ， 计算 数据包 的 校验 和 后发 向 Internet 。 由此 可以 看到 此 数据包 中 已经 不 含 任何 私有 地址 的 信息 。 NAT 已经 录下 这 对 映射 ： （ D ＝ 202.202 . 202.202 ： 80 ， S ＝ 192.168 . 1.2 ： 1030 ） （ D ＝ 202.202 . 202 ： 80 ， S ＝ 200.200 . 200.200 ： 1330 ） 。 以后 当 NAT 接受 到 这 1 对 主机 间 的 任何 1 个 IP 分组 时 ， NAT 网关 会 查询 内部 的 映射 记录 表格 ， 根据 这 条 映射 关系 使 其 顺利 通过 NAT ， 反之亦然 。 
 　 　 总之 ， NAT 的 地址 转换 过程 存在 3 个 不同 的 阶段 ： 
 　 　 ( 1 ) 连接 关系 的 映射 关系 的 建立 阶段 。 发生 在 会 话 的 开始 ， 当 内部 的 1 台 机器 要 与 外部 的 1 台 机器 发生 通信 时 发生 ， NAT 动态 地为 其 分配 未 使用 的 TCP 端口号 ， 并且 会 记下 这个 映射 关系 ， 为 以后 转发 IP 数据包 使用 。 
 　 　 ( 2 ) 映射 关系 的 查找 与 转换 阶段 。 当有 外部 进入 的 数据 报 或 从 内部 出去 的 数据 报 通过 NAT 时 ， NAT 都 在 内部 进行 了 查找 ， 以便 找到 对应 的 映射 进行 地址 转换 。 
 　 　 ( 3 ) 映射 关系 解除 阶段 。 当 TCP 的 1 次 连接 关闭 时 ， NAT 会 释放 分配 给 这条 连接 的 端口 ， 以便 以后 的 连接 可以 继续 使用 。 
 2     NAT 技术 在 防火墙 中 的 应用 
 　 　 防火墙 的 主要 功能 就是 防止 外部 主机 对内 网中 主机 的 非 授权 访问 ， 而 限制 从 外部 网络 到 内部 网络 的 连接 是 主要 技术 之一 ， NAT 具有 这种 功能 。 当外 网 的 主机 要 主动 访问 内网 的 主机 时 ， 一般 情况 下要 首先 与 内 网中 的 某台 主机 建立 连接 （ 多数 内网 不 允许 从 外部 发起 连接 ） ， 但是 ， 它 不 知道 内 网 主机 的 IP地址 （ 由 前面 的 分析 可知 ， 在 Internet 传输 的 IP 数据 报 并 没有 含有 内部 网络地址 的 私有 信息 ， 这样 ， 内网 中 的 主机 对于 外部 主机 是 不 可见 的 ， 它们 被 NAT 保护 起来 了 ） ， 其次 内 网 主机 地址 一般 是 内部 保留 地址 ， 不 允许 在 Internet 上 传输 ， 再次 NAT 内部 的 记录表 中 也 没有 与 这个 外部 来 的 连接 的 表项 ， 因此 不 允许 连接 的 请求 通过 NAT ， 这样 就 起到 了 防火墙 安全 防护 的 作用 。 
 　 　 另外 ， 通过 使用 代理 技术 也 可以 使用 1 个 IP地址 供 多个 用户 同时 上网 ， 但 这种 技术 的 一个 缺点 就是 需要 对 客户端 的 软件 进行 修改 和 配置 ， 给 用户 带来 很多 不便 。 更为重要 的 是 需要 为 每 一种 应用 都 编写 特定 的 代理服务器 ， 使得 系统 的 扩展性 不是 很 好 。 而 NAT 技术 则 工作 在 网络 中较 低 的 层次 ， 逻辑 上 是 工作 在 IP 层 ， 给 用户 连接 Internet 提供 了 更 大 的 透明性 ， 其 工作 则 更 像 一个 路由器 而 并非 一个 代理 网关 ， 同时 也 便于 网络应用 的 扩展 ， 并不需要 给 每种 新 的 应用 都 开发 一种 代理服务 。 由于 NAT 技术 并 没有 工作 在 应用层 （ 代理 网关 工作 在 应用层 ， 它 理解 提供 服务 的 每 一种 协议 细节 ） ， 从而 ， NAT 并不需要 理解 和 操纵 应用层 的 数据 ， 具有 更 高 的 效率 ， 使得 NAT 技术 在 防火墙 中 得到 应用 。 
 3     NAT 技术 的 安全性 分析 
 　 　 下面 ， 对 NAT 技术 的 安全性 做 一些 分析 。 
 　 　 ( 1 ) NAT 可以 作为 一个 单向 的 过滤器 ， 限制 从 外部 主机 到 内部 主机 的 连接 。 另外 当 端口地址 在 NAT 内 动态分配 时 ， 使得 外部 攻击者 对 NAT 域 中 的 一个 特定 主机 的 攻击 更加 困难 。 
 　 　 ( 2 ) 当 NAT 设备 不 在 安全 域 中时 ， 应用 级 的 负载 可以 进行 端到 端的 加密 ， 比如 利用 SSL 。 只要 负载 中 不 包含 IP地址 和 运输 层 的 端口 信息 ， 就 可以 提高 安全性 。 
 　 　 ( 3 ) 如果 将 NAT 设备 和 应用 网关 相结合 ， 可以 为 应用层 中 含有 IP地址 信息 的 连接 进行 地址 翻译 ， 确保 数据 报 不 含有 私有 的 地址 信息 ， 这样 NAT 可以 做到 对 协议 透明 ， 起到 透明 路由器 的 作用 。 
 　 　 ( 4 ) 由于 NAT 设备 是 作为 1 台 Internet 主机 出现 ， 因此 也 被 作为 攻击 的 对象 。 例如 易受 SYN   Flood 和 Ping   flood   attacks 攻击 ， 因此 应 采用 相应 的 技术 对 NAT 设备 进行 保护 。 
 　 　 ( 5 ) NAT 在 做到 地址 隐藏 的 同时 ， 也 减少 了 提供 安全 的 额外 选择 ， 例如 IPsec 的 选用 。 目前 ， 我们 正在 进行 二者 的 集成 与 开发 。 
 户 现锋 （ 上海 同济大学 计算机系 200092 ） 
 张 大陆 （ 上海 同济大学 计算机系 200092 ） 
 参考文献 
 1 ， Egevang   R ． Francis   P ． The   IP   Network   Address   Translator （ NAT ） ． RFC1631 ， 1994 ； （ 5 ） 
 2 ， Srisuresh   P ， Holdrege   M ． IP   Network   Address   Translator （ NAT ） Terminology   and   Considerations ． RFC2663 ， 1999 ； （ 8 ） 
 3 ， Rent   S ， Atkinson   R ． Security   Architecture   for   the   Internet   Protocol   RFC2401 ， 1998 ； （ 11 ） 
 4 ， IETF ． Security   L2TP   using ． IPSEC ， 1999 
 5 ， Netscape   Communication   Corp ． The   SSL   protocol   Version   3 ． 0 ， 1996 
 6 ， Tanenbaum   AS ． Computer   Networks ． Third   Edition ．   Prentice － Hall ， 1996 
 7 ， Huitema   C ． Routing   in   the   Internet ． 北京 ： 清华大学 出   版社 ， 1998 
 8 ， DOUGLAS   E ． COMER ． Internetworking   with   TCP ／ IP （ Vol   1 ） ． 北京 ： 电子 工业 出版社 ， 1998 
 9 ， Slattery   T ， Burton   W ． Advanced   IP   Routing   in   Cisco   Networks ． 北京 ： 机械 工业 出版社 ， 1999 ； （ 6 ） 
 收稿 日期 ： 1999 － 12 － 23 
