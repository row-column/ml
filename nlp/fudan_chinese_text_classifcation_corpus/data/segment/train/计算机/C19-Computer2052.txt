计算机 工程 
 Computer   Engineering 
 1999 年 　 第 25 卷 　 第 4 期 　 Vol.25 　 No.4 　 1999 
 
 
 
 数据库 复制技术 的 改进 
 － － － 按 归属 分送 的 数据 分送 方法 
 刘 清波 
 摘 　 要 　 根据 《 厦门市 信贷 产 监测 网络 》 的 需要 ， 提出 了 对 数据库 复制 的 层次结构 和 安全性 等 要求 ， 然后 简要 介绍 了 MS   SQL   Server6.5 的 数据库 复制 机制 ， 最后 描述 了 为 该 需求 而 设计 的 按 归属 分送 的 解决方案 与 算法 。 
 关键词 　 分布式 数据库 复制 归属 出版物 横向 提取 纵向 提取 
 The   Improvement   of   Distribution   Database   Replication 
 - - A   Distributing   Methods   According   to   Data   Ascription 
 Liu   Qingbo 
 ( People ' s   Band   of   china , Xiamen   Branch   Xiamen   Branch   Xianmen   361004 ) 
 Abstract : According   to   the   requirement   of   《 Credit   Registering   Network   System   in   Xiamen 》 , this   paper   presents   the   in   hierarchical   structure   and   security   of   database   replication , introduces   the   replication   mechanism   of   MS   SQL   server   6.5 , then   describes   the   plan   and   algorithms   designed   for   the   requirement . 
 Key   words : Distribution ; Database ; Replication ; Ascription ; Publication ; Horizontal   partition ; Vertical   partition 
 　 　 尽管 数据库 复制技术 已经 趋于 实用 ， 但 在 厦门市 信贷 资产 监测 网络 的 分布式 数据库系统 的 设计 和 实现 时 仍 遇到 一些 技术难题 ， 其中 比较突出 的 有 两个 ， 其一 、 异构 型 数据库 之间 的 复制 ； 其二 ， 不同 数据库 之间 安全性 问题 。 这里 主要 讨论 第二个 问题 。 由于 厦门市 信贷 资产 监测 网络 是 一个 由 人民银行 组织 各家 金融机构 共同 组建 的 网络 ， 其 数据 是 各家 金融机构 的 信贷 数据 。 在 这样 由 多个 单位 共同 建设 的 系统 中 ， 数据库 的 安全性 显得 格外 重要 。 在 该 系统 中 ， 数据库 的 安全性 主要 体现 在 各家 金融机构 在 能够 共享 其 客户 在 其他 金融机构 的 信贷 信息 的 同时 ， 要 保证 自己 的 大部分 信贷 数据 和 汇总 统计数字 不会 泄漏 给 其他 金融机构 。 因此 我们 改进 了 MS   SQL   Server   6.5 的 数据库 复制技术 ， 提出 了 一种 能够 区分 不同 数据库 服务器 的 按 归属 的 分送 方法 。 
 1 　 MS   SQL   Server   6.5 数据库 复制 机制 
 　 　 在 MS   SQL   Server   6.5 中 ， 数据库 服务器 按照 其 在 复制 中 的 角色 被 分为 三类 ： 出版 服务器 、 分发 服务器 和 订阅 服务器 。 出版 服务器 上 的 数据库 可以 定义 为 出版 数据库 ， 出版 数据库 是 数据 的 发源地 。 订阅 服务器 的 数据库 是 出版 数据库 的 复制品 ， 订阅 服务器 是 数据 分发 的 目的地 。 分发 服务器 完成 数据 分送 ， 从 出版 数据库 读取 改变 的 数据 ， 并 在 分送 数据库 中 排队 ， 然后 发送给 订阅 服务器 或 等待 订阅 服务器 来 读取 。 数据库 的 复制 可以 复制 整个 数据库 ， 或者 只 复制 数据库 一部分 ， 用户 通过 条目 和 出版物 规定 复制 的 范围 。 
 　 　 条目 　 条目 是 数据库 复制 的 基本 单位   ,     条目 包含 的 数据 产生 于 单一 的 需要 复制 的 表 。 
 　 　 出版物 　 出版物 是 一组 条目 。 一个 出版物 可以 包含 一个 或 多个 条目 ， 一个 数据库 可以 建立 一个 或 多个 出版物 。 出版物 一般 也 作为 订阅 单位 ， 但是 订阅 者 也 可以 订阅 多个 出版物 或者 只 订阅 某一 出版物 的 某些 条目 。 出版物 的 复制 方法 有 计划表 和 交易 日志 两种 。 
 
 图 1 　 SQL   Server 复制 模型 
 　 　 横向 提取 和 纵向 提取         条目 可以 取自 某 一张 表 的 的 部分 列 ， 这种 方法 称为 纵向 提取 。 条目 可以 定义 为 某 一张 表 的 子集 ， 这种 条目 包含 基本 表 的 部分 行 ， 这种 方法 成为 横向 提取 。 横向 提取 可以 通过 过滤 条件 表达式 加以 约束 或 过滤 过程 加以 过滤 。 
 　 　 MS   SQL   Server 复制 的 主要 功能 部件 是 ： 日志 阅读 进程 ， 同步 进程 ， 分发 进程 和 分发 数据库 。 日志 阅读 进程 将 出版 服务器 交易 日志 中 带有 复制 标志 的 交易 送到 分发 数据库 。 同步 进程 主要 负责 产生 出版 表 的 创建 语句 ， 形成 初始 同步 文件 ， 以及 在 分发 数据库 中 记录 同步 作业 。 分发 进程 将 存储 在 分发 数据库 的 交易 和 初始 同步 作业 传送 到 订阅 服务器 。 分发 数据库 是 一种 存储转发 数据库 ， 它 寄存 着 所有 准备 发送到 订阅 服务器 的 交易 。 
 2   按 数据 归属 分送 的 数据 分送 方案 
 　 　 MS   SQL   Server 的 数据库 复制 机制 能够 满足 普通 应用 的 要求 。 但是 对于 一些 大型 应用 ， 这些 功能 就 显得 有些 不够 。 厦门市 信贷 资产 监测 网络 对 数据库 复制 的 安全性 有着 特别 的 需求 ， 这个 特别 的 需求 包括 两个 方面 ： 第一 、 金融机构 所 订阅 的 数据 必须 是 自己 的 数据 ； 第二 、 金融机构 的 上下级 层次结构 ， 上级 订阅 的 数据 必须 包括 其 下级 的 数据 。 
 　 　 MS   SQL   Server   所 提供 的 分布式 数据库 的 复制 功能 无法 满足 这个 特殊 需求 ， 因此 ， 必须 加以 改造 ， 进一步 扩充 。 MS   SQL   Server 是 以 存储 过程 的 形式 实现 数据库 的 复制 ， 这种 形式 为 用户 提供 可以 调用 的 接口 ， 便于 扩充 和 改造 。 
 　 　 在 厦门市 信贷 资产 监测 网络 的 设计 时 ， 为了 满足 上述 需要 ， 我们 对 MS   SQL   Server 所 提供 的 分布式 数据库 的 复制 功能 加以改进 。 提出 了 一种 能够 区分 不同 数据库 服务器 的 按 数据 归属 分送 的 数据 分送 方案 。 该 方案 包括 以下 措施 ： 
 　 　 1 ) 金融机构 的 描述 ： 城市 级 的 金融 可以 分为 三个 层次 ： 分行 级 、 支行 级 和 办事处 级 ， 分别 用 Bank 、 Branch 、 Offices 表来 描述 。 每层 的 机构 都 可能 办理 信贷业务 ， 这 类 机构 称为 信贷 机构 ，       用 Creditor 表 表示 。 
 　 　 2 ) 服务器 归属 ： 每个 订阅 服务器 有 一个 唯一 的 号码 区别 其他 服务器 ， 同时 拥有 其 本身 的 银行 ID 、 支行 号 和 办事处 号 。 < 银行 ID ， 支行 号 和 办事处 号 > 定义 了 该 服务器 属主 。 
 　 　 3 ) 业务 数据 的 归属 ： 每 一笔 业务 数据 均 属于 某 一个 信贷 机构 ， 在 数据库 中 ， 信贷 机构 标识 Cred _ ID 作为 业务 数据 的 一个 要素 确定 了 该笔 业务 的 属主 。 
 　 　 4 ) 初始 同步 过滤 ： 根据 订阅 服务器 的 属主 ， 过滤 掉 不 属于 该 机构 的 数据 ， 形成 属于 该 机构 的 初始 数据 。 
 　 　 5 ) 按 归属 分送 ： 根据 交易 的 归属 ， 把 交易 分 送到 相应 订购 服务器 作业 队列 。 
 　 　 为了 实现 初始 同步 过滤 和 按 归属 分送 ， 我们 必须 对 条目 加以 分类 。 有些 条目 不 需要 按 归属 分送 ， 不需 特殊 处理 ， 这 类 条目 称为 普通 条目 ， 记为 A 类 。 这类 条 目的 数据 是 公共数据 ， 每个 订阅 者 均 需要 这些 数据 。 另 一些 条目 需要 按 归属 分送 。 按照 数据 归属 的 确定 方法 ， 这些 条目 又 可以 分为 两类 ， 其中 ， 能够 通过 自身 的 列 确定 其 归属 的 条目 ， 记为 B 类 ， 通过 外部 键 和 被 引用 表 的 某 一列 来 确定 其 归属 的 条目 ， 记为 C 类 。 
 　 　 初始 同步 过程 算法 
 　 　 参数 ： 条目 名称 ，       订阅 者 服务器 名称 
 　 　 ( 1 ) 判断 该 条目 是否 为 A 类 ， 如果 是 则 转到 ( 9 ) ， 否则 转 到 ( 2 ) ； 
 　 　 ( 2 ) 判断 该 条目 是否 为 B 类 ， 如果 是 则 转到 ( 3 ) ， 否则 转 到 ( 4 ) ； 
 　 　 ( 3 ) 在 该条 目的 来源 表 和 信贷 机构 表上 建立 一个 视图 ( view ) ， 该 视图 的 条件 为 订阅 服务器 所 对应 机构 的 下辖 数据 ； 转 到 ( 5 ) ； 
 　 　 ( 4 ) 在 该条 目的 来源 表 ， 被 引用 表 和 信贷 机构 表上 建立 一个 视图 ， 该 视图 的 条件 为 订阅 服务器 所 对应 的 机构 的 下辖 的 数据 ； 转 到 ( 5 ) ； 
 　 　 ( 5 ) 调用 数据库 管理系统 所 提供 的 拷贝 工具 ( bcp ) ， 把 所建 视图 的 数据 导出 到 临时文件 中 ； 
 　 　 ( 6 ) 删除 所建 的 视图 ； 
 　 　 ( 7 ) 形成 该条 目的 同步 命令 ， 并 添加 到 订阅 作业 队列 中 ； 
 　 　 ( 8 ) 建立 订阅 者 对 该条 目的 订阅 任务 ， 并 使 自动 分发 失效 ( 去掉 该 订阅 任务 的 状态 ） ， 结束 返回 ； 
 　 　 ( 9 ) 调用 MS   SQL   Server 的 自动 同步 过程 。 
 　 　 按 归属 分送 过程 
 　 　 按 归属 分送 过程 的 算法 中有 一个 数据结构 ， 该 数据结构 是 一张 存放 可 分送 有效 作业 号 的 表 ， 该表 用于 控制 订阅 过程 ， 该表 的 结构 如下 ： 
 　 　 < publisher _ id ， ValidJobId ， busy > 
 　 　 publisher _ id ： 出版者 ID ， 整数 ； 
 　 　 ValidJobId : 有效 作业 ID ， 整数 ； 
 　 　 Busy ： 忙 状态 ， 小 整数 。 
 　 　 按 归属 分送 过程 算法 
 　 　 ( 1 ) 取出 有效 作业 指针 ， 如果 Busy 为 0 ， 则 置 Busy 为 1 ， 转 到 ( 2 ) ， 否则 ， 退出 ； 
 　 　 ( 2 ) 从 分发 数据库 的 作业 队列 中 取出   ID     大于 该 指针 的 全部 作业 ； 
 　 　 ( 3 ) 对于 每个 作业 ， 执行 ( 4 ) - ( 10 ) ； 
 　 　 ( 4 ) 对于 作业 中 的 每条 命令 ， 执行 ( 5 ) - ( 8 ) ； 
 　 　 ( 5 ) 该 命令 是 同步 命令 ， 则 对 临时 文件格式 转换 ， 并 授权 ； 
 　 　 ( 6 ) 若该 命令 是 Insert 命令 ， 取出 Value 子句 的 信贷 机构 ID ， 把 该 命令 加入 到 包含 该 信贷 机构 ID 的 机构 的 订阅 者 作业 队列 中 ； 
 　 　 ( 7 ) 若该 命令 是 Delete 命令 ， 取出 Where 子句 信贷 机构 ID ， 把 该 命令 加到 含该 信贷 机构 ID 的 机构 的 订阅 者 作业 队列 中 ； 
 　 　 ( 8 ) 该 命令 是 Update 命令 ， 取出 Where 子句 的 信贷 机构 ID ， 把 该 命令 加入 到 包含 该 信贷 机构 ID 的 机构 的 订阅 者 作业 队列 中 ； 
 　 　 ( 9 ) 继续 ( 5 ) - ( 8 ) ； 
 　 　 ( 10 ) 修改 有效 作业 号 ； 
 　 　 ( 11 ) 继续 ( 4 ) - ( 10 ) ； 
 　 　 ( 12 ) 置 Busy 为 0 ； 
 　 　 ( 13 ) 结束 。 
 　 　 * * ( 6 ) - ( 8 ) 是 针对 B 类 条目 ， 如果 是 C 类 条目 ， 则 不能 直接 取到 Cred _ ID ， 而 只能 通过 外部 键 和 引用 表 查找 Cred _ ID 。 如果 是 A 类 条目 ， 则 跳 过 这 3 步 。 
 3 　 小结 
 　 　 以上 方案 通过 在 出版 、 分发 和 订阅 3 个 阶段 改进 ， 形成 一个 能够 按 数据 归属 分送 的 分布式 数据库 。 该 分布式 数据库 已经 成功 地 应用 于 厦门市 信贷 资产 监测 网络系统 ， 成为 该 系统 的 核心 。 厦门市 信贷 资产 监测 网络系统 已于 1997 年 3 月底 正式 投入 运行 ， 并于 1997 年 年底 通过 中国人民银行总行 组织 的 鉴定 。 
 　 　 现实 世界 中 ， 层次 型 的 组织 结构 非常 普遍 ， 例如 政府部门 、 集团公司 ， 在组织上 都 是 分 层次 的 。 在 建设 这 类 网络应用 时若 遇到 本文 提出 的 类似 问题 ， 可以 采用 以上 方案 加以解决 。 
 作者简介 : 刘 清波 　 男 ， 32 岁 , 工程师 , 主攻 方向 : 数据库 管理 
 作者 单位 : 中国人民银行 厦门市 分行 厦门 　 361004 
 参考文献 
 　 1 　 Microsoft . Microsoft   SQL   Server   6.5   管理 指南 . 1997 
 　 2 　 Microsoft . Microsoft   SQL   Server   Books   Online.1996 
 收稿 日期 : 1998 - 06 - 08 
