微型机 与 应用 
 WEIXINGJI   YU   YINGYONG 
 1999 年 3 月   第 18 卷   第 3 期   vol.18   No.3 
 
 
 
 硬   盘   保   护   技   术 
 袁宗福 
 　 　 摘 　 要 ： 计算机病毒 的 发展 威胁 着 硬盘 的 正常 使用 ， 因此 如何 对 硬盘 进行 保护 ， 是 计算机专业 人员 所 关注 的 问题 。 本文 介绍 了 硬盘 及 CMOS 保护卡 的 原理 和 软硬件 设计 。 
 　 　 关键词 ： 硬盘 及 CMOS 保护 　 存储器 　 译码 　 GAL 设计 　 中断 
 　 　 硬盘 保护 走过 了 一条 从软 保护 到 硬 保护 的 过程 。 人们 使用 Kill 、 Scan 、 CPAV 及 KV300 等 检查 杀毒软件 ， 从 原来 只能 检测 1 种 或 几种 计算机病毒 ， 到 现在 能 检测 几千种 ， 查毒 杀毒软件 的 水平 也 在 不断 的 提高 。 但是 ， 在 杀 病毒软件 的 应用 过程 中 ， 人们 逐渐 发现 了 软件 杀病毒 的 弱点 ， 这种 弱点 不 在于 杀 病毒软件 ， 而 在于 软件 本身 。 杀毒软件 运行 时 ， 涉及 到 很多 其它 程序 ， 一旦 被 感染 ， 将会 带来 很多 意想不到 的 问题 。 虽然 ， 杀毒软件 设计者 使用 了 各种 防止 被 感染 的 方法 ， 但 都 不够 理想 。 另外 ， 上机 人员 有意无意 的 错误操作 ： 如 格式化 硬盘 、 删除 系统文件 和 数据 、 修改 CMOS 配置 等 ， 都 给 微机 管理人员 带来 很多 麻烦 。 
 　 　 于是 ， 人们 开始 设计 硬盘 保护卡 ， 即 采用 通道 写 保护 技术 ， 将 逻辑 C盘 ( 双硬盘 时为 C 、 D盘 ) 当作 固化 盘 保护 起来 。 硬盘 保护卡 可以 插 在 PC 系列机 的 任何 一个 扩展槽 上 ， 不 占 内存空间 、 使用方便 ， 也 使 管理人员 不必 经常 费时费力 地 进行 系统 的 恢复 。 硬盘 保护 程序 固化 在 硬盘 保护卡 上 的 EPROM 里 ， 从而 避免 了 被 病毒感染 的 可能性 。 硬盘 保护卡 可带 开关 锁 ， 使用者 只 需 将 DOS 及 系统软件 安装 到 C盘 后 将 锁上 锁 ， 即可 保护 BOOT 区 、 分区表 不 受 侵犯 ， 确保 C盘 中 的 DOS 及 系统软件 不 被 病毒感染 或 人为 破坏 ( 删除 、 改写 、 格式化 ) ， 并 可 确保 系统配置 ( CMOS ) 不 被 修改 与 破坏 ， 同时 又 不 影响 各种 软件 的 正常 运行 。 
 　 　 本文 将 介绍 硬盘 保护卡 的 软硬件 设计 方法 ， 并 给出 硬件 原理图 及 软件 程序框图 。 
 1 　 硬盘 保护卡 的 原理 
 　 　 PC 系列 微机 的 ROM   BIOS 为 总线 上 的 、 带有 扩展 ROM 程序 的 适配卡 进入 系统 提供 了 方便 。 在 主机 启动 时 的 上 电 自检 ( POST ) 期间 ， 将 为 BIOS 各 调用 程序 建立 中断向量 ， 在 缺省 向量 被 设置 好 之后 ， 对 扩展 的 ROM 模块 进行 扫描 。 此时 ， 适配器 板上 的 ROM 程序 可以 获得 控制权 ， 该 程序 可以 通过 设置 中断向量 将 它们 自身 挂到 系统 中 。 
 　 　 为了 寻找 有效 的 适配器 插件 板上 的 扩展 ROM ， 要 对 绝对 地址 C8000H ～ E0000H 以 2KB 为 单位 进行 扫描 ， 即以 C8000H + m × 800H 为始 地址 进行 搜索 。 一个 有效 的 ROM 块 应 满足 如下 定义 ： 
 　 　 字节 0 ： 55H ； 
 　 　 字节 1 ： AAH ； 
 　 　 字节 2 ： 长度 指示器 ， 表示 ROM 中以 512B 为 1 块 的 信息 块 个数 ( 长度 / 512 ) 。 为 测试 ROM 模块 的 完整性 ， 需 要求 一个 检查和 。 在 定义 的 ROM 中 ， 每 1B 按模 100H 求和 ， 其 和 必须 为 0 ， 该 模块 才 被 认为 有效 。 
 　 　 当 系统 的 ROMBIOS 找到 1 个 有效 的 ROM 时 ， 它 对 ROM 的 字节 3 ( 将 是 一个 可 执行 代码 ) 作 1 次远 调用 ( far   call ) ， 适配器 板 现在 可以 执行 它 的 加电 初始化 任务 。 执行 完 初始化 工作 后 ， 适配器 插件 板上 的 ROM 应 通过 1 条远 返回 ( far   return ) 指令 ， 将 控制权 交还给 ROMBIOS 程序 ， 完成 系统 的 启动 。 
 　 　 由此可见 ， 硬盘 保护卡 就是 这样 一个 适配器 插件 板 ： 把 自编 软件 固化 在 板 上 的 EPROM 里 作为 可 访问 的 ROM 组件 。 当 系统 POST 时 它 能 修改 中断向量 将 其 自身 挂 在 系统 上 ， 而 挂 在 系统 上 的 程序 则 可 通过 对 文件 执行 的 实时 跟踪 检测 ， 以 达到 保护 C盘 的 目的 。 
 2 　 硬盘 保护卡 的 硬件 设计 
 　 　 1 . PC 扩展槽 。 在 PC机 的 扩展槽 中 ， 62 芯 的 插槽 由 62 条 信号线 组成 ， 包括 地址 线 、 数据线 、 + 5V 、 GND 、 读 、 写 信号线 等 。 在 这里 只 对 本文 中 用到 的 一些 信号 进行 简单 的 介绍 。 
 　 　 A0 ～ A19 ( 地址 位 0 ～ 19 ) ： 这些 信号 用来 对系统 中 的 存储器 与 I / O 设备 寻址 。 20 条 地址 线 最 多 可 访问 1MB 的 存储器 ， 它们 均 为 高电平 有效 。 
 　 　 DO ～ D7 ( 数据位 0 ～ 7 ) ： 这些 信号 用于 微处理器 、 存储器 与 I / O 端口 之间 传送数据 ， 均 为 高电平 有效 。 
 　 　 AEN ： 用于 端口 译码器 的 控制 ， 高电平 有效 。 
 　 　 MEMR ： 存储器 读信号 ， 低电平 有效 。 
 　 　 MEMW ： 存储器 写 信号 ， 低电平 有效 。 
 　 　 2 . 硬件 线路 的 设计 。 硬件 部分 主要 包括 译码 和 存储器 二 部分 。 
 　 　 选择 1 片 2764 ( 8KB ) 的 EPROM 用于 存储 程序 ， 由于 2764 是 只 读存储器 ， 再 选择 1 片 6264 ( 8KB   RAM ) 或 6116 ( 2KB   RAM ) 用于 存储 中间 结果 和 变量 。 RAM 存储器 的 选择 可以 根据 需要 来 决定 ， 这里 使用 开关 位 SW4 来 控制 选择 6264 或 6116 。 如果 程序 量 大 ， 可以 采用 分页 的 方法 把 大量 的 存储器 映射 到 少量 的 存储空间 上 。 
 　 　 译码 部分 选用 GAL16V8 ( 通用 阵列 逻辑 ) 来 实现 。 GAL16V8 是 一个 可 由 用户 组态 而 执行 一定 逻辑 功能 的 电 可 擦除 的 、 可重 编程 的 PLD 器件 ， 它 的 每个 输出 是 输入 的 “ 乘积 和 ” 函数 ， 阵列 中 输入 线 和 输出 线 的 交点 上 是 用 逻辑 元件 连接起来 。 其 基本 结构 如图 1 。 
 
 
 图 1   GAL 基本 结构 
 3 . 硬盘 保护卡 所 占 的 内存空间 。 硬盘 保护卡 所 占 的 内存空间 如表 1 
 表 1 　 硬盘 保护卡 所 占 的 内存空间 
 　 　 191817161514131211109876543210 
 ROM 地 
 址 空间 ＜ 1 
 11 
 10 
 01 
 10 
 0 × 
 × 0 
 00 
 10 
 10 
 10 
 10 
 10 
 10 
 10 
 10 
 10 
 10 
 10 
 10 
 1 
 RAM 地 
 址 空间 ＜ 1 
 11 
 10 
 01 
 10 
 0 × 
 × 1 
 10 
 10 
 10 
 10 
 10 
 10 
 10 
 10 
 10 
 10 
 10 
 10 
 10 
 1 
 　 　 4 . 硬盘 保护卡 的 电路 原理图 如图 2 。 
 　 　 5 . GAL16V8 设计 源程序 文件 。 根据 硬盘 保护卡 所 占 的 内存空间 和 2764 、 6264 ( 或 6116 ) 的 片选 情况 ， 使用 Fast   Map 编译 软件 格式 编写出 如下 . PLD 文件 ： 
 　 　 PLD16V8 
 　 　 HardC   U03 
 　 　 DESIGNED   10 : 36 : 11   5 / 8 / 1998 
 　 　 HardC 
 　 　 A12   A13   A14   A15   A16   A17   A18   A19   AEN   GND 　 / * 1 ～ 20 管脚 定义 * / 
 　 　 MEMW   QA11   CS02   CS01   SW1   SW2   SW3   SW4   A11   VCC 
 　 　 逻辑 方程 ： 
 　 　 / CS01 = A19 × A18 × / A17 × A16 × / A15 × / A14 × / SW3 × / A13 × / AEN + A19 × A18 × / A17 × A16 × / A15 × A14 × SW3 × / A13 × / AEN 
 　 　 / CS02 = A19 × A18 × / A17 × A16 × / A15 × / A14 × / SW3 × A13 × / AEN + A19 × A18 × / A17 × A16 × / A15 × A14 × SW3 × A13 × / AEN 
 　 　 / QA11 = SW4 × / A11 + / SW4 × / MEMW 
 　 　 DESCRIPTION 
 　 　 GAL   for   protect   hard   disk   C 
 　 　 其中 ， SW3 ( 开或关 ) 用于 决定 2764 的 起始 地址 D0000H 或 D4000H 。 SW4 用于 决定 使用 6264 ( 8KB ) 还是 6116 ( 2KB ) 芯片 。 使用 DIP4 可以 改变 ROM 地址 ， 目的 是 避免 与 其它 插件 板 的 地址 冲突 。 
 
 
 
 图 2 　 电路 原理图 
 3 　 硬盘 保护卡 的 软件设计 
 3.1 　 硬盘 保护卡 软件设计 应 注意 的 问题 
 　 　 硬盘 保护卡 的 初始化 程序 是 在 系统 上电 自检 期间 执行 的 ， 由于 DOS 系统 还 没有 装入 ， 所以 这时 只能 使用 BIOS 的 功能 调用 。 当 用户 在 DOS 提示符 下 执行 文件 时 ， DOS 都 调用 INT   21H 的 4BH 功能 ， 所以 ， 在 软件设计 时 ， 可 截取 4BH 功能 以 实现 对 病毒 的 实时 检测 。 
 3.2 　 安装 INT21H 技术 
 　 　 DOS 由 下列 4 部分 组成 ： 引导 扇区 、 IBMDOS . COM 、 IBMBIOS . COM 、 COMMAND . COM 。 其中 INT21H 是 在 IBMDOS . COM 文件 被 引入 内存 后 建立 的 ， 而 硬盘 保护卡 是 在 DOS 的 这 4 部分 之前 引入 的 ， 也 即 保护卡 上 的 程序 先于 IBMDOS . COM 执行 。 如果 硬盘 保护卡 只是 在 装入 时 简单 地 修改 一下 中断向量 ， 则 会 被 IBMDOS . COM 执行 时 重新 设置 。 那么 怎样 才 能够 在 IBMDOS . COM 修改 INT21H 后 ， 再 修改 INT21H 中断向量 呢 ? 可 修改 INT8H 时钟 中断 ， 每秒 18.2 次 检测 INT21H 是否 被 修改 ， 一旦 被 修改 ， 则 修改 INT   21H 和 INT   13H ， 并 使 其 指向 硬盘 保护 程序 。 
 3.3 　 截取 INT   13H 的 写 功能 
 　 　 为了 对 硬盘 写 操作 或 格式 磁道 进行 检查 ， 保护卡 对 做 硬盘 操作 的 INT   13H 中断 进行 了 截取 ， 如图 3 。 由原 13H 中断 所 要求 的 参数 形式 计算 保护 分区 ( C盘 ) 的 保护 区域 ， 然后 进行 合法性 判断 ， 包括 是否 对 主导 区 进行 写 操作 。 为了 防止 非法 用户 对原 13H 中断 程序 的 直接 调用 ， 可以 对原 13H 中断 服务程序 前 2B 进行 保存 后 删除 ， 在 新 的 13H 中断 程序 调用 原 13H 中断 程序 之前 恢复 这 2B ， 调用 完后 再 删除 这 2B 。 
 
 
 图 3   修改 后 的   INT   13H 流程图 
 3.4 　 对 CMOS 参数 的 重写 
 　 　 为了 防止 CMOS 被 修改 ， 可 在 系统启动 时 自动 对 其 恢复 除 时间 信息 以外 的 50B   CMOS 数据 。 另 一种 方法 是 截取 键盘 中断 ， 在 机器运行 中 每当 有 键盘输入 时 ， CMOS 信息 就 会 重新 刷新 1 次 。 CMOS 参数 的 备份 可 存放 在 主 引导 记录 扇区 中 ( 主 引导 记录 中有 1 片 内容 为 0 的 单元 ， 可 加以 利用 ) ， 另 一种 方法 是 事先 写入 保护卡 上 的 2764 存储器 中 。 
 　 　 以上 介绍 的 硬盘 保护卡 ， 笔者 已 将 它 做成 了 成品 ， 作为 自制 产品 在 校内 的 公用 机房 中 使用 。 实践证明 它 确实 起到 了 保护 硬盘 信息 的 作用 ， 防止 了 非法 用户 对 CMOS 信息 的 随意 修改 ， 提高 了 机器 的 维护 和 管理水平 。 
 作者 单位 : 南京 机械 高等 专科学校 计管系 ( 210013 ) 
 参考文献 
 　 1 　 张旭东 ， 廖先芸 . IBM 微型机 实用 接口技术 . 北京 ： 科学技术 文献 出版社 ， 1993 
 　 2 　 张研 . 防病毒卡 设计 . 中国 计算机用户 ， 1994 
 ( 收稿 日期 ： 1998 - 09 - 10 ) 
