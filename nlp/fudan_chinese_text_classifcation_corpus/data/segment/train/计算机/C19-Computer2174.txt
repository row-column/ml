计算机 应用 研究 
 APPLICATION   RESEARCH   OF   COMPUTERS 
 2000 　 Vol.17 　 No.2 　 P.6 - 8 
 
 
 
 网络 多媒体 实时 传输 协议 浅析 
 高旭 　 沈苏彬 　 顾 冠群 
 摘   要   对 目前 广泛 使用 的 实时 传输 协议 RTP 作 了 简单 的 介绍 与 分析 ， 并 指出 该 协议 存在 的 问题 及 在 大规模 会议 中 的 解决 途径 。 在 此基础 上 ， 通过 一个 多媒体 会议 系统 实例 分析 了 RTP 协议 的 具体 实现 。 
 关键词   RTP   RTCP   多媒体 会议   组播 
 1   引言 
 　 　 从 80 年代 中期 到 现在 ， 网络 多媒体 应用 方兴未艾 ， 无论 在 科学研究 还是 工程 应用 都 取得 了 一批 骄人 的 成果 。 在 IETF 组织 中 ， 仅仅 与 多媒体 会议 系统 研究 有关 的 工作组 就 有 许多 ， 如 负责 会议 控制 的 MMUSIC 工作组 和 分管 音频 、 视频 传输 研究 的 AVT 工作组 。 ITU - T 也 有 专门 研究 多媒体 会议 的 SG15 工作组 ， 并且 推出 了 H.3 XX 系列 的 建议 标准 ， 特别 是 H.323 标准 采用 RTP 作为 传输 协议 。 在 工程 应用领域 ， 视频会议 系统 、 远程教学 、 视频点播 和 软件 分发 等 显示 了 实时 多媒体 应用 的 强大 生命力 。 
 　 　 当然 ， 目前 多媒体 应用 还 存在 许多 问题 ， 其中 关键 是 现有 网络 并 不 提供 对 实时 应用 的 有效 支持 ， 如实 时 传输 、 服务质量 保证 等 。 在 已有 TCP 和 UDP 协议 无法 提供 有效 服务 的 情况 下 ， 人们 提出 了 一些 新型 高层 协议 ， 其中 实时 传输 协议 RTP 是 网络 多媒体 应用 的 核心 协议 。 
 　 　 RTP 协议 [ 1 ] 是 IETF 的 AVT 工作组 于 1996 年初 公布 的 标准 ， 目前 已 得到 了 广泛 的 应用 。 下面 我们 将 介绍 RTP 协议 的 核心内容 ， 分析 存在 的 主要 问题 和 可能 的 解决 途径 ， 并 以 多媒体 会议 为 实例 讨论 RTP 的 具体 实现 方法 。 
 2   RTP 协议 
 2.1   RTP 协议 简介 
 　 　 RTP 协议 是 专门 为 交互式 话音 、 视频 、 仿真 数据 等 实时 媒体 应用 而 设计 的 轻型 传输 协议 ， 它 为 应用 提供 端到 端的 实时 网络 传输 。 但 RTP 协议 本身 并 不 提供 对 实时 媒体 应用 的 服务质量 保证 ， 需要 下层 协议 提供 支持 。 
 　 　 RTP 协议 由 紧密 相关 的 两 部分 组成 ： 负责 媒体 数据传输 的 RTP 协议 和 负责 反馈 控制 、 传输 监测 的 RTCP 协议 。 RTP 主要 完成 IP 分组 网络 上 实时 多媒体 数据 的 传输 ， 如实 时 话音 和 视频 。 为此 ， RTP 分组 头 中 包含 了 负载 类型 标识 、 顺序号 、 帧 结束 标志 和 时间 戳 等 字 段 ， 以 助于 媒体 同步 、 丢失 检测 和 分组 标识 。 
 　 　 RTCP 控制 分组 和 RTP 媒体 数据 分组 同 属于 一个 群组 ， 但 使用 不同 的 协议 端口号 来 区分 。 群组 的 发送 方 和 接收 方都 周期 组播 RTCP 分组 ， 来 提供 实时 重传 需要 的 不同 服务 。 如 参加 成员 用 RTCP 分组 的 源 描述符 ( SDES ) 标识 ， 接收 方用 RR 发送 QoS 报告 ， 发送 方以 SR 来 辅助 媒体 之间 的 同步 等 。 这些 控制 信息 对 基于 发送 方 的 速率 自 适应 、 网络 监控 和 会议 控制 都 很 关键 。 
 　 　 由于 RTP 协议 利用 了 组播 技术 ， 所以 可以 在 小规模 的 ( 几个 成员 ) 会话 到 大规模 ( 几百个 成员 ) 范围 内 使用 。 而 随着 多媒体 应用 需求 的 继续 高涨 ， 成千上万 成员 规模 的 多媒体 应用 也 会 很快 实现 。 甚至 有人 建议 ， 在 将来 的 有线电视 网络 中 也 采用 RTP 协议 传输数据 。 RTP 协议 在 网络 多媒体 协议 栈 的 位置 如图 1 所示 [ 2 ] 。 
 
 图 1   网络 多媒体 协议 议栈 
 2.2   RTP 协议 的 设计 目标 
 　 　 从 RTP 最初 的 设计 思想 来看 ， 主要 为了 实现 如下 几个 目标 [ 3 ] ： 
 　 　 ● 轻型 的 传输 协议 。 RTP 提供 端到 端的 实时 媒体 传输 功能 ， 但 并 不 提供 机制 来 确保 实时 传输 和 服务质量 保证 ， 协议 本身 相对 轻型 、 快捷 。 由于 RTP 没有 像 TCP / IP 那样 完整 的 体系 框架 ， 只是 一个 轻型 的 传输 协议 ， 主要 与 具体 应用 结合 在 一 起来 实现 。 
 　 　 ● 灵活性 。 体现 在 把 协议 机制 与 控制策略 的 具体 算法 分开 。 协议 本身 只 提供 完成 实时 传输 的 机制 ， 对 控制策略 的 有关 算法 实现 不 作 具体 规定 。 开发者 可以 根据 不同 的 应用环境 ， 选择 实现 效率 较 高 的 算法 与 合适 的 控制策略 。 
 　 　 ● 协议 独立性 。 RTP 协议 与 下层 协议 无关 ， 可以 在 UDP / IP 、 IPX 、 ATM 的 AAL 层上 实现 。 
 　 　 ● 扩展性 。 既 支持 传统 的 单播 ( Unicast ) 应用 ， 又 支持 新 出现 的 组播 ( Multicast ) 应用 。 
 　 　 ● 控制 信息 与 媒体 数据 分离 。 RTCP 控制 分组 采用 与 RTP 媒体 数据 分组 不同 的 “ 带外 ” 方式 传送 。 
 　 　 ● 安全性 。 RTP 协议 在 设计 上 考虑 到 安全 功能 ， 支持 对 数据 加密 和 身份 鉴别 认证 功能 。 
 2.3   RTP 协议 的 分组 格式 
 　 　 在 RTP 分组 头 中 ， 有 几个 与 实时 传输 紧密 相关 的 重要 字 段 ： 顺序号 、 时间 戳 和 源 标识 。 
 　 　 顺序号 是 一个 16 比特 的 序列 空间 ， 其 初始值 随机 产生 。 每个 RTP 数据 分组 都 把 前 一个 分组 的 顺序号 加 1 作为 自己 的 顺序号 。 接收 方 通过 检测 收到 的 分组 顺序号 可以 判断 是否 有 分组 丢失 ， 并 可 重新 恢复 发送 时 的 分组 顺序 。 
 　 　 时间 戳 为 32 比特 ， 是 数据 分组 第一个 字节 的 采样 时间 。 这个 采样 时间 要求 从 一个 时间 单调 线性 增长 的 时钟 获得 ， 以便 于 同步 和 延时 抖动 的 计算 。 数据 分组 的 标称 采样 时间 从 采样 时钟 获得 ， 而 不是 读取 系统 时钟 。 时间 戳 的 初始值 也 是 随机 产生 的 ， 同时 产生 的 几个 相邻 分组 可以 有 相同 的 时间 戳 ， 如 一个 视频 帧 的 相邻 数据 分组 。 
 　 　 同步 源 标识 SSRC 占用 32 比特 ， 是 随机 选择 的 ， 但 要求 同一个 RTP 会话 中 的 同步 源 标识 唯一 。 为此 ， 在 随机 产生 SSRC 标识 时 ， 还要 考虑 到 如何 检测 和 解决 SSRC 碰撞 的 问题 。 在 RTP 文本 中有 避免 冲突 的 具体 算法 。 
 2.4   RTP 翻译器 和 混合器 
 　 　 RTP 在 接收 方 和 发送 方 之间 引入 了 两种 类型 的 中间 节点 ： 翻译器 和 混合器 ( Mixers ) 。 
 　 　 混合器 接收 来自 一个 或 多个 发送 方 的 RTP 数据 块 ， 并 把 它们 组合成 一个 新 的 RTP 分组 继续 转发 。 这种 组合 数据 块 将 有 一个 新 的 SSRC   标识 ， 具有 新 标识 的 特别 发送 方 被 作为 特别 信源 加入 到 RTP 数据 块 中 。 因为 来自 不同 特别 发送 方 的 数据 块 可以 非 同步 到达 ( 它们 可以 经 不同 的 路径 经过 这个 网络 ) ， 所以 混合器 改变 了 该 媒体 流 的 临时 结构 。 混合器 的 典型 例子 是 将 某个 多点 会议 的 多个 音频 源 组合成 一个 音频 流转 发给 所有 接收 方 。 
 　 　 与 混合器 不同 ， 翻译器 只 改变 数据 块 内容 ， 而 并 不 把 媒体 流 组合 在 一起 。 翻译器 只是 对 单个 媒体 流 进行 操作 ， 可能 进行 编码 转换 或者 协议 翻译 。 典型 的 例子 是 多媒体 会议 中 不同 端系统 之间 的 视频 编解码 转换器 ， 以及 在 多媒体 应用 跨越 内部网 防火墙 时 的 过滤器 。 
 3   RTCP 协议 
 　 　 与 RTP 同时 存在 的 还有 一个 控制协议 ， 称为 RTCP 。 它 把 传输 状态 信息 发送给 所有 与会者 以 进行 媒体 流 性能 和 质量 的 监测 。 发送 方 也 可以 用 它 来 确保 SSRC 标识符 的 唯一性 。 RTCP 协议 主要 依靠 在 所有 成员 之间 周期性地 传输 控制 分组 来 实现 控制 监测 功能 ， 它 要求 下层 协议 必须 提供 时间 和 控制 分组 的 复用 功能 ， 如 UDP 协议 可以 提供 不同 的 端口号 。 
 3.1   RTCP 的 功能 
 　 　 RTCP 主要 有 下列 四大 功能 ， 前 三项 是 所有 系统 都 支持 的 功能 ， 最后 一项 是 可以 选择 的 功能 。 
 　 　 ● 提供 数据传输 质量 的 反馈 信息 ， 主要 通过 发送 方 报告 ( SR ,   Sender   Report ) 和 接收 方 报告 ( RR ,   Receiver   Report ) 来 实现 。 这些 反馈 信息 与 流量 控制 和 拥塞 控制 密切相关 ， 也 可以 直接 用于 故障诊断 。 
 　 　 ● 对 每 一个 RTP 信息源 ， RTC 带有 一致 的 传输层 标识 ， 称为 通用 名 CNAME ( Canonical   Name ) 。 当 同步 源 标志 SSRC 在 由于 冲突 而 发生 改变 时 ， 接收 方 需要 CNAME 标识 来 区分 多个 媒体 流中 给定 应用 的 应用 成员 。 
 　 　 ● 当前 参加 成员 的 动态 估计 ， 可以 用来 计算 数据 发送 速率 ， 并且 在 成员 动态变化 时 对 速率 进行 动态 地 调整 以 合理 利用 网络资源 。 
 　 　 ● 传送 最 少量 的 控制 信息 以 保证系统 可以 容易 地 扩展 成为 大规模 的 松散 耦合 系统 。 
 3.2   RTCP 分组 的 传输 间隔 
 　 　 RTP 协议 具有 很 好 的 缩放 性 ， 允许 应用 从 几个 人 的 小规模 系统 扩展 成 上千人 的 大规模 系统 。 如果 每个 参加者 发出 的 报告 分组 是 速率 固定 的 ， 那么 随着 系统 规模 的 增加 ， 控制 分组 的 数量 就 会 线性 增长 。 由于 网络带宽 资源 的 有限 ， 相应 的 数据 分组 就要 减少 ， 从而 直接 影响 用户 最 关心 信息 的 传输 。 所以 控制 信息 分组 应该 限制 在 整个 系统 带宽 的 某个 比例 之内 ， 以 提高 应用 的 有效 带宽 ， RTCP 协议 建议 以 整个 会话 可用 带宽 的 5 ％ 为 上限 。 
 3.3   RTCP 分组 类型 
 　 　 RTCP 主要 有 五种 分组 类型 ， 它们 携带 不同 的 控制 信息 。 发送 方 报告 SR ， 是 来自 各 活跃 发送者 的 传送 和 接收 统计 。 接收 方 报告 RR ， 是 来自 各非 活跃 发送者 的 接收 统计 。 源 描述 分组 SDES ， 包括 CNAME 。 结束 参与 指示 分组 BYE 和 特别 应用 功能 分组 APP 。 
 　 　 多个 RTCP 分组 可以 连接 在 一起 构成 混合 分组 。 在 混合 分组 中 第一个 RTCP 分组 通常 必须 是 一个 报告 分组 ， 以 帮助 进行 分组 头 的 确认 ， 甚至 在 没有 数据 发送 或 接收 时 也 应 如此 。 这时 发送 空 的 RR ， 即使 仅 有 的 另 一个 RTCP 分组 是 BYE 。 
 　 　 在 每个 混合 RTCP 分组 中 必须 包括 一个 含有 CNAME 项 的 SDES 分组 。 SDES 分组 也 可能 包括 其它 的 源 描述 项 ， 这要 根据 特别 的 应用 要求 ， 并 同时 考虑 带宽 的 限制 。 
 　 　 在 具体 实现 RTP 协议 时 ， 到达 的 未知 类型 RTCP 分组会 被 忽略 。 增加 的 RTCP 分组 类型 可以 在 Internet 指定 成员 机构 ( IANA ) 中 注册 ， 以 获得 合法 的 类型 号 。 
 4   RTP 协议 分析 
 　 　 RTP 协议 既 不 提供 资源 预留 ， 也 不 提供 QoS 支持 ， 但 通过 RTCP 控制 报文 可以 为 质量 控制 提供 相关 辅助 信息 。 应用 还 需要 依靠 其它 协议 来 满足 服务质量 方面 的 要求 。 
 　 　 RTP 报文 头 的 开销 在 低速 链路 上过 大 ， 如 RTP ＋ UDP ＋ IP ＝ 40 字节 / 分组 。 目前 采用 RTP 头 压缩 可以 降到 24 字节 / 分组 ， 这种 压缩 在 低速 链路 上 最好 采用 逐步 压缩 方法 为 好 。 此外 ， 目前 RTP 采用 的 组播 模型 广播 太 多 ， IETF 的 AVT 工作组 正在 着手 相关 的 改进 工作 。 
 　 　 RTCP 主要 完成 松散 的 会 话 控制 、 QoS 报告 和 媒体 同步 。 在 RTP 协议 文本 中 提出 了 主机 加入 到 一个 RTP 组播 会 话 中 计算 RTCP 分组 发送 速率 的 算法 。 这个 算法 允许 加入成员 从 一个 到 百万 数量级 ， 然而 当 加入成员 达到 很 大规模 并且 成员 具有 较 快 的 动态变化 性时 ， 就 会 产生 一些 问题 ， 如 网络 拥塞 、 状态 保存 和 传输 延时 。 
 　 　 在 很多 情况 下 ， 用户 的 访问 接入 带宽 远 小于 网络带宽 。 在 某 一 时刻 有 许多 成员 同时 加入 的 情况 下 ， 单纯 通过 倾听 来 估算 群组 规模 会 很 不 准确 ， 因为 每个 同时 加入 的 成员 都 无法 估计 到 同时 加入 的 成员 数目 。 其 结果 将 在 低速 的 访问 链路 上 产生 RTCP 分组 泛滥 ， 导致 网络 拥塞 和 分组 丢失 。 
 　 　 此外 ， 为了 估算 群组 规模 ， 每个 主机 都 要 倾听 组播 分组 来 计算 加入成员 的 数目 。 而 为了 保证 不 重复 计算 同一 成员 ， 必须 保存 成员 的 唯一 标识 SSRC 。 当 群组 规模 很大 时 ， 保存 的 SSRC 数目 也 相应 增长 ， 需要 的 内存 量 也 会 较大 。 
 　 　 当 群组 规模 变 大 ， RTCP 报告 的 发送 间隔 也 变大 。 这个 间隔 可能 会 超过 群 组成员 的 有效期 ， 从而 导致 某些 成员 的 QoS 报告 不 真实 ， 甚至 完全 失去 价值 。 
 　 　 RTP 协议 遇到 的 关键问题 是 RTCP 分组 的 泛滥 ， 主要 发生 在 大量 成员 同时 加入 到 一个 RTP 组播 会 话 时 。 目前 已经 有 一些 初步 的 研究成果 ， 如 Sharma 等 提出 了 如何 平衡 软 状态 定时器 设置 与 链路 容量 和 状态 数量 的 变化 ， 他们 主要 研究 点到点 的 情况 。 此外 ， 在 服务 定位 协议 ( SLP ) 中 提出 了 重置 算法 来 控制 群组 的 拥塞 。 Henning [ 4 ] 等 人 提出 解决 RTCP 分组 泛滥 的 自 适应 定时器 算法 ， 称为 定时器 重置 ( Reconsideration ) 算法 。 在 数学分析 和 评价 该 算法 的 同时 ， 也 采用 了 仿真 来 验证 算法 的 高性能 。 
 5   RTP 实例 分析 
 　 　 我们 对 劳伦斯伯克利 实验室 的 Vic2.8 [ 5 ] 视频工具 作 简单 分析 ， 以 探讨 RTP 的 实现 问题 。 
 　 　 通常 RTP 协议 并 不 作为 一个 独立 的 协议 层次 来 实现 ， 而是 作为 应用 的 一部分 予以 实现 。 在 Vic 工具 源代码 中 与 RTP 最 相关 的 是 rtp . h 和 session _ rtp . cc 。 rtp . h 中 主要 按照 RFC1889 和 RFC1990 的 规定 ， 定义 了 标准 的 视频 和 音频 编码数据 结构 、 RTP 和 RTCP 分组 头 、 SR 和 RR 分组 格式 和 ntp 时钟 等 。 RTCP 协议 本身 主要 由 session _ rtp . cclai 实现 ， 它 定义 了 对 RTCP 分组 的 几个 处理函数 ， 如 分组 分析判断 、 分组 接收 处理 ( RR ) 和 分组 发送 处理 ( SR ) 等 。 RTP 对 媒体 数据 的 处理 影响 到 许多 程序 ， 如 建立 网络连接 时套 接口 ( Socket ) 的 选择 、 媒体 数据 的 容错 、 加密 等 。 
 　 　 目前 对 RTP 协议 的 实现 还 没有 相应 的 规范 ， RTP 本身 只是 一个 协议 框架 ， 可以 有 非常灵活 的 实现 方式 。 现在 许多 厂家 ， 如 FVC 、 PictureTel 、 VCON 、 Intel 和 Cisco 等 都 有 支持 RTP 标准 的 产品 问世 ， 但 如何 保证 不同 厂家 产品 的 互操作 却是 一个 大 问题 。 对 遵循 ITU - T 标准 的 多媒体系统 来说 ， 已经 有 国际 多媒体 远程 会议 委员会 IMTC 来 协调 标准 实现 的 互操作 问题 。 对于 RTP 协议 而言 ， 互操作 的 代码 实现 依然 是 一个 未 解决 的 问题 。 
 6   结论 
 　 　 尽管 RTP 协议 到 目前为止 还 仅仅 是 一个 RFC 标准 ， 还 存在 一些 问题 ， 但 它 在 多媒体 应用 研究 人员 和 产业界 的 地位 非同一般 。 首先 ， 一些 Internet 应用 系统 ， 特别 是 MBone 上 的 多媒体 应用 系统 ， 都 采用 了 RTP 作为 应用 支撑 协议 。 如 Vic   、 RAT 、 IVS 和   Vat 等 MBone 多媒体 会议 工具 中 都 实现 了 RTP 。 其次 ， 有着 强大 电信 企业 背景 的 ITU － T 标准化 组织 ， 在 制定 Internet 上 多媒体 应用 标准 时 也 采用 了 RTP 协议 作为 多媒体 流 的 运输 协议 ， 如 H.323 标准 。 可以 说 ， RTP 协议 已经 成为 以 多媒体 会议 为 典型 代表 的 网络 多媒体 应用 的 事实标准 。 
 本 项目 获 国家自然科学基金 项目 资助 ； 本 项目 获 江苏省 应用 基金 资助 
 高旭 （ 东南大学 计算机科学 与 工程系   南京   210096 ） 
 沈苏彬 （ 东南大学 计算机科学 与 工程系   南京   210096 ） 
 顾 冠群 （ 东南大学 计算机科学 与 工程系   南京   210096 ） 
 参考文献 
 1 ， RFC   1889 ,   H .   Schulzrinne ,   S .   Casner ,   R .   Frederik ,   V .   Jacobson ,   RTP :   A   transport   protocol   for   real - time   applications 
 2 ， GMD   Fokus ,   User   Handbook   of   the   Multimedia   Internet   terminal   ( MINT ) ,   2nd   November   1998 
 3 ， H .   Schulzrinne ,   Real - time   Multimedia   Services   in   the   Internet ,   GMD   Fokus ,   April   1996 
 4 ， J .   Rosenberg ,   H .   Schulzrinne   Timer   reconsideration   for   enhanced   RTP   scalability ,   Internet   Draft ,   IETF ,   July   1997 
 5 ， Steven   McCanne   and   Van   Jacobson .   Software   on - line ,   ftp : / / ftp . ee . lbl . gov / conferencing / vic 
 收稿 日期 ： 1999 年 9 月 18 日 
