软件 学报 
 JOURNAL   OF   SOFTWARE 
 1999 年   第 6 期   第 10 卷   Vol.10   No.6   1999 
 
 
 
 主动式 路由器 操作系统 TH - AOSR 的 设计 与 实现 * 
 马洪军 　 张尧学 　 陈 　 桦 
 　 　 摘要 　 传统 网络 存在 着 自身 难以克服 的 弊端 ， 如新 的 网络协议 、 新 的 用户服务 在 现行 网络 上 实施 、 推广 困难 . 而 主动 网络 计算 则 是 解决 这一 问题 的 一个 可行 方案 . 文章 设计 并 实现 了 一个 主动式 路由器 操作系统 — — TH - AOSR ( Tsinghua   active   operating   system   for   router ) , 它 在 兼容 传统 路由器 功能 的 同时 ， 还 具有 主动 网络 互连 和 计算能力 ， 可以 方便 地为 用户 或 应用 提供 定制 服务 . 
 　 　 关键词 　 主动式 网络 ， 路由器 ， 操作系统 ， 资源管理 ， 安全 管理 . 
 　 　 中图法 分类号 　 TP393 
 　 
 Design   and   Implementation   of   Tsinghua   Active   Operating   System   for   Router 
 MA   Hong - jun   ZHANG   Yao - xue   CHEN   Hua 
 ( Department   of   Computer   Science   and   Technology   Tsinghua   University   Beijing   100084 ) 
 　 　 Abstract 　   In   a   traditional   network ,   it   is   difficult   to   deploy   new   network   protocols   and   services ,   and   this   problem   could   not   be   overcome   by   itself .   Active   networking ,   however ,   is   a   feasible   way .   In   this   paper ,   the   authors   introduce   a   new   router   operating   system — — TH - AOSR   ( Tsinghua   active   operating   system   for   router ) ,   based   on   the   investigation   of   active   network .   In   addition   to   be   compatible   to   traditional   routers ,   TH - AOSR   has   active   networking   and   active   computing   capacity ,   which   enables   any   specific   user   or   application   to   customize   their   services ,   while   forwarding   data   packets   securely   and   rapidly . 
 　 　 Key   words 　 Active   network ,   router ,   operating   system ,   resource   management ,   security   management . 
 　 　 路由器 操作系统 是 网络 互连 关键设备 — — 路由器 的 核心 软件 . 它 主要 负责 路由器 系统资源 的 管理 与 分配 、 数据包 的 寻址 与 转发 、 数据传输 的 安全 与 保密 以及 不同 物理 网络 ( PSDN ， DDN ， ISDN 和 以太网 等 ) 间 的 无缝 连接 . 
 　 　 路由器 操作系统 大致 可以 分为 两类 ： 一类 是 Cisco ， Bay ， 3Com 等 网络 公司 为 自己 的 路由器 产品 推出 的 专用 路由器 操作系统 ， 如 Cisco 公司 的 IOS ( internet   operating   system ) , 另一类 是 强化 了 路由 、 转发 等 功能 的 通用 路由器 操作系统 ， 如 UNIX + gated ( gated 是 Cornell   University 为 UNIX 平台 开发 的 寻径 程序 ) . 前者 一般 基于 专用 总线结构 和 硬件平台 ， 具有 很 高 的 数据 包转发 速度 . 后者 则 由于 受原 通用 操作系统 体系结构 的 制约 ， 数据包 的 转发 速度 相对 较 低 . 但 在 功能 上 ， 二者 并 无 本质 不同 . 
 　 　 近年来 ， 随着 计算机网络 应用 技术 的 迅速 发展 ， 以 转发 数据包 为主 的 传统 网络 逐渐 暴露出 一些 自身 存在 的 弊端 . 新 的 网络 技术 、 标准 、 服务 在 现存 网络 上 实施 困难 便是 其中 之一 . 如 多播 ( multicast ) 、 资源 预约 协议 ( RSVP ) 、 IPv6 、 IP 移动 服务 ( IP   mobile ) 等 虽 已 出台 ， 但 至今 仍 不能 在 因特网 上 推广应用 . 主动 网络 技术 将 是 解决 这一 问题 的 一个 可行 方案 . 
 本文 在 清华大学 和 桑达 公司 联合开发 成功 的 SED - 08 路由器 操作系统 ［ 1 ］ 的 基础 上 ， 设计 并 实现 了 一个 用于 清华 主动 网 ( Tsinghua   active   network ) 实验 床 的 主动式 路由器 操作系统 — — TH - AOSR ( Tsinghua   active   operating   system   for   router ) . 该 系统 除了 具有 SED - 08 路由器 操作系统 的 功能 外 ， 还 具有 “ 主动 ” 功能 ， 即 用户 或 应用 可 根据 需要 对 它 进行 编程 ， 使 之 实现 用户 或 应用 的 定制 处理 . 
 1   主动 网络 
 　 　 主动式 网络 ( active   network ） 是 为了 解决 传统 网络 所 存在 的 新 服务 实施 困难 这一 问题 而 提出 的 一个 新 的 网络 概念 ［ 2 ］ . 在 这 一 概念 下 ， 网络 不 只是 在 终端 系统 间 “ 被动 ” 地 转发 数据包 的 通道 ， 而是 一个 可编程 的 网络 计算 平台 . 它 允许 用户 或 应用 在 网络 内部 定制 自己 的 数据包 处理 方法 . 同样 地 ， 数据包 也 不再 只是 一个 仅 包含 用户 数据 的 数据 单元 ， 而是 一个 既 包含 用户 数据 又 包含 数据处理 程序 的 主动 包 （ 类似 于 OOP 技术 中 的 对象 ） . 当 主动 包 到达 各 节点 时 ， 主动 节点 下载 并 执行 主动 包中 的 程序 ， 以 实现 对 数据包 的 定制 处理 ， 如 修改 包头 、 处理 用户 数据 、 重定向 包等 . 图 1 是 一个 简单 的 主动式 网络 （ 由 主动式 节点 和 传统 节点 构成 的 混合 网络 ） 的 数据包 处理过程 示意图 . 
 
 图 1 　 主动式 网络 数据包 处理过程 示意图 
 　 　 与 传统 的 网络 相比 ， 主动式 网络 具有 两 方面 的 优点 ： ( 1 )   新 技术 、 新 标准 、 新 服务 实施 容易 ， 使得 网络 可以 根据 用户 的 需要 迅速 进行 功能 升级 、 换代 ； ( 2 )   应用 和 网络 可以 实现 充分 的 信息 交流 ， 使 网络 成为 应用 感知 网络 （ application - aware   network ） ， 使 应用 成为 网络 感知 应用 （ network - aware   application ） . 
 2   主动 数据包 格式 与 主动 节点 数据包 处理 机制 
 　 　 主动 包 的 格式 到 现在 还 没有 一个 统一 的 规定 . 当前 ， 各 研究 机构 采用 的 格式 主要 有 两种 . 
 　 　 ( 1 )   IP 数据包 格式 的 变种 ［ 3 ］ . 这种 格式 对 IP 包 进行 了 简单 扩展 ， 为 其 增加 了 一个 携带 程序 主动 选项 . 由于 是 与 传统 数据包 格式 兼容 ， 因此 可以 简化 主动 网 实现 的 复杂度 . 但 由于 受 IP 选项 长度 的 限制 ， 主动 包 携带 的 数据包 处理程序 不能 大于 40 个 字节 . 
 　 　   ( 2 )   专用 主动 包 格式 . 宾西法尼亚 大学 主动 网 研究 小组 根据 主动式 网络 的 计算 特点 定义 了 一种 全新 的 主动 包 格式 ［ 4 ］ . 它 打破 了 格式 ( 1 ) 中 IP 选项 域 长度 的 限制 ， 因而 可以 携带 功能 更为 强大 的 定制 处理程序 . 
 　 　 THAN 实验 网 采用 的 是 格式 ( 1 ) 包 格式 . 为了 打破 IP 选项 长度 的 限制 , IP 选项 只 携带 定制 程序 的 名称 及 必要 参数 （ 即 指定 处理 数据包 的 程序 ） . 当 主动 包 到达 各 节点 时 ， 各 节点 加载 、 执行 主动 包 指定 的 程序 . 主动 包 指定 的 程序 （ 以下 简称 定制 程序 ） 可能 存在 于 本地 （ 本地 提供 的 或 先前 缓存 的 ） ， 也 可能 存在 于 远程 （ 与 数据包 同源 或 其他 服务器 ） . 
 　 　 与 由 IP 选项 直接 携带 处理程序 相比 ， 上述 机制 具有 以下 优点 ： ( 1 )   数据包 开销 少 ； ( 2 )   定制 程序 不受 IP 选项 长度 限制 ； ( 3 )   可以 较 好 地 控制 定制 程序 来源 ， 以 保证 程序 的 安全性 、 可靠性 以及 用户 对 网络 使用 的 非 随意性 . 其 缺点 是 ， 程序 加载 时间 较长 . 但 这 一 缺点 可以 通过 增加 节点 缓存 空间 加以解决 . 
 3   TH - AOSR 的 实现 
 　 　 TH - AOSR 是 在 SED - 08 路由器 操作系统 基础 上 为 THAN 实验 床 所 使用 的 路由器 设计 的 主动式 路由器 操作系统 . 它 一方面 增强 了 原 操作系统 所 支持 的 一些 功能 ， 如 安全 管理 、 网络接口 ； 另一方面 增加 了 一个 全新 的 主动 网 处理机 ， 以 实现 主动 网络 计算 . 图 2 是 TH - AOSR 的 结构 框架 示意图 . 
 
 图 2 　 TH - AOSR 结构图 
 3.1   微内核 
 　 　 微内核 的 基本功能 是 系统 资源管理 . 其中 的 内存 管理 、 进程 ( 线程 ) 调度 、 时钟 管理 、 文件 管理 等 功能 与 传统 的 多任务 操作系统 基本 类似 （ 事实上 ， TH - AOSR 这 几 部分 功能 的 实现 借鉴 了 LINUX 系统 的 实现 技术 ） ， 在 此 不再 赘述 . 下面 重点 介绍 它 的 数据包 缓冲区 管理 、 链路 资源管理 和 安全 管理 . 
 3.1 . 1   数据包 缓冲区 管理 
 　 　 为了 提高 路由器 的 性能 ， 加快 数据包 的 收发 速度 ， TH - AOSR 在 LINUX 系统 的 段 页 式 内存 管理 基础 上 ， 创建 了 一个 动态 自 适应 数据包 缓冲区 . 
 　 　 缓冲区 采用 链栈 方式 管理 . 系统 在 初始化 时为 每 一 类型 的 网络接口 创建 一个 数据包 缓冲区 链栈 . 每个 缓冲区 的 大小 由 网络接口 的 最大 传输 单元 ( MTU ) 决定 . 某类 缓冲区 的 数量 由 系统 的 可用内存 空间 和 这类 缓冲区 的 使用 情况 共同 决定 . 
 　 　 TH - AOSR 根据 会话 的 性质 或 服务质量 协商 结果 来 管理 会话 对 资源 的 使用 . 
 3.1 . 2   链路 带宽 管理 
 　 　 带宽 一直 是 网络通信 的 瓶颈 . 因此 ， 为了 保证 数据传输 的 质量 （ QoS ） ， 必须 对 链路 带宽 资源 的 使用 进行 控制 . 首先 ， 带宽 资源 的 使用 必须 预约 . 没有 进行 资源 预约 的 会 话 的 数据包 将 被 丢弃 , 或者 按照 “ 尽力 传输 ” 的 方式 进行 传输 . 其次 ， 进入 的 数据包 将 按照 资源 预约 时 的 协商 结果 进行 分类 、 过滤 、 整形 ， 并 被 送入 相应 接口 的 相应 队列 中 进行 传输 . 最后 ， 在 各 网络接口 上 ， 发送 函数 采用 加权 公平 队列 （ weighted   fair   queueing ） 技术 实现 对待 发送 包 的 调度 发送 . 
 3.1 . 3   安全 管理 
 　 　 TH - AOSR 提供 了 本地 认证 、 远程 认证 等 安全 机制 ， 以 防止 用户 对系统 重要 信息 、 资源 等 进行 非法 访问 、 占用 、 修改 ， 甚至 破坏 . 
 　 　 本地 认证 将 用户 输入 的 帐号 和 口令 与 本地 路由器 中 的 数据库 中 的 值作 比较 . 如果 一致 ， 则 认证 通过 ， 并 授权 用户 的 操作 范围 . 如果 不 一致 ， 则 拒绝 登录 . 
 　 　 远程 认证 将 用户 输入 的 帐号 和 口令 经 路由器 转发给 安全 认证 服务器 ， 由 认证 服务器进行 确认 ， 并 给出 授权 的 操作 范围 . TH - AOSR 的 远程 认证 实现 了 用户 拨入 服务 远程 认证 协议 ( RADIUS ) . 
 3.2   主动 网 处理机 
 　 　 主动 网 处理机 根据 主动 网络 计算 的 需要 ， 一方面 提供 了 一组 与 主动 网络 计算 相关 的 功能 函数 ， 如 数据包 操作 函数 、 节点 环境 访问 函数 、 数据包 控制 函数 等 ， 用于 用户 或 应用 定制 程序运行 时 调用 ； 另一方面 实现 了 定制 程序 的 安全 加载 和 调度 运行机制 . 
 3.2 . 1   定制 程序运行 调度机 
 　 　 传统 路由器 的 主要 任务 是 转发 数据包 . 因此 ， 对 CPU 这一 运算 资源 的 管理 较为 松散 （ 简单 的 进程 调度 ） . 而 主动式 路由器 的 任务 除了 转发 数据包 外 ， 还要 运行 定制 程序 . 由于 定制 程序 的 安全性 、 可靠性 难以 保证 . 因此 ， 为了 防止 某些 定制 程序 大量 且 无谓 地 耗费 CPU 的 运算 资源 ， 必须 对 定制 程序 的 运行 进行 严格 的 管理 和 控制 . 
 　 　 TH - AOSR 在 SED - 08 操作系统 的 进程 （ 线程 ） 调度 （ 该 调度 机制 和 普通 操作系统 类似 ） 的 基础 上 实现 了 一种 定制 程序运行 管理 调度机 （ 以下 简称 调度机 ） . 调度机 是 一个 核心 进程 （ 线程 ） . 它 的 运行 服从 系统 的 进程 （ 线程 ） 调度 策略 . 每个 定制 程序 作为 一个 独立 运行 单位 ， 由 调度机 调度 运行 . 运行 参数 主要 有 ： 时间 片 、 优先级 、 责任者 （ 即 定制 程序 所属 的 用户 或 应用 ） 、 生存期 （ time - to - live ) 等 . 定制 程序 生存期 的 长短 一般 由 指定 程序 的 源 、 功能 特性 、 责任者 等 几 方面 决定 . 调度机 按照 定制 程序运行 调度 策略 来 管理 和 调度 它们 的 运行 . 若有 必要 ， 如 在 调度机 认为 定制 程序 存在 问题 的 情况 下 ， 调度机 可以 取消 它 的 运行 . 调度 策略 可 由 管理员 根据 需要 进行 调整 . 
 3.2 . 2   代码 检查 
 　 　 定制 程序 不但 要 占用 系统资源 （ CPU 、 内存 ） ， 而且 可能 会 引起 系统 崩溃 . 因此 ， 为了 保证 定制 程序 的 安全性 ， TH - AOSR 在 定制 程序 的 加载 过程 中 采取 了 责任者 认证 和 代码 检查 两项 措施 . 责任者 认证 是 对 会 话 的 认证 . 当 处理机 接收 到 主动 包时 ， 首先 分析 数据包 的 责任者 是否 有权 运行 相应 的 定制 程序 . 如果 有权 ， 则 检查 定制 程序 是否 在 本地 . 如果 在 本地 ， 则 加载 运行 . 如果 不 在 本地 ， 则 进行 远程 加载 . 加载 时 ， 要 进行 代码 检查 . 如果 无权 运行 ， 则 按照 系统配置 情况 ， 或者 丢弃 ， 或者 转发 . 
 　 　 代码 检查 用于 检查 定制 程序 的 安全性 . 定制 程序 需要 在 一个 封闭 的 “ 沙盒 ” ( sandbox ） 内 运行 . 因此 ， 代码 检查 要 检查 以下 几项 内容 ： ( 1 )   代码 是否 在 运行 时 修改 了 自身 ； ( 2 )   代码 中 的 转移 指令 是否 已 转向 非法 区域 ； ( 3 )   代码 是否 存取 了 非法 区域 . 
 3.3   开放 网络接口 
 　 　 开放 网络接口 是 连接 低层 物理 网络接口 驱动程序 和 高层 协议 栈 （ 包括 主动 包 处理机 ） 的 桥梁 . 它 屏蔽 了 不同 物理 网络接口 的 差异 ， 为 高层 提供 了 一致 的 链路 服务 . 一方面 ， 它 主动 识别 接收数据 帧 的 高层 协议 ， 实现 对 多 协议 栈 的 支持 ； 另一方面 ， 它 将 各 协议 栈要 发送 的 数据包 进行 适当 封装 ， 送到 相应 接口 上 进行 发送 . 
 接收 报文 的 处理过程 ， 可 简述 如下 ： 
 　 　 ( 1 )   当 接收 到 物理 网络接口 驱动程序 上 传送 的 数据 帧 时 ， 根据 帧 的 类型 ， 分析 出 它 的 上层 协议 . 
 　 　 ( 2 )   如果 上层 协议 是 IPX ， 则 将 IPX 数据包 抽取 ， 上 传到 SPX / IPX 协议 栈 . 
 　 　 ( 3 )   如果 上层 协议 是 IP ， 则 进一步 分析 其 IP 选项 域 是否 有 主动 选项 . 如果 有 ， 则 上 传到 主动 包 处理机 ， 否则 ， 上 传到 TCP / IP 协议 栈 . 
 　 　 ( 4 )   如果 上层 协议 既 不是 IPX 也 不是 IP ， 则 将 数据 帧 丢弃 . 
 发送 报文 处理过程 较 简单 ， 这里 不再 加以 介绍 . 
 4   结束语 
 　 　 主动式 网络 是 当前 网络界 的 一个 新 的 世界性 研究课题 . 它 的 研究 刚 起步 不久 ， 许多 问题 还有 待 解决 ， 如包 携带 程序 的 安全性 问题 、 主动 网 效率 问题 . TH - AOSR 是 我们 在 当前 研究成果 的 基础 上 实现 的 一个 初步 的 主动式 路由器 操作系统 ， 还 存在 许多 不足 . 我们 正在 以下 几个 方面 对 其 进行 改进 ： ( 1 )   增加 Java 支持 环境 ， 使 指定 程序 可以 用 Java 语言 编写 ； ( 2 )   增加 对 目录 服务 的 支持 ， 提高 对 网络资源 的 控制能力 ； ( 3 )   将 组件 技术 引入 主动式 网络 ， 提供 程序 的 重用 性 ； ( 4 )   实现 更为 严格 的 安全控制 、 管理机制 ， 如 定制 程序 数字签名 . 
 * 　 本文 研究 得到 国家自然科学基金 和 国家 863 高科技 项目 基金 资助 . 
 作者简介 　 马洪军 , 1966 年生 , 工程师 ， 主要 研究 领域 为 主动 网 ， 操作系统 . 
 　 　 　 　 　 张尧学 , 1956 年生 , 博士后 ， 教授 ， 博士生 导师 , 主要 研究 领域 为 网络 互连 ， QoS ， 操作系统 . 
 　 　 　 　 　 陈桦 , 1972 年生 , 博士生 , 主要 研究 领域 为 计算机网络 ， QoS ， 多媒体通信 . 
 本文 通讯联系 人 : 马洪军 ， 北京 100084 , 清华大学 计算机科学 与 技术 系 
 作者 单位 ： 清华大学 计算机科学 与 技术 系 　 北京 　 100084 
 E - mail :   { mhj , zyx , chua } @ sun475 . cs . tsinghua . edu . cn 
 参考文献 
 　 1 　 张尧学 ， 赵艳标 ， 盖峰 . SED - 08 路由器 . 高技术 通讯 ， 1997 ， 7 ( 10 ) ： 32 ～ 34 
 ( Zhang   Yao - xue ,   Zhao   Yan - biao ,   Gai   Feng .   A   study   on   the   router   SED - 08 .   High - Tech   Letters ,   1997 , 7 ( 10 ) : 32 ～ 34 ) 
 　 2 　 Tennenhouse   D ,   Smith   J ,   Sincoskie   W   et   al .   A   survey   of   active   network   research .   IEEE   Communications ,   1997 , 35 ( 1 ) : 80 ～ 86 
 　 3 　 Wetherall   D ,   Tennenhouse   D .   The   active   IP   option .   In :   Proceedings   of   the   7th   ACM   SIGOPS   Europe .   Workshop ,   Connemara ,   Ireland ,   1996 
 　 4 　 Alexander   D ,   Arbaugh   W   et   al .   The   switch   ware   active   network   architecture .   IEEE   Network   ( Special   Issue   on   Active   and   Controllable   Networks ) ,   1998 , 12 ( 3 ) : 29 ～ 36 
 本文 1998 - 08 - 20 收到 原稿 , 1999 - 01 - 15 收到 修改稿 
